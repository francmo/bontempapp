<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéµ</text></svg>">
    <title>BontempApp v3.1 - ENHANCED EDITION</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-functions-compat.js"></script>

    <!-- ‚ö†Ô∏è Configurazione API Keys (NON committare config.js su GitHub!) -->
    <script src="config.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-user-select: none; user-select: none; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 5px;
            overflow: hidden;
        }
        .container { 
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
            max-width: 1000px;
            width: 100%;
            height: 98vh;
            overflow-y: auto;
            padding: 10px;
            position: relative;
        }
        
        /* HOME BUTTON - Compatto e posizionato in alto a destra */
        .home-button {
            position: fixed;
            top: 15px;
            right: 15px;
            background: rgba(220, 53, 69, 0.95);
            color: white;
            border: none;
            padding: 10px 14px;
            border-radius: 50%;
            font-size: 1.3em;
            font-weight: 700;
            cursor: pointer;
            z-index: 10001;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.4);
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .home-button:hover {
            background: rgba(220, 53, 69, 1);
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        
        h1 { color: #667eea; text-align: center; margin-bottom: 5px; font-size: 1.5em; }
        .subtitle { text-align: center; color: #666; margin-bottom: 8px; font-size: 0.75em; }

        /* Welcome Hero Grid - Responsive Layout */
        .welcome-hero-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        /* Desktop: 2 colonne (60% sinistra, 40% destra) */
        @media (min-width: 769px) {
            .welcome-hero-grid {
                grid-template-columns: 1.5fr 1fr;
                gap: 30px;
            }
        }

        .welcome-hero-left {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .welcome-hero-right {
            display: flex;
            align-items: flex-start;
        }

        /* CTA Primary Button - Grande e visibile */
        .btn-cta-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 18px 30px;
            font-size: 1.2em;
            font-weight: 700;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
            width: 100%;
        }
        .btn-cta-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.6);
        }

        /* Featured Challenge Card - Nel flusso del layout */
        .featured-challenge-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            width: 100%;
        }
        .featured-challenge-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(102, 126, 234, 0.35);
            border-color: #667eea;
        }
        .featured-challenge-header {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            padding: 12px 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .featured-challenge-title {
            font-size: 0.9em;
            font-weight: 700;
            color: #333;
            margin: 0;
            text-align: center;
        }
        .featured-challenge-image {
            width: 100%;
            height: 200px;
            object-fit: contain;
            display: block;
            background: #f8f9fa;
        }
        .featured-challenge-content {
            padding: 15px;
        }
        .featured-challenge-name {
            font-size: 0.9em;
            font-weight: 600;
            color: #667eea;
            margin: 0 0 8px 0;
        }
        .featured-challenge-comment {
            font-size: 0.85em;
            color: #666;
            line-height: 1.5;
            margin: 0;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            font-style: italic;
        }
        .featured-challenge-cta {
            font-size: 0.8em;
            color: #667eea;
            font-weight: 600;
            margin-top: 10px;
            text-align: center;
        }

        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .input-group { margin-bottom: 10px; }
        label { display: block; margin-bottom: 4px; color: #333; font-weight: 600; font-size: 0.8em; }
        input[type="text"], input[type="number"], input[type="file"], select, textarea {
            width: 100%;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 0.85em;
        }
        textarea { min-height: 80px; resize: vertical; font-family: inherit; }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 5px;
            transition: all 0.3s ease;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .back-button { background: #868e96; margin-bottom: 8px; padding: 6px 12px; font-size: 0.75em; width: auto; }
        
        .mode-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 10px;
        }
        .mode-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 12px 8px;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
        }
        .mode-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
            border-color: #667eea;
        }
        .difficulty-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .mode-icon { font-size: 1.8em; margin-bottom: 4px; }
        .mode-title { font-size: 0.8em; font-weight: bold; color: #333; }
        .mode-desc { font-size: 0.65em; color: #666; margin-top: 2px; }
        .api-required {
            position: absolute;
            top: 3px;
            right: 3px;
            background: #ff6b6b;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.6em;
            font-weight: bold;
        }
        
        .canvas-container {
            position: relative;
            margin: 8px auto;
            border-radius: 12px;
            overflow: visible;
        }
        #drawingCanvas, #canvas3d {
            border: 2px solid #667eea;
            border-radius: 12px;
            cursor: crosshair;
            touch-action: none;
            background: white;
            display: block;
            width: 100%;
            height: auto;
            max-height: 250px;
        }
        #canvas3d { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); }
        
        .guide-ball {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 5;
            box-shadow: 0 0 15px rgba(255,255,255,0.6);
            border: 2px solid white;
            transition: transform 0.1s ease;
        }
        .guide-ball-0 { background: #667eea; }
        .guide-ball-1 { background: #f5576c; }
        .guide-ball-2 { background: #51cf66; }
        
        .overlay-data {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }
        .data-item {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 6px;
            padding: 4px 8px;
            border: 2px solid;
            flex: 1;
        }
        .data-item.finger-0 { border-color: #667eea; }
        .data-item.finger-1 { border-color: #f5576c; }
        .data-item.finger-2 { border-color: #51cf66; }
        .data-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 3px;
        }
        .data-label {
            font-size: 0.65em;
            font-weight: 600;
            color: white;
            display: flex;
            align-items: center;
            gap: 3px;
        }
        .data-dot { width: 6px; height: 6px; border-radius: 50%; }
        .finger-0 .data-dot { background: #667eea; }
        .finger-1 .data-dot { background: #f5576c; }
        .finger-2 .data-dot { background: #51cf66; }
        .data-values { display: flex; gap: 5px; font-size: 0.6em; color: rgba(255, 255, 255, 0.8); }
        .data-val { font-weight: 500; font-family: 'Courier New', monospace; color: white; }
        .data-val.active { color: #4ade80; }
        .data-val.inactive { opacity: 0.4; }
        
        .acoustic-panel {
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            padding: 8px;
            color: white;
            font-size: 0.7em;
            line-height: 1.4;
            margin-top: 5px;
        }
        .acoustic-panel h4 { color: #ffd700; margin-bottom: 3px; font-size: 0.85em; }
        
        .compact-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            background: #f8f9fa;
            padding: 6px;
            border-radius: 8px;
            margin-bottom: 5px;
        }
        .control-group { display: flex; align-items: center; gap: 5px; }
        .compact-controls button {
            width: auto;
            padding: 4px 10px;
            font-size: 0.75em;
            margin: 0;
        }
        
        .speed-control { display: flex; align-items: center; gap: 4px; }
        .speed-control label { font-size: 0.75em; margin: 0; color: #667eea; font-weight: 600; }
        .speed-control input[type="range"] { width: 70px; }
        
        .info-box {
            background: rgba(102, 126, 234, 0.1);
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 8px 10px;
            margin-bottom: 8px;
            font-size: 0.75em;
            color: #333;
            line-height: 1.4;
        }
        
        .recording-controls {
            display: flex;
            gap: 8px;
            margin-top: 5px;
        }
        .record-btn {
            background: #dc3545;
            flex: 1;
            margin: 0;
        }
        .record-btn.recording {
            background: #28a745;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .record-indicator {
            position: fixed;
            top: 15px;
            right: 15px;
            background: #dc3545;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.8em;
            z-index: 10000;
            animation: pulse 1.5s infinite;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.5);
        }
        
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            padding: 15px;
            overflow-y: auto;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 15px;
            max-width: 600px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
        }
        .modal h2 { color: #667eea; margin-bottom: 15px; font-size: 1.3rem; text-align: center; }

        .modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        .modal-close:hover {
            background: rgba(220, 53, 69, 1);
            transform: scale(1.1);
        }
        
        .demo-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }
        .demo-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 10px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        .demo-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.15);
            border-color: #667eea;
        }
        .demo-card.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: #667eea;
        }
        .demo-icon { font-size: 1.5em; margin-bottom: 5px; }
        .demo-name { font-weight: 600; margin-bottom: 3px; font-size: 0.85em; }
        .demo-desc { font-size: 0.7em; opacity: 0.8; }
        .demo-category {
            background: rgba(102, 126, 234, 0.1);
            padding: 5px 10px;
            border-radius: 6px;
            margin: 12px 0 8px 0;
            font-weight: bold;
            font-size: 0.85em;
            color: #667eea;
            border-left: 3px solid #667eea;
        }
        
        .demo-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 215, 0, 0.95);
            color: #333;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: bold;
            z-index: 100000;
            pointer-events: none;
            box-shadow: 0 8px 30px rgba(0,0,0,0.4);
            animation: fade-in-out 2.5s ease-out forwards;
        }
        @keyframes fade-in-out {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            15% { opacity: 1; transform: translate(-50%, -50%) scale(1.05); }
            85% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
        }
        
        @keyframes feedbackPop {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
        @keyframes feedbackFadeOut {
            0% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
        }
        
        .challenge-box {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            font-size: 1em;
            font-weight: 600;
            color: #333;
            line-height: 1.6;
            margin-bottom: 10px;
        }
        
        .photo-upload-area {
            border: 2px dashed #667eea;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 8px;
        }
        .photo-upload-area:hover { background: #e9ecef; border-color: #764ba2; }
        .photo-upload-area.has-image { border-style: solid; border-color: #51cf66; }
        .preview-image { max-width: 100%; max-height: 250px; border-radius: 8px; margin: 10px 0; }
        
        .score-display {
            background: #51cf66;
            color: white;
            padding: 8px;
            border-radius: 8px;
            text-align: center;
            font-size: 0.9em;
            margin-bottom: 8px;
        }
        
        .question {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .question h3 { font-size: 1em; margin-bottom: 8px; }
        .question p { font-size: 0.9em; }
        
        .quiz-timer {
            background: linear-gradient(135deg, #ffd700, #ffa500);
            color: #333;
            padding: 8px 15px;
            border-radius: 8px;
            text-align: center;
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 10px;
            box-shadow: 0 4px 10px rgba(255, 215, 0, 0.3);
        }
        
        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }
        .quiz-option {
            display: flex;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85em;
        }
        .quiz-option:hover { background: #e9ecef; border-color: #667eea; }
        .quiz-option input[type="radio"] { margin-right: 8px; cursor: pointer; }
        
        .difficulty-selector { display: flex; gap: 10px; margin: 15px 0; }
        .difficulty-btn {
            flex: 1;
            padding: 15px;
            background: #f8f9fa;
            border: 2px solid #ddd;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85em;
        }
        .difficulty-btn:hover { border-color: #667eea; background: #e9ecef; }
        .difficulty-btn.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .feedback-box {
            background: #e7f5ff;
            border: 2px solid #339af0;
            padding: 15px;
            border-radius: 12px;
            margin: 15px 0;
            line-height: 1.5;
            font-size: 0.9em;
        }
        .feedback-box.success { background: #d3f9d8; border-color: #51cf66; }
        .feedback-box.error { background: #ffe0e0; border-color: #ff6b6b; }
        
        .curiosita-box {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            padding: 20px;
            border-radius: 12px;
            font-size: 0.95em;
            line-height: 1.6;
            color: #333;
            margin: 15px 0;
        }
        .curiosita-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
            text-align: center;
        }
        
        @media (max-width: 768px) {
            .container { padding: 8px; }
            h1 { font-size: 1.3em; }
            .mode-selector { grid-template-columns: repeat(2, 1fr); }
            .demo-grid { grid-template-columns: 1fr; }
        }

        .victory-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            animation: victoryFadeIn 0.5s ease-in-out;
        }

        @keyframes victoryFadeIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        .victory-stars {
            font-size: 8em;
            animation: victoryBounce 1s ease-in-out infinite;
        }

        @keyframes victoryBounce {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-20px) scale(1.1); }
        }

        .victory-text {
            font-size: 3em;
            color: white;
            font-weight: bold;
            text-align: center;
            margin-top: 20px;
            text-shadow: 0 4px 10px rgba(0,0,0,0.3);
            animation: victoryPulse 1.5s ease-in-out infinite;
        }

        @keyframes victoryPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .victory-score {
            font-size: 5em;
            color: #ffd700;
            font-weight: bold;
            margin-top: 20px;
            text-shadow: 0 6px 15px rgba(0,0,0,0.4);
        }

        /* SALA DELLA FAMA - Modale Conferma Pubblicazione */
        .publish-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease-out;
        }
        .publish-modal.active {
            display: flex;
        }
        .publish-modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            animation: slideUp 0.4s ease-out;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .publish-modal-title {
            font-size: 1.8em;
            color: #667eea;
            margin-bottom: 15px;
            text-align: center;
        }
        .publish-modal-text {
            font-size: 0.95em;
            color: #333;
            line-height: 1.6;
            margin-bottom: 25px;
            text-align: center;
            max-height: 40vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .publish-modal-buttons {
            display: flex;
            gap: 10px;
        }
        .publish-modal-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .publish-btn-yes {
            background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%);
            color: white;
        }
        .publish-btn-yes:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(55, 178, 77, 0.4);
        }
        .publish-btn-no {
            background: #868e96;
            color: white;
        }
        .publish-btn-no:hover {
            background: #6c757d;
            transform: translateY(-2px);
        }
        .publish-btn-yes:disabled {
            background: #dee2e6;
            color: #adb5bd;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .publish-btn-yes:disabled:hover {
            transform: none;
            box-shadow: none;
        }

        /* ToS Warning */
        .tos-warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffe8a1 100%);
            border-left: 4px solid #dc3545;
            padding: 12px 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 0.85em;
            line-height: 1.5;
        }
        .tos-warning strong {
            color: #721c24;
            display: block;
            margin-bottom: 5px;
            font-size: 1em;
        }
        .tos-warning p {
            margin: 0;
            color: #856404;
        }

        /* ToS Checkbox */
        .tos-checkbox-label {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin: 15px 0 20px 0;
            cursor: pointer;
            font-size: 0.85em;
            line-height: 1.5;
            color: #495057;
            text-align: left;
        }
        .tos-checkbox {
            margin-top: 2px;
            width: 18px;
            height: 18px;
            cursor: pointer;
            flex-shrink: 0;
        }
        .tos-checkbox-label:hover {
            color: #212529;
        }

        /* SALA DELLA FAMA - Griglia Pubblicazioni */
        .hall-of-fame-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            padding: 20px 0;
        }
        .fame-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        .fame-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        .fame-card-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }
        .fame-card-content {
            padding: 15px;
        }
        .fame-card-challenge {
            font-size: 0.9em;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 10px;
        }
        .fame-card-comment {
            font-size: 0.85em;
            color: #495057;
            line-height: 1.5;
            margin-bottom: 10px;
        }
        .fame-card-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75em;
            color: #868e96;
        }
        .fame-card-user {
            font-weight: 600;
        }
        .fame-card-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }
        .fame-card-btn {
            flex: 1;
            background: white;
            border: 2px solid #dee2e6;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        .fame-card-btn-flag {
            color: #dc3545;
            border-color: #dc3545;
        }
        .fame-card-btn-flag:hover {
            background: #dc3545;
            color: white;
            transform: translateY(-2px);
        }
        .fame-card-btn-flag.flagged {
            background: #dc3545;
            color: white;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .fame-card-btn-delete {
            color: #dc3545;
            border-color: #dc3545;
        }
        .fame-card-btn-delete:hover {
            background: #dc3545;
            color: white;
            transform: translateY(-2px);
        }

        /* Sistema Likes */
        .fame-card-btn-like {
            color: #e91e63;
            border-color: #e91e63;
        }
        .fame-card-btn-like:hover {
            background: #fce4ec;
            transform: translateY(-2px);
        }
        .fame-card-btn-like.liked {
            background: #e91e63;
            color: white;
            border-color: #e91e63;
        }
        .fame-card-btn-like.liked:hover {
            background: #c2185b;
            transform: scale(1.05);
        }
        .fame-card-likes-count {
            font-weight: 700;
            margin-left: 3px;
        }

        /* Sistema Commenti */
        .comments-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        .comments-title {
            font-size: 0.9em;
            font-weight: 600;
            color: #495057;
            margin-bottom: 10px;
        }
        .comments-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        .comment-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 8px;
            font-size: 0.85em;
        }
        .comment-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
        }
        .comment-user-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            object-fit: cover;
        }
        .comment-user-name {
            font-weight: 600;
            color: #495057;
            font-size: 0.9em;
        }
        .comment-timestamp {
            font-size: 0.75em;
            color: #868e96;
            margin-left: auto;
        }
        .comment-body {
            color: #495057;
            line-height: 1.4;
            margin-left: 32px;
        }
        .comment-form {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            margin-top: 10px;
            padding: 10px 0;
        }
        .comment-input {
            flex: 1;
            min-width: 150px;
            min-height: 40px;
            padding: 10px 15px;
            border: 2px solid #667eea;
            border-radius: 20px;
            font-size: 0.9em;
            font-family: 'Poppins', sans-serif;
            transition: all 0.2s ease;
            background: white;
            color: #333;
            box-sizing: border-box;
        }
        .comment-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .comment-submit {
            flex-shrink: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        .comment-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .comment-submit:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .comments-login-prompt {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            font-size: 0.85em;
            color: #495057;
        }
        .comments-login-link {
            color: #667eea;
            font-weight: 600;
            cursor: pointer;
            text-decoration: underline;
        }
        .comments-login-link:hover {
            color: #764ba2;
        }
        .comments-empty {
            text-align: center;
            padding: 20px;
            color: #868e96;
            font-size: 0.85em;
            font-style: italic;
        }
        .comment-open-btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 10px;
        }
        .comment-open-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .comment-cancel {
            flex-shrink: 0;
            background: #868e96;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        .comment-cancel:hover {
            background: #6c757d;
        }
        .comment-delete-btn {
            background: transparent;
            border: none;
            color: #dc3545;
            font-size: 1em;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
            margin-left: auto;
        }
        .comment-delete-btn:hover {
            background: #dc3545;
            color: white;
            transform: scale(1.1);
        }

        .fame-empty {
            text-align: center;
            padding: 60px 20px;
            color: #868e96;
        }
        .fame-empty-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        /* AUTENTICAZIONE - Badge e UI */
        .auth-badge {
            position: fixed;
            top: 15px;
            left: 15px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 10px 15px;
            border-radius: 25px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 10000;
            font-size: 0.85em;
            transition: all 0.3s ease;
        }
        .auth-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .auth-badge-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #667eea;
        }
        .auth-badge-name {
            font-weight: 600;
            color: #333;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .auth-badge-logout {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.2s;
        }
        .auth-badge-logout:hover {
            background: #c82333;
        }

        /* LOGIN MODAL */
        .login-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            z-index: 10001;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease-out;
        }
        .login-modal.active {
            display: flex;
        }
        .login-modal-content {
            background: white;
            border-radius: 25px;
            padding: 40px;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            text-align: center;
            animation: slideUp 0.4s ease-out;
        }
        .login-modal-title {
            font-size: 2em;
            color: #667eea;
            margin-bottom: 10px;
        }
        .login-modal-subtitle {
            font-size: 0.95em;
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        .login-btn {
            background: white;
            border: 2px solid #ddd;
            padding: 15px 25px;
            border-radius: 50px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }
        .login-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            border-color: #667eea;
        }
        .login-btn-google {
            background: #4285f4;
            color: white;
            border-color: #4285f4;
        }
        .login-btn-google:hover {
            background: #357ae8;
            border-color: #357ae8;
        }
        .login-btn-anonymous {
            background: #868e96;
            color: white;
            border-color: #868e96;
        }
        .login-btn-anonymous:hover {
            background: #6c757d;
            border-color: #6c757d;
        }
        .login-modal-footer {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            font-size: 0.8em;
            color: #999;
        }
        .login-required-notice {
            background: linear-gradient(135deg, #fff3cd 0%, #ffe8a1 100%);
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-size: 0.9em;
            color: #856404;
            text-align: left;
        }
        .login-required-notice strong {
            display: block;
            margin-bottom: 5px;
            font-size: 1.1em;
        }
    </style>
</head>
<body>
<div class="container">
    <div id="welcomeScreen" class="screen active">
        <h1>üéµ BontempApp v3.1</h1>
        <p class="subtitle">Bontempapp √® un Parco Giochi Creativo-Musicale</p>

        <!-- Layout Hero Responsive -->
        <div class="welcome-hero-grid">
            <!-- Colonna Sinistra: CTA Principale -->
            <div class="welcome-hero-left">
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">
                    <h3 style="color: white; margin: 0 0 10px 0; font-size: 1em;">‚ú® Esplora la Musica</h3>
                    <p style="color: rgba(255,255,255,0.95); font-size: 0.85em; line-height: 1.5; margin: 0;">
                        Disegno audio, quiz, sfide creative e AI. Divertimento musicale interattivo!
                    </p>
                </div>

                <div class="input-group">
                    <label for="userName">üë§ Il tuo nome:</label>
                    <input type="text" id="userName" placeholder="Inserisci il tuo nome..." value="Studente" />
                </div>

                <button onclick="iniziaGioco()" class="btn-cta-primary">üöÄ Inizia l'Avventura!</button>
            </div>

            <!-- Colonna Destra: Card Sfida in Evidenza (Desktop) -->
            <div class="welcome-hero-right">
                <div id="featuredChallengeCard" class="featured-challenge-card" style="display: none;" onclick="showHallOfFame()">
                    <div class="featured-challenge-header">
                        <span class="featured-challenge-title">üåü L'Audace della Settimana</span>
                    </div>
                    <img id="featuredChallengeImage" class="featured-challenge-image" src="" alt="Sfida in evidenza">
                    <div class="featured-challenge-content">
                        <p id="featuredChallengeName" class="featured-challenge-name"></p>
                        <p id="featuredChallengeComment" class="featured-challenge-comment"></p>
                        <div class="featured-challenge-cta">üëâ Vedi la Sala della Fama ‚Üí</div>
                    </div>
                </div>
            </div>
        </div>

        <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button onclick="showAbout()" style="background: #17a2b8; flex: 1;">‚ÑπÔ∏è About</button>
            <button onclick="showGuida()" style="background: #28a745; flex: 1;">üìñ Guida Completa</button>
        </div>

        <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px; border-top: 3px solid #667eea;">
            <div style="margin-bottom: 15px;">
                <p style="font-size: 0.85em; font-weight: 600; color: #495057; margin-bottom: 10px;">üì± Condividi l'app:</p>
                <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 10px;">
                    <button onclick="condividiWhatsApp()" style="background: #25D366; padding: 8px 15px; font-size: 0.8em; width: auto;">
                        üì± WhatsApp
                    </button>
                    <button onclick="condividiFacebook()" style="background: #1877F2; padding: 8px 15px; font-size: 0.8em; width: auto;">
                        üìò Facebook
                    </button>
                </div>
            </div>

            <div style="margin-bottom: 15px; padding: 10px; background: #e7f3ff; border-radius: 5px;">
                <p style="font-size: 0.85em; font-weight: 600; color: #004085; margin-bottom: 8px;">üí¨ Lascia il tuo feedback</p>
                <button onclick="inviaFeedback()"
                        style="background: #667eea; padding: 8px 20px; font-size: 0.8em; width: auto;">
                    ‚úâÔ∏è Invia Commento
                </button>
            </div>

            <div style="margin-bottom: 15px; padding: 10px; background: #fff3cd; border-radius: 5px;">
                <p style="font-size: 0.85em; font-weight: 600; color: #856404; margin-bottom: 8px;">üíù Sostieni il progetto</p>
                <button onclick="window.open('https://www.paypal.com/paypalme/francescomariano', '_blank')"
                        style="background: #0070ba; padding: 8px 20px; font-size: 0.8em; width: auto;">
                    üí≥ Dona con PayPal
                </button>
            </div>

            <div style="text-align: center; font-size: 0.75em; color: #6c757d; line-height: 1.6;">
                <p style="margin: 5px 0;">‚ú® Ideato e sviluppato da <strong>Creative Studio Lab</strong> di <strong>Francesco Mariano</strong></p>
                <p style="margin: 5px 0;">P.IVA 01489840452</p>
                <p style="margin: 5px 0; color: #999;">v3.1 ENHANCED EDITION</p>
            </div>
        </div>
    </div>

    <div id="modeScreen" class="screen">
        <button class="home-button" onclick="backToWelcome()" title="Torna alla home">‚Üê</button>

        <h2 style="text-align: center; color: #667eea; margin-bottom: 10px; font-size: 1.2em;">
            Ciao <span id="playerName"></span>! Scegli la modalit√†:
        </h2>

        <div class="mode-selector">
            <div class="mode-card" onclick="selectMode('2d')">
                <div class="mode-icon">üé®</div>
                <div class="mode-title">2D Libero</div>
                <div class="mode-desc">Disegno audio libero</div>
            </div>
            <div class="mode-card" onclick="selectMode('2d-guided')">
                <div class="mode-icon">üéØ</div>
                <div class="mode-title">2D Guidato</div>
                <div class="mode-desc">10 preset + demo</div>
            </div>
            <div class="mode-card" onclick="selectMode('3d')">
                <div class="mode-icon">üåç</div>
                <div class="mode-title">3D Libero</div>
                <div class="mode-desc">Disegno 3D spaziale</div>
            </div>
            <div class="mode-card" onclick="selectMode('3d-guided')">
                <div class="mode-icon">‚ú®</div>
                <div class="mode-title">3D Guidato</div>
                <div class="mode-desc">10 preset 3D + demo</div>
            </div>
            
            <div class="mode-card" onclick="selectMode('quiz-novecento')">
                <div class="mode-icon">üéº</div>
                <div class="mode-title">Quiz '900</div>
                <div class="mode-desc">Musica colta - 3 livelli</div>
            </div>
            <div class="mode-card" onclick="selectMode('quiz-jazz')">
                <div class="mode-icon">üé∑</div>
                <div class="mode-title">Quiz Jazz</div>
                <div class="mode-desc">Armonia Jazz - 3 livelli</div>
            </div>
            <div class="mode-card" onclick="selectMode('quiz-classica')">
                <div class="mode-icon">üéª</div>
                <div class="mode-title">Quiz Classica</div>
                <div class="mode-desc">Armonia - 3 livelli</div>
            </div>
            
            <div class="mode-card" onclick="selectMode('challenge')">
                <div class="mode-icon">üì∏</div>
                <div class="mode-title">Photo Challenge</div>
                <div class="mode-desc">200 sfide creative!</div>
            </div>

            <div class="mode-card" onclick="selectMode('curiosita')">
                <div class="mode-icon">üß†</div>
                <div class="mode-title">Curiosit√†</div>
                <div class="mode-desc">Scopri curiosit√†</div>
            </div>

            <div class="mode-card" onclick="showProfile()" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                <div class="mode-icon">üìä</div>
                <div class="mode-title">Il Mio Profilo</div>
                <div class="mode-desc">Statistiche e achievements</div>
            </div>

            <div class="mode-card" onclick="showHallOfFame()" style="background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);">
                <div class="mode-icon">üèÜ</div>
                <div class="mode-title">Sala della Fama</div>
                <div class="mode-desc">Le migliori sfide degli Audaci!</div>
            </div>
        </div>

        <!-- Footer -->
        <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px; border-top: 3px solid #667eea;">
            <div style="margin-bottom: 15px;">
                <p style="font-size: 0.85em; font-weight: 600; color: #495057; margin-bottom: 10px;">üì± Condividi l'app:</p>
                <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 10px;">
                    <button onclick="condividiWhatsApp()" style="background: #25D366; padding: 8px 15px; font-size: 0.8em; width: auto;">
                        üì± WhatsApp
                    </button>
                    <button onclick="condividiFacebook()" style="background: #1877F2; padding: 8px 15px; font-size: 0.8em; width: auto;">
                        üìò Facebook
                    </button>
                </div>
            </div>

            <div style="margin-bottom: 15px; padding: 10px; background: #e7f3ff; border-radius: 5px;">
                <p style="font-size: 0.85em; font-weight: 600; color: #004085; margin-bottom: 8px;">üí¨ Lascia il tuo feedback</p>
                <button onclick="inviaFeedback()"
                        style="background: #667eea; padding: 8px 20px; font-size: 0.8em; width: auto;">
                    ‚úâÔ∏è Invia Commento
                </button>
            </div>

            <div style="margin-bottom: 15px; padding: 10px; background: #fff3cd; border-radius: 5px;">
                <p style="font-size: 0.85em; font-weight: 600; color: #856404; margin-bottom: 8px;">üíù Sostieni il progetto</p>
                <button onclick="window.open('https://www.paypal.com/paypalme/francescomariano', '_blank')"
                        style="background: #0070ba; padding: 8px 20px; font-size: 0.8em; width: auto;">
                    üí≥ Dona con PayPal
                </button>
            </div>

            <div style="text-align: center; font-size: 0.75em; color: #6c757d; line-height: 1.6;">
                <p style="margin: 5px 0;">‚ú® Ideato e sviluppato da <strong>Creative Studio Lab</strong> di <strong>Francesco Mariano</strong></p>
                <p style="margin: 5px 0;">P.IVA 01489840452</p>
                <p style="margin: 5px 0; color: #999;">v3.1 ENHANCED EDITION</p>
            </div>
        </div>
    </div>

    <div id="gameScreen" class="screen">
        <button class="home-button" onclick="backToModes()" title="Torna alle modalit√†">üè†</button>

        <div id="scoreContainer" class="score-display" style="display:none;">
            Punteggio: <span id="scoreValue">0</span> | Round: <span id="roundValue">1</span>/<span id="maxRounds">5</span>
        </div>

        <div id="gameArea"></div>

        <!-- Footer -->
        <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px; border-top: 3px solid #667eea;">
            <div style="margin-bottom: 15px;">
                <p style="font-size: 0.85em; font-weight: 600; color: #495057; margin-bottom: 10px;">üì± Condividi l'app:</p>
                <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 10px;">
                    <button onclick="condividiWhatsApp()" style="background: #25D366; padding: 8px 15px; font-size: 0.8em; width: auto;">
                        üì± WhatsApp
                    </button>
                    <button onclick="condividiFacebook()" style="background: #1877F2; padding: 8px 15px; font-size: 0.8em; width: auto;">
                        üìò Facebook
                    </button>
                </div>
            </div>

            <div style="margin-bottom: 15px; padding: 10px; background: #e7f3ff; border-radius: 5px;">
                <p style="font-size: 0.85em; font-weight: 600; color: #004085; margin-bottom: 8px;">üí¨ Lascia il tuo feedback</p>
                <button onclick="inviaFeedback()"
                        style="background: #667eea; padding: 8px 20px; font-size: 0.8em; width: auto;">
                    ‚úâÔ∏è Invia Commento
                </button>
            </div>

            <div style="margin-bottom: 15px; padding: 10px; background: #fff3cd; border-radius: 5px;">
                <p style="font-size: 0.85em; font-weight: 600; color: #856404; margin-bottom: 8px;">üíù Sostieni il progetto</p>
                <button onclick="window.open('https://www.paypal.com/paypalme/francescomariano', '_blank')"
                        style="background: #0070ba; padding: 8px 20px; font-size: 0.8em; width: auto;">
                    üí≥ Dona con PayPal
                </button>
            </div>

            <div style="text-align: center; font-size: 0.75em; color: #6c757d; line-height: 1.6;">
                <p style="margin: 5px 0;">‚ú® Ideato e sviluppato da <strong>Creative Studio Lab</strong> di <strong>Francesco Mariano</strong></p>
                <p style="margin: 5px 0;">P.IVA 01489840452</p>
                <p style="margin: 5px 0; color: #999;">v3.1 ENHANCED EDITION</p>
            </div>
        </div>
    </div>

    <!-- Profile Screen -->
    <div id="profileScreen" class="screen">
        <button class="home-button" onclick="backToMenu()" title="Torna al menu">üè†</button>
        <div id="profileArea"></div>
    </div>

    <!-- Hall of Fame Screen -->
    <div id="hallOfFameScreen" class="screen">
        <button class="home-button" onclick="backToMenu()" title="Torna al menu">üè†</button>
        <h1 style="color: #667eea; text-align: center; margin-bottom: 10px;">üèÜ Sala della Fama</h1>
        <p style="text-align: center; color: #666; font-size: 0.9em; margin-bottom: 20px;">Le migliori sfide condivise dagli Audaci di tutto il mondo!</p>
        <div id="hallOfFameArea"></div>
    </div>
</div>

<div class="modal" id="demoModal">
    <div class="modal-content">
        <button class="modal-close" onclick="closeDemoModal()">√ó</button>
        <h2>üé≠ Scegli la Demo</h2>
        
        <div class="demo-category">üé® Demo 2D - Figure Geometriche</div>
        <div class="demo-grid" id="demo2DGeometric"></div>
        
        <div class="demo-category">üòä Demo 2D - Figure Reali</div>
        <div class="demo-grid" id="demo2DReal"></div>
        
        <div class="demo-category">üåç Demo 3D - Figure Geometriche</div>
        <div class="demo-grid" id="demo3DGeometric"></div>
        
        <div class="demo-category">üè† Demo 3D - Figure Reali</div>
        <div class="demo-grid" id="demo3DReal"></div>

        <div style="margin-top: 15px; display: flex; gap: 8px;">
            <button onclick="closeDemoModal()" style="background: #868e96;">Chiudi</button>
        </div>
    </div>
</div>

<div class="modal" id="scaleModal">
    <div class="modal-content">
        <button class="modal-close" onclick="closeScaleModal()">√ó</button>
        <h2>üéµ Scegli la Scala Musicale</h2>

        <div class="demo-category">üåç Scale Occidentali</div>
        <div class="demo-grid" id="scaleWestern"></div>

        <div class="demo-category">üïå Scale Mediorientali</div>
        <div class="demo-grid" id="scaleMiddleEast"></div>

        <div class="demo-category">üáÆüá≥ Scale Indiane (Raga)</div>
        <div class="demo-grid" id="scaleIndian"></div>

        <div class="demo-category">üáØüáµ Scale Giapponesi</div>
        <div class="demo-grid" id="scaleJapanese"></div>

        <div class="demo-category">üåç Scale Africane</div>
        <div class="demo-grid" id="scaleAfrican"></div>

        <div class="demo-category">‚ú® Scale Esotiche/Moderne</div>
        <div class="demo-grid" id="scaleExotic"></div>

        <div style="margin-top: 15px; display: flex; gap: 8px; align-items: center;">
            <div style="flex: 1; padding: 8px; background: #f1f3f5; border-radius: 5px; font-size: 0.85em;">
                Scala attuale: <strong id="currentScaleName">üéé Pentatonica</strong>
            </div>
            <button onclick="closeScaleModal()" style="background: #868e96;">Chiudi</button>
        </div>
    </div>
</div>

<div id="apiGuideModal" class="modal">
    <div class="modal-content">
        <button class="modal-close" onclick="closeApiGuide()">√ó</button>
        <h2>üîë Come Ottenere e Usare API Key</h2>

        <div style="background: #e7f5ff; padding: 12px; border-radius: 8px; margin-bottom: 15px; font-size: 0.85em;">
            <strong>üìå Importante:</strong> La chiave API √® <strong>100% gratuita</strong> e serve per far funzionare l'intelligenza artificiale che valuta le tue foto!
        </div>

        <h3 style="font-size: 1.1em; margin-top: 15px; color: #667eea;">1Ô∏è‚É£ Ottieni la chiave (1 minuto):</h3>
        <ol style="margin-left: 20px; line-height: 1.8; font-size: 0.9em; margin-bottom: 15px;">
            <li>Vai su <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: #667eea; font-weight: bold;">Google AI Studio</a></li>
            <li>Accedi con il tuo account Google</li>
            <li>Clicca "Get API Key" o "Create API Key"</li>
            <li>Copia la chiave (inizia con <code style="background: #f1f3f5; padding: 2px 6px; border-radius: 3px;">AIza...</code>)</li>
        </ol>

        <h3 style="font-size: 1.1em; margin-top: 15px; color: #667eea;">2Ô∏è‚É£ Inserisci la chiave:</h3>
        <p style="font-size: 0.9em; margin-left: 20px; line-height: 1.6;">
            ‚Ä¢ Quando chiudi questa finestra, apparir√† un popup<br>
            ‚Ä¢ Incolla la chiave nel campo<br>
            ‚Ä¢ Verr√† salvata automaticamente nel browser
        </p>

        <div style="background: #fff3cd; padding: 12px; border-radius: 8px; margin-top: 15px; font-size: 0.85em;">
            <strong>üîí Privacy:</strong> La chiave resta solo sul tuo dispositivo, non la condividiamo con nessuno!
        </div>

        <button onclick="closeApiGuide()" style="margin-top: 15px;">Ho capito, inserisco la chiave!</button>
    </div>
</div>

<div id="instructionsModal" class="modal">
    <div class="modal-content">
        <button class="modal-close" onclick="proceedToGame()">√ó</button>
        <h2>üìã Istruzioni</h2>
        <div id="instructionsContent"></div>
    </div>
</div>

<div id="resultsModal" class="modal">
    <div class="modal-content">
        <button class="modal-close" onclick="backToModes()">√ó</button>
        <h2>üéâ Risultati Finali</h2>
        <div id="resultsContent"></div>
        <button onclick="backToModes()">Gioca Ancora</button>
    </div>
</div>

<div class="modal" id="keyModal">
    <div class="modal-content">
        <button class="modal-close" onclick="closeKeyModal()">√ó</button>
        <h2>üéπ Scegli la Tonalit√†</h2>
        <div class="demo-grid" id="keyGrid"></div>
        <div style="margin-top: 15px; display: flex; gap: 8px; align-items: center;">
            <div style="flex: 1; padding: 8px; background: #f1f3f5; border-radius: 5px; font-size: 0.85em;">
                Tonalit√† attuale: <strong id="currentKeyName">C</strong>
            </div>
            <button onclick="closeKeyModal()" style="background: #868e96;">Chiudi</button>
        </div>
    </div>
</div>

<div class="modal" id="timbreModal">
    <div class="modal-content">
        <button class="modal-close" onclick="closeTimbreModal()">√ó</button>
        <h2>üé∏ Scegli lo Strumento</h2>
        <div class="demo-grid">
            <button class="demo-button" onclick="selectTimbre('piano')">üéπ Piano</button>
            <button class="demo-button" onclick="selectTimbre('strings')">üéª Archi</button>
            <button class="demo-button" onclick="selectTimbre('flute')">üé∫ Flauto</button>
            <button class="demo-button" onclick="selectTimbre('synth')">üéõÔ∏è Synth</button>
        </div>
        <div style="margin-top: 15px; display: flex; gap: 8px; align-items: center;">
            <div style="flex: 1; padding: 8px; background: #f1f3f5; border-radius: 5px; font-size: 0.85em;">
                Strumento attuale: <strong id="currentTimbreName">üéπ Piano</strong>
            </div>
            <button onclick="closeTimbreModal()" style="background: #868e96;">Chiudi</button>
        </div>
    </div>
</div>

<div class="modal" id="galleryModal">
    <div class="modal-content">
        <button class="modal-close" onclick="closeGalleryModal()">√ó</button>
        <h2>üìπ Galleria Registrazioni</h2>
        <div id="galleryContent" style="max-height: 60vh; overflow-y: auto;">
            <p style="text-align: center; color: #666; padding: 20px;">Caricamento...</p>
        </div>
        <button onclick="closeGalleryModal()" style="background: #868e96; margin-top: 10px;">Chiudi</button>
    </div>
</div>

<div class="modal" id="aboutModal">
    <div class="modal-content" style="max-height: 85vh; overflow-y: auto;">
        <button class="modal-close" onclick="closeAbout()">√ó</button>
        <h2 style="margin-bottom: 25px; color: #667eea; text-align: center;">‚ÑπÔ∏è About BontempApp</h2>

        <!-- Introduzione al Progetto -->
        <div style="background: linear-gradient(135deg, #f0f4ff 0%, #e8f0fe 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 5px solid #667eea;">
            <h3 style="color: #667eea; margin-bottom: 15px; font-size: 1.1em;">üéØ Il Progetto</h3>

            <p style="font-size: 0.9em; line-height: 1.8; color: #2c3e50; margin-bottom: 15px;">
                <strong>BontempApp</strong> fa parte di un pi√π ampio progetto di <strong>ricerca e sviluppo di applicazioni didattiche per artisti e musicisti</strong>,
                ideato da <strong>Francesco Mariano</strong> per <strong>Creative Studio Lab</strong>.
            </p>

            <p style="font-size: 0.9em; line-height: 1.8; color: #2c3e50; margin-bottom: 15px;">
                Questo progetto nasce dall'esigenza di fornire strumenti interattivi e accessibili per supportare l'apprendimento musicale
                attraverso il gioco, la creativit√† e l'esperienza diretta. L'obiettivo √® rendere lo studio della musica coinvolgente e divertente,
                combinando teoria, pratica ed elementi ludici.
            </p>

            <!-- Presentazione Francesco Mariano -->
            <div style="background: white; padding: 15px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #764ba2;">
                <h4 style="color: #667eea; margin-bottom: 12px; font-size: 1em;">üë§ Francesco Mariano</h4>
                <p style="font-size: 0.85em; line-height: 1.8; color: #2c3e50; margin-bottom: 12px;">
                    La mia ricerca artistica si concentra sulla <strong>composizione elettroacustica</strong>, <strong>installazioni sonore interattive</strong>,
                    <strong>soundscape composition</strong> e <strong>ambienti audio immersivi</strong> attraverso programmazione <strong>Max/MSP Jitter</strong>,
                    <strong>TouchDesigner</strong> e sviluppo di applicazioni e software interattivo in ambito artistico.
                </p>
                <p style="font-size: 0.85em; line-height: 1.8; color: #2c3e50;">
                    <strong>Docente di Processi e Tecniche dello Spettacolo Multimediale</strong> presso <strong>Accademia di Belle Arti di Macerata</strong>
                    e <strong>Interaction Design</strong> presso <strong>Accademia di Belle Arti di Catania</strong>.
                </p>
            </div>

            <div style="background: white; padding: 15px; border-radius: 8px; margin-top: 15px;">
                <h4 style="color: #667eea; margin-bottom: 12px; font-size: 1em;">üåü Filosofia del Progetto</h4>
                <ul style="line-height: 1.8; color: #2c3e50; font-size: 0.85em; margin-left: 15px;">
                    <li><strong>Apprendimento Ludico</strong>: Imparare giocando e sperimentando</li>
                    <li><strong>Accessibilit√†</strong>: Strumenti gratuiti accessibili per tutti</li>
                    <li><strong>Creativit√†</strong>: Stimolare la creativit√† attraverso disegno audio e sfide</li>
                    <li><strong>Tecnologia</strong>: Uso di AI, Web Audio API, e tecnologie moderne</li>
                    <li><strong>Interattivit√†</strong>: Feedback immediato e valutazioni intelligenti</li>
                </ul>
            </div>

            <div style="background: #fffbe6; padding: 15px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #f4a261;">
                <h4 style="color: #667eea; margin-bottom: 12px; font-size: 1em;">üöÄ Altre App del Progetto</h4>
                <p style="color: #2c3e50; line-height: 1.8; font-size: 0.85em;">
                    <strong>BontempApp</strong> √® parte di una suite di applicazioni didattiche sviluppate da Creative Studio Lab:
                </p>
                <div style="margin-top: 12px;">
                    <a href="https://www.soundscapestudio.app" target="_blank" style="display: flex; align-items: center; padding: 10px; background: white; border-radius: 6px; text-decoration: none; margin-bottom: 10px; border-left: 3px solid #2d5f4f; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" onmouseover="this.style.transform='translateX(5px)'; this.style.boxShadow='0 4px 8px rgba(45,95,79,0.2)';" onmouseout="this.style.transform='translateX(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)';" ontouchstart="this.style.transform='translateX(5px)'" ontouchend="this.style.transform='translateX(0)'">
                        <span style="font-size: 1.8em; margin-right: 12px;">üéß</span>
                        <div>
                            <strong style="color: #2d5f4f; font-size: 0.9em;">Soundscape Studio</strong>
                            <p style="margin: 2px 0 0 0; color: #666; font-size: 0.75em;">Field recording e composizione con paesaggi sonori</p>
                        </div>
                    </a>
                    <div style="padding: 10px; background: white; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid #764ba2;">
                        <div style="display: flex; align-items: center;">
                            <span style="font-size: 1.8em; margin-right: 12px;">üé®</span>
                            <div>
                                <strong style="color: #764ba2; font-size: 0.9em;">Graphic Score Generator</strong>
                                <p style="margin: 2px 0 0 0; color: #666; font-size: 0.75em;">Creazione di partiture grafiche interattive (in sviluppo)</p>
                            </div>
                        </div>
                    </div>
                    <div style="padding: 10px; background: white; border-radius: 6px; border-left: 3px solid #17a2b8;">
                        <div style="display: flex; align-items: center;">
                            <span style="font-size: 1.8em; margin-right: 12px;">üßò</span>
                            <div>
                                <strong style="color: #17a2b8; font-size: 0.9em;">Artist Mental Health</strong>
                                <p style="margin: 2px 0 0 0; color: #666; font-size: 0.75em;">Mindfulness e benessere per artisti (in sviluppo)</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <button onclick="closeAbout()" style="width: 100%;">Chiudi</button>
    </div>
</div>

<div class="modal" id="guidaModal">
    <div class="modal-content" style="max-height: 85vh; overflow-y: auto;">
        <button class="modal-close" onclick="closeGuida()">√ó</button>
        <h2 style="margin-bottom: 25px; color: #667eea; text-align: center;">üìñ Guida Completa BontempApp</h2>

        <!-- Modalit√† Disegno Audio -->
        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid #667eea;">
            <h3 style="color: #667eea; margin-bottom: 12px; font-size: 1.05em;">üé® Modalit√† Disegno Audio (2D/3D)</h3>

            <div style="margin-bottom: 15px;">
                <h4 style="color: #495057; font-size: 0.95em; margin-bottom: 8px;">üéØ Modalit√† Libera</h4>
                <p style="font-size: 0.85em; line-height: 1.6; color: #2c3e50;">
                    Disegna liberamente sullo schermo (2D) o nello spazio (3D) e crea suoni in tempo reale.
                    Ogni tocco genera una frequenza basata sulla posizione Y, con audio spaziale in 3D.
                </p>
            </div>

            <div style="margin-bottom: 15px;">
                <h4 style="color: #495057; font-size: 0.95em; margin-bottom: 8px;">‚ú® Modalit√† Guidata</h4>
                <p style="font-size: 0.85em; line-height: 1.6; color: #2c3e50;">
                    Esplora <strong>20 preset musicali</strong> (10 per 2D + 10 per 3D) con demo automatiche animate.
                    Ogni preset include informazioni acustiche e pattern musicali professionali.
                </p>
                <ul style="font-size: 0.8em; margin: 8px 0 0 15px; line-height: 1.6;">
                    <li><strong>Preset 2D</strong>: Armonico, Onda, Spirale, Pulsante, Orbite, Volto, Albero, etc.</li>
                    <li><strong>Preset 3D</strong>: Elica, Sfera, Cubo, Lissajous, Vortice, Casa 3D, Farfalla, etc.</li>
                </ul>
            </div>

            <div style="background: #e7f5ff; padding: 10px; border-radius: 5px; font-size: 0.8em;">
                <strong>üí° Tip:</strong> Puoi registrare le tue performance e salvarle nella galleria!
            </div>
        </div>

        <!-- Quiz Musicali -->
        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid #28a745;">
            <h3 style="color: #28a745; margin-bottom: 12px; font-size: 1.05em;">üéØ Quiz Musicali</h3>

            <p style="font-size: 0.85em; line-height: 1.6; color: #2c3e50; margin-bottom: 12px;">
                Testa le tue conoscenze musicali con quiz a tempo su tre aree tematiche:
            </p>

            <ul style="font-size: 0.85em; margin: 0 0 12px 15px; line-height: 1.8; color: #2c3e50;">
                <li><strong>üéº Quiz '900</strong>: Musica colta del Novecento (3 livelli di difficolt√†)</li>
                <li><strong>üé∑ Quiz Jazz</strong>: Storia, armonia e stili jazz (3 livelli)</li>
                <li><strong>üéª Quiz Classica</strong>: Teoria musicale e armonia (3 livelli)</li>
            </ul>

            <div style="background: #fff3cd; padding: 10px; border-radius: 5px; font-size: 0.8em;">
                <strong>‚è±Ô∏è Timer</strong>: Hai 30 secondi per rispondere. Pi√π veloce rispondi, pi√π punti ottieni! (Bonus fino a +20 punti)
            </div>
        </div>

        <!-- Challenge Fotografiche -->
        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid #17a2b8;">
            <h3 style="color: #17a2b8; margin-bottom: 12px; font-size: 1.05em;">üì∏ Photo Challenge</h3>

            <p style="font-size: 0.85em; line-height: 1.6; color: #2c3e50; margin-bottom: 12px;">
                <strong>200 sfide fotografiche</strong> divise in due livelli di difficolt√†:
            </p>

            <ul style="font-size: 0.85em; line-height: 1.8; color: #2c3e50; margin-left: 20px; margin-bottom: 12px;">
                <li><strong>BASE</strong> (100 sfide): Concettuali, ironiche, da eseguire comodamente. Osservazione e creativit√†!</li>
                <li><strong>AUDACI</strong> (100 sfide): Performance pubbliche, coinvolgono altre persone, situazioni imbarazzanti e teatrali!</li>
            </ul>

            <div style="background: #d4edda; padding: 10px; border-radius: 5px; font-size: 0.8em;">
                <strong>‚è≠Ô∏è Puoi saltare</strong>: Non ti piace una challenge? Clicca "Salta" per caricarne una nuova senza penalit√†!
            </div>
        </div>

        <!-- Curiosit√† -->
        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid #6f42c1;">
            <h3 style="color: #6f42c1; margin-bottom: 12px; font-size: 1.05em;">üß† Curiosit√† Musicali</h3>
            <p style="font-size: 0.85em; line-height: 1.6; color: #2c3e50;">
                Scopri fatti interessanti, aneddoti e informazioni sulla storia della musica. Ogni curiosit√† ha un timer di lettura ottimale.
            </p>
        </div>

        <button onclick="closeGuida()" style="width: 100%;">Chiudi</button>
    </div>
</div>

<!-- Modale Conferma Pubblicazione Sala della Fama -->
<div class="publish-modal" id="publishModal">
    <div class="publish-modal-content">
        <div class="publish-modal-title">üèÜ Capolavoro!</div>
        <div class="publish-modal-text" id="publishModalText"></div>

        <!-- Disclaimer ToS -->
        <div class="tos-warning">
            <strong>‚ö†Ô∏è Contenuti Vietati:</strong>
            <p>Non pubblicare foto con nudit√†, violenza, contenuti offensivi, di odio o che violino la legge. La violazione porter√† alla rimozione del contenuto e al ban dell'account.</p>
        </div>

        <!-- Checkbox Consenso Obbligatoria -->
        <label class="tos-checkbox-label">
            <input type="checkbox" id="tosCheckbox" class="tos-checkbox" onchange="togglePublishButton()">
            <span>Dichiaro che questa foto √® appropriata per tutti, non contiene nudit√†, violenza o offese, e rispetto i Termini di Servizio.</span>
        </label>

        <div class="publish-modal-buttons">
            <button class="publish-modal-btn publish-btn-no" onclick="closePublishModal()">
                No, tienila per me
            </button>
            <button id="publishButton" class="publish-modal-btn publish-btn-yes" onclick="publishToHallOfFame()" disabled>
                S√¨, Pubblica! üéâ
            </button>
        </div>
    </div>
</div>

<!-- Badge Utente Autenticato (nascosto di default) -->
<div class="auth-badge" id="authBadge" style="display: none;">
    <img id="authAvatar" class="auth-badge-avatar" src="" alt="Avatar">
    <span id="authName" class="auth-badge-name"></span>
    <button class="auth-badge-logout" onclick="logoutUser()">Esci</button>
</div>

<!-- Modale Login -->
<div class="login-modal" id="loginModal">
    <div class="login-modal-content">
        <div class="login-modal-title">üéµ Benvenuto!</div>
        <div class="login-modal-subtitle">
            Accedi per condividere le tue sfide nella <strong>Sala della Fama</strong> e interagire con la community!
        </div>

        <button class="login-btn login-btn-google" onclick="loginWithGoogle()">
            <svg width="20" height="20" viewBox="0 0 24 24">
                <path fill="white" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                <path fill="white" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                <path fill="white" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                <path fill="white" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
            </svg>
            Continua con Google
        </button>

        <button class="login-btn login-btn-anonymous" onclick="loginAnonymously()">
            üë§ Continua come Ospite
        </button>

        <div class="login-modal-footer">
            üîí I tuoi dati sono al sicuro. Usiamo Firebase per l'autenticazione sicura.
        </div>
    </div>
</div>

<!-- üîí SMART WALL MODAL - Richiesta upgrade a Google Account -->
<div class="login-modal" id="smartWallModal">
    <div class="login-modal-content">
        <div class="login-modal-title" style="font-size: 2em;">üöÄ</div>
        <div class="login-modal-title">Stai per unirti agli Audaci!</div>
        <div class="login-modal-subtitle" style="margin: 15px 0; line-height: 1.6;">
            Per <strong>pubblicare foto</strong> e <strong>votare</strong> le sfide, devi diventare un <strong>Membro</strong>.<br><br>
            Accedi con Google per salvare i tuoi capolavori e scalare la classifica! üèÜ
        </div>

        <button class="login-btn login-btn-google" onclick="upgradeToGoogleAccount()" style="animation: pulse 2s infinite;">
            <svg width="20" height="20" viewBox="0 0 24 24">
                <path fill="white" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                <path fill="white" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                <path fill="white" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                <path fill="white" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
            </svg>
            Accedi con Google
        </button>

        <button class="login-btn login-btn-anonymous" onclick="closeSmartWallModal()" style="background: #6c757d;">
            ‚Üê Torna indietro
        </button>

        <div class="login-modal-footer">
            ‚ÑπÔ∏è La tua cronologia (quiz, punteggi) verr√† mantenuta dopo l'upgrade!
        </div>
    </div>
</div>

<script>
console.log('üéµ BontempApp v3.1 ENHANCED EDITION - Caricamento...');

let userName = '';
let currentMode = '';
let apiKey = localStorage.getItem('geminiApiKey') || '';
let challengeDifficulty = 'simple'; // 'simple' or 'audace'

// Sistema a "mazzo" per sfide senza ripetizioni
let shuffledBaseChallenges = [];
let shuffledAudaciChallenges = [];
let baseIndex = 0;
let audaciIndex = 0;

// ==================== SALA DELLA FAMA - Firebase & Data ====================
let db = null;
let storage = null;
let auth = null;
let currentUser = null; // Utente Firebase autenticato
let isManualLogout = false; // Flag per tracciare logout manuale
let pendingPublication = {
    imageData: null,
    challengeTitle: null,
    aiComment: null
};

// Inizializzazione Firebase
// ‚ö†Ô∏è IMPORTANTE: La chiave API √® caricata dal file config.js (NON committato su GitHub)
const firebaseConfig = {
    apiKey: FIREBASE_API_KEY, // üîí Caricata da config.js (file locale non su GitHub)
    authDomain: "bontempapp.firebaseapp.com",
    projectId: "bontempapp",
    storageBucket: "bontempapp.firebasestorage.app",
    messagingSenderId: "620117691745",
    appId: "1:620117691745:web:91542e8eda342a1ce20920",
    measurementId: "G-CCXHKM4H63"
};

// Inizializza Firebase (solo se non gi√† inizializzato)
try {
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    db = firebase.firestore();
    storage = firebase.storage();
    auth = firebase.auth();
    console.log('‚úÖ Firebase inizializzato correttamente');

    // Observer per lo stato di autenticazione + Smart Wall
    auth.onAuthStateChanged(async user => {
        if (user) {
            // Utente gi√† autenticato (Google o Anonimo)
            currentUser = user;
            updateAuthUI(user);
            isManualLogout = false; // Reset flag

            if (user.isAnonymous) {
                console.log('üë§ Stato auth: Visitatore Anonimo (pu√≤ navigare, non pu√≤ partecipare)');
            } else {
                console.log(`üë§ Stato auth: Membro - ${user.displayName || 'Senza nome'} (pu√≤ partecipare)`);
            }
        } else {
            // Nessun utente: login anonimo automatico (Smart Wall)
            // MA solo se non √® un logout manuale
            if (!isManualLogout) {
                try {
                    console.log('üîí Smart Wall: Login anonimo automatico...');
                    const result = await auth.signInAnonymously();
                    currentUser = result.user;
                    updateAuthUI(result.user);
                    console.log('‚úÖ Visitatore Anonimo creato:', result.user.uid);
                } catch (error) {
                    console.error('‚ùå Errore login anonimo:', error);
                    currentUser = null;
                    updateAuthUI(null);
                }
            } else {
                // Logout manuale: aspetta prima di ri-loggare come anonimo
                currentUser = null;
                updateAuthUI(null);
                console.log('üëã Logout manuale: sessione terminata');

                // Dopo 1 secondo, ri-logga come anonimo (Smart Wall)
                setTimeout(async () => {
                    try {
                        console.log('üîí Smart Wall: Ritorno a Visitatore Anonimo...');
                        const result = await auth.signInAnonymously();
                        currentUser = result.user;
                        updateAuthUI(result.user);
                        showIndicator('üë§ Sei tornato Visitatore');
                        console.log('‚úÖ Visitatore Anonimo creato:', result.user.uid);
                        isManualLogout = false; // Reset flag
                    } catch (error) {
                        console.error('‚ùå Errore login anonimo:', error);
                        currentUser = null;
                        updateAuthUI(null);
                    }
                }, 1000);
            }
        }
    });

    // Carica sfida in evidenza nella home
    loadFeaturedChallenge();
} catch (error) {
    console.error('‚ùå Errore inizializzazione Firebase:', error);
}

// ==================== SISTEMA PROFILO UTENTE ====================
let userProfile = {
    name: '',
    firstAccess: null,
    lastAccess: null,
    quizHistory: [],
    challengeHistory: [],
    stats: {
        totalQuizzes: 0,
        totalChallenges: 0,
        quizBestScore: 0,
        challengeBestScore: 0,
        quizAverage: 0,
        challengeAverage: 0,
        streak: 0,
        lastPlayDate: null
    }
};

let canvas, ctx, activeTouches = new Map();
let touchColors = ['#667eea', '#f5576c', '#51cf66'];
let sharedAudioContext = null;
let activeOscillators = new Map();
let waveformSettings = { 0: 'sine', 1: 'square', 2: 'sawtooth' };
let realtimeData = {
    0: { frequency: 0, amplitude: 0, active: false },
    1: { frequency: 0, amplitude: 0, active: false },
    2: { frequency: 0, amplitude: 0, active: false }
};

// ==================== ENHANCED SYNTHESIS SYSTEM ====================
// Scale musicali (occidentali, orientali, esotiche)
const SCALES = {
    // Scale Occidentali
    chromatic: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11], // Tutti i semitoni
    major: [0, 2, 4, 5, 7, 9, 11], // Scala maggiore (Do Re Mi Fa Sol La Si)
    minor: [0, 2, 3, 5, 7, 8, 10], // Scala minore naturale
    pentatonic: [0, 2, 4, 7, 9], // Pentatonica maggiore (Cina, Giappone)
    blues: [0, 3, 5, 6, 7, 10], // Scala blues (note blue)
    harmonic_minor: [0, 2, 3, 5, 7, 8, 11], // Minore armonica (suono drammatico)

    // Scale Mediorientali/Arabe
    arabic: [0, 1, 4, 5, 7, 8, 11], // Maqam Hijaz (musica araba)
    persian: [0, 1, 4, 5, 6, 8, 11], // Dastgah (musica persiana)
    hijaz: [0, 1, 4, 5, 7, 8, 10], // Scala Hijaz

    // Scale Indiane
    raga_bhairav: [0, 1, 4, 5, 7, 8, 11], // Raga Bhairav (alba)
    raga_todi: [0, 1, 3, 6, 7, 8, 11], // Raga Todi (mezzogiorno)
    raga_yaman: [0, 2, 4, 6, 7, 9, 11], // Raga Yaman (sera)

    // Scale Giapponesi
    japanese_in: [0, 1, 5, 7, 8], // Scala In (misteriosa)
    japanese_yo: [0, 2, 5, 7, 9], // Scala Yo (allegra)
    japanese_hirajoshi: [0, 2, 3, 7, 8], // Hiraj≈çshi (tradizionale)

    // Scale Africane
    african_1: [0, 2, 3, 5, 7, 9, 10], // Scala africana comune
    african_2: [0, 3, 5, 7, 10], // Pentatonica africana

    // Scale Esotiche/Moderne
    whole_tone: [0, 2, 4, 6, 8, 10], // Scala per toni interi (Debussy)
    diminished: [0, 2, 3, 5, 6, 8, 9, 11], // Scala diminuita (jazz)
    augmented: [0, 3, 4, 7, 8, 11], // Scala aumentata
    phrygian: [0, 1, 3, 5, 7, 8, 10], // Modo frigio (flamenco)
    lydian: [0, 2, 4, 6, 7, 9, 11], // Modo lidio (sognante)
    spanish: [0, 1, 3, 4, 5, 6, 8, 10] // Scala spagnola (flamenco)
};

const SCALE_NAMES = {
    chromatic: 'üéπ Cromatica',
    major: 'üòä Maggiore',
    minor: 'üòî Minore',
    pentatonic: 'üéé Pentatonica',
    blues: 'üé∫ Blues',
    harmonic_minor: 'üéª Minore Armonica',
    arabic: 'üïå Araba (Hijaz)',
    persian: 'üè∫ Persiana',
    hijaz: 'üåô Hijaz',
    raga_bhairav: 'üáÆüá≥ Raga Bhairav',
    raga_todi: 'üáÆüá≥ Raga Todi',
    raga_yaman: 'üáÆüá≥ Raga Yaman',
    japanese_in: 'üáØüáµ In',
    japanese_yo: 'üáØüáµ Yo',
    japanese_hirajoshi: 'üáØüáµ Hiraj≈çshi',
    african_1: 'üåç Africana 1',
    african_2: 'üåç Africana 2',
    whole_tone: 'üåä Toni Interi',
    diminished: 'üé∑ Diminuita',
    augmented: '‚ú® Aumentata',
    phrygian: 'üíÉ Frigia',
    lydian: '‚òÅÔ∏è Lidia',
    spanish: 'üé∏ Spagnola'
};

let currentScale = 'pentatonic'; // Scala di default

// Preset timbri con armonici (sintesi additiva)
const TIMBRE_PRESETS = {
    piano: {
        harmonics: [
            { mult: 1, amp: 1.0, type: 'sine' },
            { mult: 2, amp: 0.5, type: 'sine' },
            { mult: 3, amp: 0.3, type: 'sine' },
            { mult: 4, amp: 0.2, type: 'sine' }
        ],
        attack: 0.01,
        decay: 0.1,
        sustain: 0.7,
        release: 0.3,
        baseVolume: 0.15
    },
    strings: {
        harmonics: [
            { mult: 1, amp: 1.0, type: 'sawtooth' },
            { mult: 2, amp: 0.6, type: 'sine' },
            { mult: 3, amp: 0.4, type: 'sine' }
        ],
        attack: 0.3,
        decay: 0.1,
        sustain: 0.9,
        release: 0.5,
        baseVolume: 0.12
    },
    flute: {
        harmonics: [
            { mult: 1, amp: 1.0, type: 'sine' },
            { mult: 2, amp: 0.3, type: 'sine' },
            { mult: 3, amp: 0.15, type: 'sine' }
        ],
        attack: 0.08,
        decay: 0.05,
        sustain: 0.8,
        release: 0.2,
        baseVolume: 0.18
    },
    synth: {
        harmonics: [
            { mult: 1, amp: 1.0, type: 'square' },
            { mult: 1.5, amp: 0.7, type: 'sawtooth' },
            { mult: 2, amp: 0.5, type: 'triangle' },
            { mult: 3, amp: 0.3, type: 'sine' }
        ],
        attack: 0.02,
        decay: 0.1,
        sustain: 0.8,
        release: 0.2,
        baseVolume: 0.10
    }
};

// Le 12 tonalit√† musicali (semitoni da C)
const KEYS = {
    'C': 0, 'C#': 1, 'D': 2, 'D#': 3,
    'E': 4, 'F': 5, 'F#': 6, 'G': 7,
    'G#': 8, 'A': 9, 'A#': 10, 'B': 11
};

const KEY_NAMES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];

let currentKey = 'C'; // Tonalit√† di default
let currentTimbre = 'piano'; // Timbro di default
let fingerTimbreMap = { 0: 'piano', 1: 'strings', 2: 'flute' }; // Un timbro per dito

// IndexedDB per le registrazioni
let recordingsDB = null;

let guidesEnabled = false;
let guideSpeed = 1.0;
let guideBalls = [];
let guideAnimationId = null;
let guideTime = 0;
let currentPreset = 'harmonic';
let demoMode = false;
let audioGuidedMode = false;
let demoTouches = [null, null, null];
let selectedDemoPreset = null;

let scene3d, camera3d, renderer3d, meshes3d = [];
let guideMeshes3d = [];
let touchIdToFingerIndex = new Map();
let nextFingerIndex = 0;
let animationLoopId = null;
let audioListener3d = null; // Listener per audio 3D spaziale
let activeTouchCount = 0; // Numero di dita attive per calcolare profondit√†

let score = 0;
let currentRound = 1;
let maxRounds = 10;
let currentQuestions = [];
let currentDifficulty = '';
let isExpertMode = false;

// TIMER PER QUIZ
let quizTimer = null;
let quizTimeRemaining = 30; // 30 secondi per domanda
let questionStartTime = 0;
let isProcessingAnswer = false; // Previeni risposte multiple

let uploadedImage = null;
let uploadedImageMimeType = '';
let currentChallenge = '';

let curiositaTimer = null;
let curiositaTimeRemaining = 0;
let currentCuriositaIndex = 0;

// RECORDING VARIABLES
let mediaRecorder = null;
let recordedChunks = [];
let isRecording = false;
let canvasStream = null;
let audioDestination = null;
let audioStream = null;

const DEBUG_MODE = true;
function debugLog(msg, data = null) {
    if (DEBUG_MODE) console.log(`[üéµ v3.1 ENH] ${msg}`, data || '');
}

const presets2DGeometric = {
    harmonic: {
        name: 'üéº Armonico',
        icon: 'üéº',
        desc: 'Triadi e accordi',
        acousticInfo: 'Triadi (fondamentale, terza, quinta). Rapporti fissi = consonanza.',
        calculate: (t, w, h, i) => {
            const baseY = h / 2;
            const heights = [0.2, 0, -0.2];
            const x = w / 2 + Math.sin(t * 0.5) * (w * 0.3);
            const y = baseY + (h * heights[i]) + Math.sin(t * 0.8 + i) * (h * 0.1);
            return { x, y };
        }
    },
    wave: {
        name: 'üåä Onda',
        icon: 'üåä',
        desc: 'Onde sincronizzate',
        acousticInfo: 'Sfasamento 120¬∞. Battimenti quando frequenze vicine.',
        calculate: (t, w, h, i) => {
            const phase = i * (Math.PI * 2 / 3);
            const x = w / 2 + Math.sin(t * 0.7 + phase) * (w * 0.35);
            const y = h / 2 + Math.sin(t * 0.9 + phase * 0.5) * (h * 0.3);
            return { x, y };
        }
    },
    spiral: {
        name: 'üåÄ Spirale',
        icon: 'üåÄ',
        desc: 'Glissando convergente',
        acousticInfo: 'Glissando continuo. Raggio variabile = sweep frequenza.',
        calculate: (t, w, h, i) => {
            const baseAngle = t * 0.6 + i * (Math.PI * 2 / 3);
            const radius = (w * 0.3) * (0.5 + 0.5 * Math.sin(t * 0.3));
            const x = w / 2 + Math.cos(baseAngle) * radius;
            const y = h / 2 + Math.sin(baseAngle) * radius;
            return { x, y };
        }
    },
    pulse: {
        name: 'üíó Pulsante',
        icon: 'üíó',
        desc: 'Pattern ritmico',
        acousticInfo: 'ADSR rapido. ~120 BPM. Variazioni ampiezza = accenti.',
        calculate: (t, w, h, i) => {
            const pulse = Math.max(0, Math.sin(t * 8));
            const positions = [
                { x: w * 0.25, y: h * 0.5 },
                { x: w * 0.5, y: h * 0.3 },
                { x: w * 0.75, y: h * 0.5 }
            ];
            const activePos = positions[i];
            return {
                x: activePos.x + Math.sin(t * 4 + i) * 20 * pulse,
                y: activePos.y + Math.cos(t * 4 + i) * 20 * pulse
            };
        }
    },
    orbit: {
        name: '‚≠ï Orbite',
        icon: '‚≠ï',
        desc: 'Cerchi concentrici',
        acousticInfo: 'Tre raggi. Velocit√† diverse = pattern poliritmici.',
        calculate: (t, w, h, i) => {
            const speeds = [0.8, 1.0, 1.2];
            const radii = [w * 0.15, w * 0.25, w * 0.35];
            const angle = t * speeds[i];
            const x = w / 2 + Math.cos(angle) * radii[i];
            const y = h / 2 + Math.sin(angle) * radii[i];
            return { x, y };
        }
    }
};

const presets2DReal = {
    face: {
        name: 'üòä Volto',
        icon: 'üòä',
        desc: 'Volto stilizzato',
        acousticInfo: 'Traccia occhi, naso, bocca. Frequenze corrispondono alle altezze.',
        calculate: (t, w, h, i) => {
            const cx = w / 2, cy = h / 2;
            const phase = (t * 2 + i * 2) % 6;
            
            if (phase < 1) {
                const angle = t * 4;
                return {
                    x: cx - w * 0.15 + Math.cos(angle) * 20,
                    y: cy - h * 0.15 + Math.sin(angle) * 15
                };
            } else if (phase < 2) {
                const angle = t * 4;
                return {
                    x: cx + w * 0.15 + Math.cos(angle) * 20,
                    y: cy - h * 0.15 + Math.sin(angle) * 15
                };
            } else if (phase < 3) {
                return { x: cx, y: cy + (phase - 2) * h * 0.15 };
            } else {
                const smileAngle = Math.PI * 0.2 + (phase - 3) * Math.PI * 0.6;
                return {
                    x: cx + Math.cos(smileAngle) * w * 0.25,
                    y: cy + h * 0.15 + Math.sin(smileAngle) * h * 0.15
                };
            }
        }
    },
    house: {
        name: 'üè† Casa',
        icon: 'üè†',
        desc: 'Casa con tetto',
        acousticInfo: 'Struttura architettonica. Note basse per base, acute per tetto.',
        calculate: (t, w, h, i) => {
            const cx = w / 2, cy = h / 2;
            const phase = (t + i * 0.5) % 4;
            const size = 0.3;
            
            if (phase < 1) {
                return { x: cx - w * size, y: cy - h * size + phase * h * size * 2 };
            } else if (phase < 2) {
                return { x: cx - w * size + (phase - 1) * w * size * 2, y: cy + h * size };
            } else if (phase < 3) {
                return {
                    x: cx - w * size + (phase - 2) * w * size,
                    y: cy + h * size - (phase - 2) * h * size * 2
                };
            } else {
                return {
                    x: cx + (phase - 3) * w * size,
                    y: cy - h * size + (phase - 3) * h * size * 2
                };
            }
        }
    },
    heart: {
        name: '‚ù§Ô∏è Cuore',
        icon: '‚ù§Ô∏è',
        desc: 'Cuore pulsante',
        acousticInfo: 'Forma a cuore. Pulsazioni = variazioni di ampiezza.',
        calculate: (t, w, h, i) => {
            const angle = (t * 1.5 + i * (Math.PI * 2 / 3)) % (Math.PI * 2);
            const pulse = 0.9 + Math.sin(t * 3) * 0.1;
            const x = 16 * Math.pow(Math.sin(angle), 3);
            const y = 13 * Math.cos(angle) - 5 * Math.cos(2 * angle) - 2 * Math.cos(3 * angle) - Math.cos(4 * angle);
            return {
                x: w / 2 + x * w * 0.015 * pulse,
                y: h / 2 - y * h * 0.015 * pulse + h * 0.05
            };
        }
    },
    star: {
        name: '‚≠ê Stella',
        icon: '‚≠ê',
        desc: 'Stella rotante',
        acousticInfo: 'Stella a 5 punte. Rotazione = modulazione circolare.',
        calculate: (t, w, h, i) => {
            const cx = w / 2, cy = h / 2;
            const numPoints = 5;
            const outerRadius = w * 0.25;
            const innerRadius = w * 0.12;
            const rotation = t * 0.5;
            const progress = (t * 2 + i * 0.66) % (numPoints * 2);
            const pointIndex = Math.floor(progress);
            const isOuter = pointIndex % 2 === 0;
            const radius = isOuter ? outerRadius : innerRadius;
            const angle = (pointIndex * Math.PI / numPoints) + rotation;
            return {
                x: cx + Math.cos(angle) * radius,
                y: cy + Math.sin(angle) * radius
            };
        }
    },
    flower: {
        name: 'üå∏ Fiore',
        icon: 'üå∏',
        desc: 'Petali che si aprono',
        acousticInfo: 'Petali che si aprono/chiudono. Raggio variabile = glissando.',
        calculate: (t, w, h, i) => {
            const cx = w / 2, cy = h / 2;
            const petals = 6;
            const baseAngle = (i * Math.PI * 2 / 3);
            const petalAngle = (t * 2) % (Math.PI * 2 / petals);
            const angle = baseAngle + petalAngle;
            const opening = 0.5 + 0.5 * Math.sin(t * 0.8);
            const radius = w * 0.15 * (0.3 + opening * 0.7);
            return {
                x: cx + Math.cos(angle) * radius,
                y: cy + Math.sin(angle) * radius
            };
        }
    }
};

const presets3DGeometric = {
    helix: {
        name: 'üåä Elica',
        icon: 'üåä',
        desc: 'Spirale ascendente',
        acousticInfo: 'Spirale ascendente. Altezza Y = frequenza crescente.',
        calculate: (t, i) => {
            const angle = t * 0.8 + i * (Math.PI * 2 / 3);
            const radius = 5;
            const height = Math.sin(t * 0.3) * 4;
            return {
                x: Math.cos(angle) * radius,
                y: height + (i - 1) * 2,
                z: Math.sin(angle) * radius
            };
        }
    },
    sphere: {
        name: 'üîÆ Sfera',
        icon: 'üîÆ',
        desc: 'Sfera pulsante',
        acousticInfo: 'Movimento su sfera. Raggio pulsante = variazione ampiezza.',
        calculate: (t, i) => {
            const phi = t * 0.6 + i * (Math.PI * 2 / 3);
            const theta = t * 0.4 + i * 0.5;
            const radius = 4 + Math.sin(t * 2) * 1.5;
            return {
                x: radius * Math.sin(phi) * Math.cos(theta),
                y: radius * Math.sin(phi) * Math.sin(theta),
                z: radius * Math.cos(phi)
            };
        }
    },
    cube: {
        name: 'üì¶ Cubo',
        icon: 'üì¶',
        desc: 'Cubo rotante',
        acousticInfo: 'Vertici di cubo. Rotazione = modulazione circolare.',
        calculate: (t, i) => {
            const positions = [
                { x: 4, y: 2, z: 4 },
                { x: -4, y: 0, z: 4 },
                { x: 4, y: -2, z: -4 }
            ];
            const pos = positions[i];
            const angle = t * 0.5;
            const cos = Math.cos(angle);
            const sin = Math.sin(angle);
            return {
                x: pos.x * cos - pos.z * sin,
                y: pos.y + Math.sin(t * 1.5 + i) * 1,
                z: pos.x * sin + pos.z * cos
            };
        }
    },
    lissajous: {
        name: '‚àû Lissajous',
        icon: '‚àû',
        desc: 'Figure complesse',
        acousticInfo: 'Figure di Lissajous. Rapporti frequenze = pattern.',
        calculate: (t, i) => {
            const freqRatios = [[3, 2], [4, 3], [5, 4]];
            const [fx, fy] = freqRatios[i];
            return {
                x: 5 * Math.sin(t * fx * 0.5),
                y: 4 * Math.sin(t * fy * 0.5 + Math.PI / 4),
                z: 4 * Math.cos(t * 0.6 + i * Math.PI / 2)
            };
        }
    },
    vortex: {
        name: 'üå™Ô∏è Vortice',
        icon: 'üå™Ô∏è',
        desc: 'Spirale convergente',
        acousticInfo: 'Spirale verso centro. Velocit√† crescente = glissando rapido.',
        calculate: (t, i) => {
            const angle = t * 1.2 + i * (Math.PI * 2 / 3);
            const radiusBase = 6 - (t * 0.3) % 6;
            const radius = radiusBase + i * 0.5;
            const height = Math.sin(t * 0.8 + i) * 3;
            return {
                x: Math.cos(angle) * radius,
                y: height,
                z: Math.sin(angle) * radius
            };
        }
    }
};

const presets3DReal = {
    house3d: {
        name: 'üè† Casa 3D',
        icon: 'üè†',
        desc: 'Casa cubica rotante',
        acousticInfo: 'Struttura 3D di casa. Base + tetto in rotazione.',
        calculate: (t, i) => {
            const angle = t * 0.6;
            const cos = Math.cos(angle);
            const sin = Math.sin(angle);
            const phase = (t * 2 + i) % 3;
            
            if (phase < 1) {
                const basePos = [
                    { x: -3, y: -2, z: 0 },
                    { x: 0, y: -2, z: 0 },
                    { x: 3, y: -2, z: 0 }
                ][i];
                return {
                    x: basePos.x * cos - basePos.z * sin,
                    y: basePos.y + phase * 3,
                    z: basePos.x * sin + basePos.z * cos
                };
            } else {
                const roofPos = [
                    { x: -2, y: 2, z: 0 },
                    { x: 0, y: 3, z: 0 },
                    { x: 2, y: 2, z: 0 }
                ][i];
                return {
                    x: roofPos.x * cos - roofPos.z * sin,
                    y: roofPos.y,
                    z: roofPos.x * sin + roofPos.z * cos
                };
            }
        }
    },
    tree3d: {
        name: 'üå≥ Albero',
        icon: 'üå≥',
        desc: 'Albero che oscilla',
        acousticInfo: 'Tronco + chioma. Oscillazione = variazione timbrica.',
        calculate: (t, i) => {
            const sway = Math.sin(t * 1.5) * 0.5;
            const phase = (t + i * 0.5) % 2;
            
            if (phase < 1) {
                return { x: sway * phase, y: -3 + phase * 4, z: 0 };
            } else {
                const leafAngle = (t * 2 + i * Math.PI * 2 / 3) % (Math.PI * 2);
                const leafRadius = 2 + Math.sin(t * 2 + i) * 0.5;
                return {
                    x: sway + Math.cos(leafAngle) * leafRadius,
                    y: 1 + Math.sin(leafAngle * 2) * 1,
                    z: Math.sin(leafAngle) * leafRadius
                };
            }
        }
    },
    dna3d: {
        name: 'üß¨ DNA',
        icon: 'üß¨',
        desc: 'Doppia elica',
        acousticInfo: 'Doppia elica del DNA. Due spirali intrecciate.',
        calculate: (t, i) => {
            const helixAngle = t * 1.2 + i * Math.PI;
            const height = (t * 2) % 10 - 5;
            const radius = 3;
            const offset = i < 2 ? 0 : Math.PI;
            return {
                x: Math.cos(helixAngle + offset) * radius,
                y: height + i * 0.3,
                z: Math.sin(helixAngle + offset) * radius
            };
        }
    },
    butterfly3d: {
        name: 'ü¶ã Farfalla',
        icon: 'ü¶ã',
        desc: 'Ali che battono',
        acousticInfo: 'Farfalla 3D. Movimento ali = variazione ampiezza.',
        calculate: (t, i) => {
            const wingBeat = Math.sin(t * 3) * 0.7 + 0.3;
            const flight = Math.sin(t * 0.8) * 2;
            const side = i < 1.5 ? -1 : 1;
            const wingShape = (t * 2 + i) % 1;
            const wingX = side * (2 + wingShape * 2) * wingBeat;
            const wingY = flight + Math.sin(wingShape * Math.PI) * 1.5;
            const wingZ = Math.cos(wingShape * Math.PI) * 1;
            return { x: wingX, y: wingY, z: wingZ };
        }
    },
    note3d: {
        name: 'üéµ Nota',
        icon: 'üéµ',
        desc: 'Chiave di violino',
        acousticInfo: 'Nota musicale 3D. Traccia spirale della chiave.',
        calculate: (t, i) => {
            const rotation = t * 0.5;
            const cos = Math.cos(rotation);
            const sin = Math.sin(rotation);
            const progress = (t * 2 + i * 0.66) % (Math.PI * 4);
            const radius = 2 + Math.sin(progress * 0.5) * 1;
            const height = Math.cos(progress * 0.3) * 3;
            const x = Math.cos(progress) * radius;
            const z = Math.sin(progress) * radius;
            return {
                x: x * cos - z * sin,
                y: height,
                z: x * sin + z * cos
            };
        }
    }
};

// ==================== QUIZ DATABASE - ESPANDIBILE ====================
// Per aggiungere domande: basta aggiungere oggetti in questi array!
// Formato: {q: "domanda", o: ["opzione1", "opzione2", "opzione3", "opzione4"], c: indiceRispostaCorretta}

const quizNovecento = {
    facile: [
        {q: "In quale periodo si colloca il Medioevo musicale?", o: ["200-1000 d.C.","500-1400 d.C.","1000-1600 d.C.","400-1300 d.C."], c: 1},
        {q: "Come si chiama il canto liturgico monodico?", o: ["Canto ambrosiano","Canto mozarabico","Canto gregoriano","Canto romano"], c: 2},
        {q: "Chi √® il 'Padre della Sinfonia'?", o: ["Wolfgang A. Mozart","Ludwig van Beethoven","Franz Joseph Haydn","Carl P. E. Bach"], c: 2},
        {q: "Quanti movimenti ha una sinfonia classica?", o: ["Tre movimenti","Quattro movimenti","Cinque movimenti","Due movimenti"], c: 1},
        {q: "Quale compositore divenne sordo?", o: ["Franz Schubert","Ludwig van Beethoven","Robert Schumann","Gabriel Faur√©"], c: 1},
        {q: "Chi compose 'Le Quattro Stagioni'?", o: ["J. S. Bach","G. F. H√§ndel","Antonio Vivaldi","A. Corelli"], c: 2},
        {q: "Cos'√® la dodecafonia?", o: ["Tecnica 12 semitoni","Danza barocca","Strumento musicale","Forma poetica"], c: 0},
        {q: "Chi invent√≤ la dodecafonia?", o: ["Igor Stravinskij","Arnold Schoenberg","Claude Debussy","B√©la Bart√≥k"], c: 1},
        {q: "Cosa significa 'atonale'?", o: ["Senza centro tonale","Musica forte","Senza ritmo","Senza melodia"], c: 0},
        {q: "Chi compose 'La Sagra della Primavera'?", o: ["Claude Debussy","Maurice Ravel","Igor Stravinskij","S. Prokof'ev"], c: 2},
        // AGGIUNGI ALTRE DOMANDE QUI:
        {q: "In che anno nacque Mozart?", o: ["1756","1770","1685","1750"], c: 0},
        {q: "Chi compose 'Il Flauto Magico'?", o: ["Haydn","Mozart","Beethoven","Schubert"], c: 1},
        {q: "Quale strumento suonava Paganini?", o: ["Pianoforte","Violino","Violoncello","Flauto"], c: 1},
        {q: "Chi compose 'La Traviata'?", o: ["Verdi","Puccini","Rossini","Donizetti"], c: 0},
        {q: "In quale citt√† nacque Wagner?", o: ["Berlino","Vienna","Monaco","Lipsia"], c: 3},
        {q: "In quale epoca visse Bach?", o: ["Rinascimento","Barocco","Classicismo","Romanticismo"], c: 1},
        {q: "Chi ha composto il 'Bol√©ro'?", o: ["Debussy","Ravel","Satie","Faur√©"], c: 1},
        {q: "Cos'√® un sintetizzatore?", o: ["Strumento elettronico","Effetto acustico","Tecnica compositiva","Software audio"], c: 0},
        {q: "Chi √® Karlheinz Stockhausen?", o: ["Compositore classico","Compositore elettronico","Direttore d'orchestra","Musicologo"], c: 1},
        {q: "Cos'√® un loop musicale?", o: ["Sezione ripetuta","Accordo dissonante","Scala particolare","Ritmo irregolare"], c: 0},
        {q: "Cosa significa 'musica concreta'?", o: ["Suoni reali registrati","Musica orchestrale","Musica dodecafonica","Musica minimalista"], c: 0},
        {q: "Quale compositore scrisse 'Music for 18 Musicians'?", o: ["Philip Glass","Steve Reich","Terry Riley","John Adams"], c: 1},
        {q: "In quale anno debutt√≤ 'Le Sacre du Printemps' causando uno scandalo?", o: ["1910","1913","1917","1920"], c: 1},
        {q: "Chi compose 'Atmosph√®res', brano senza melodia n√© ritmo tradizionale?", o: ["Gy√∂rgy Ligeti","Krzysztof Penderecki","Witold Lutos≈Çawski","Iannis Xenakis"], c: 0},
        {q: "Quale compositore us√≤ il 'prepared piano' inserendo oggetti tra le corde?", o: ["Erik Satie","John Cage","Morton Feldman","La Monte Young"], c: 1},
        {q: "Qual √® il nome della tecnica che usa sequenze di Fibonacci in musica?", o: ["Serialismo","Atonalit√†","Proporzionalismo","Minimalismo"], c: 2},
        {q: "Chi scrisse l'opera 'Einstein on the Beach'?", o: ["Steve Reich","Philip Glass","John Adams","Terry Riley"], c: 1},
        {q: "Quale compositore √® considerato il padre del minimalismo con 'In C'?", o: ["Philip Glass","Terry Riley","Steve Reich","La Monte Young"], c: 1},
        {q: "Quale opera di Stockhausen richiede l'esecuzione in un elicottero?", o: ["Helikopter-Streichquartett","Gesang der J√ºnglinge","Kontakte","Gruppen"], c: 0},
        {q: "Chi compose 'Threnody for the Victims of Hiroshima' usando cluster sonori?", o: ["Gy√∂rgy Ligeti","Krzysztof Penderecki","Witold Lutos≈Çawski","Henryk G√≥recki"], c: 1},
        {q: "Quale compositore scrisse 'Vexations', da ripetere 840 volte?", o: ["John Cage","Erik Satie","Morton Feldman","La Monte Young"], c: 1},
        {q: "Chi compose 'Am√©riques', opera per grande orchestra?", o: ["Edgard Var√®se","Charles Ives","Henry Cowell","Carl Ruggles"], c: 0},
        {q: "Quale compositore scrisse 'The Unanswered Question'?", o: ["Charles Ives","Aaron Copland","Samuel Barber","Leonard Bernstein"], c: 0},
        {q: "Chi compose 'Density 21.5' per flauto solo?", o: ["Edgard Var√®se","Pierre Boulez","Luciano Berio","Elliott Carter"], c: 0},
        {q: "Quale opera di Cage richiede 12 radio sintonizzate casualmente?", o: ["Imaginary Landscape No. 4","4'33''","HPSCHD","Variations IV"], c: 0},
        {q: "Chi scrisse 'Short Ride in a Fast Machine'?", o: ["Steve Reich","John Adams","Philip Glass","Michael Nyman"], c: 1},
        {q: "Quale compositore scrisse 'In the White Silence' per coro?", o: ["Eric Whitacre","Morten Lauridsen","Arvo P√§rt","John Tavener"], c: 0},
        {q: "Chi compose 'Fratres' in stile tintinnabuli?", o: ["John Tavener","Arvo P√§rt","Henryk G√≥recki","Sofia Gubaidulina"], c: 1},
        {q: "Quale compositore scrisse 'Symphony of Sorrowful Songs'?", o: ["Witold Lutos≈Çawski","Henryk G√≥recki","Krzysztof Penderecki","Karol Szymanowski"], c: 1},
        {q: "Chi compose 'Shaker Loops' per archi?", o: ["Philip Glass","John Adams","Steve Reich","Terry Riley"], c: 1},
        {q: "Quale compositore scrisse 'D√©serts' con nastro magnetico?", o: ["Karlheinz Stockhausen","Edgard Var√®se","Pierre Schaeffer","Pierre Henry"], c: 1},
        {q: "Chi compose 'Symphony No. 3' detta 'Symphony of Sorrowful Songs'?", o: ["Henryk G√≥recki","Arvo P√§rt","John Tavener","Sofia Gubaidulina"], c: 0},
        {q: "Quale opera di Reich usa ripetizione di parole registrate?", o: ["Music for 18 Musicians","Different Trains","Come Out","Drumming"], c: 2},
        {q: "Chi scrisse 'Nixon in China', opera minimalista?", o: ["Philip Glass","John Adams","Steve Reich","Michael Torke"], c: 1},
        {q: "Quale compositore scrisse 'The Protecting Veil' per cello?", o: ["Arvo P√§rt","John Tavener","Henryk G√≥recki","Sofia Gubaidulina"], c: 1},
        {q: "Chi compose 'The Death of Klinghoffer'?", o: ["Steve Reich","John Adams","Philip Glass","Michael Nyman"], c: 1},
        {q: "Quale compositore scrisse 'Koyaanisqatsi' per film?", o: ["Michael Nyman","Philip Glass","Steve Reich","John Adams"], c: 1},
        {q: "Chi compose 'Tabula Rasa' per due violini preparati?", o: ["John Tavener","Arvo P√§rt","Henryk G√≥recki","Alfred Schnittke"], c: 1}
    ],
    medio: [
        {q: "Quale tecnica caratterizza il serialismo integrale?", o: ["Solo altezze","Parametri multipli","Scale modali","Pattern ritmici"], c: 1},
        {q: "Chi scrisse 'Structures'?", o: ["K. Stockhausen","Pierre Boulez","Luigi Nono","B. Maderna"], c: 1},
        {q: "Quale opera segna l'atonalit√†?", o: ["Verkl√§rte Nacht","Pierrot Lunaire","Erwartung","Moses und Aron"], c: 2},
        {q: "Cos'√® il 'Klangfarbenmelodie'?", o: ["Melodia timbri","Melodia cromatica","Melodia diatonica","Melodia pentatonica"], c: 0},
        {q: "Chi compose 'Metastaseis'?", o: ["G. Ligeti","I. Xenakis","K. Penderecki","W. Lutos≈Çawski"], c: 1},
        // AGGIUNGI ALTRE DOMANDE QUI:
        {q: "Cos'√® la 'Sprechstimme'?", o: ["Canto parlato","Canto lirico","Canto corale","Canto gregoriano"], c: 0},
        {q: "Chi compose '4'33\"'?", o: ["John Cage","Morton Feldman","Karlheinz Stockhausen","Pierre Schaeffer"], c: 0},
        {q: "Chi ha composto 'Pierrot Lunaire'?", o: ["Berg","Webern","Schoenberg","Stravinsky"], c: 2},
        {q: "Cosa rappresenta 'La sagra della primavera'?", o: ["Festa pagana","Sinfonia pastorale","Opera lirica","Balletto sacro"], c: 0},
        {q: "Cos'√® un cluster?", o: ["Gruppo note vicine","Scala pentatonica","Accordo perfetto","Cadenza armonica"], c: 0},
        {q: "Chi ha composto 'Ionisation'?", o: ["Cage","Var√®se","Xenakis","Stockhausen"], c: 1},
        {q: "Cos'√® un sequencer?", o: ["Dispositivo programmazione sequenze","Strumento a corde","Effetto audio","Software notazione"], c: 0},
        {q: "Cosa significa MIDI?", o: ["Protocollo comunicazione","Tipo di microfono","Formato audio","Software DAW"], c: 0},
        {q: "Quale compositore scrisse 'Le marteau sans ma√Ætre' usando serialismo integrale?", o: ["Karlheinz Stockhausen","Pierre Boulez","Luigi Nono","Luciano Berio"], c: 1},
        {q: "Cosa significa 'aleatoric music' o musica aleatoria?", o: ["Musica dodecafonica","Musica con elementi casuali","Musica seriale","Musica spettrale"], c: 1},
        {q: "Chi compose 'Threnody for the Victims of Hiroshima' nel 1960?", o: ["Witold Lutos≈Çawski","Krzysztof Penderecki","Henryk G√≥recki","Karol Szymanowski"], c: 1},
        {q: "Quale tecnica usa Messiaen basata sui canti degli uccelli?", o: ["Serialismo","Trascrizione ornitologica","Musica concreta","Minimalismo"], c: 1},
        {q: "Chi scrisse il 'Po√®me √©lectronique' per il padiglione Philips nel 1958?", o: ["Pierre Schaeffer","Edgard Var√®se","Karlheinz Stockhausen","Pierre Henry"], c: 1},
        {q: "Quale opera di Berio incorpora citazioni di Mahler e altri compositori?", o: ["Sequenza III","Sinfonia","Circles","Visage"], c: 1},
        {q: "Cosa caratterizza la 'musica spettrale' di Grisey e Murail?", o: ["Analisi armonica tradizionale","Analisi dello spettro sonoro","Dodecafonia","Minimalismo"], c: 1},
        {q: "Chi compose 'Different Trains' usando registrazioni vocali campionate?", o: ["John Adams","Steve Reich","Philip Glass","Terry Riley"], c: 1},
        {q: "Quale compositore ungherese raccolse migliaia di canti popolari?", o: ["Gy√∂rgy Ligeti","B√©la Bart√≥k","Zolt√°n Kod√°ly","Franz Liszt"], c: 1},
        {q: "Cosa sono i 'modi a trasposizione limitata' di Messiaen?", o: ["Scale simmetriche","Scale pentatoniche","Modi gregoriani","Scale cromatiche"], c: 0},
        {q: "Chi compose 'Lontano' con texture microp olifonica?", o: ["Krzysztof Penderecki","Gy√∂rgy Ligeti","Witold Lutos≈Çawski","Karlheinz Stockhausen"], c: 1},
        {q: "Quale opera di Nono usa elettronica dal vivo?", o: ["Il canto sospeso","Prometeo","A floresta √© jovem e cheja de vida","Intolleranza 1960"], c: 1},
        {q: "Chi scrisse 'Gruppen' per tre orchestre?", o: ["Pierre Boulez","Karlheinz Stockhausen","Iannis Xenakis","Luciano Berio"], c: 1},
        {q: "Quale compositore us√≤ calcoli stocastici in 'Pithoprakta'?", o: ["Karlheinz Stockhausen","Iannis Xenakis","Pierre Boulez","Luigi Nono"], c: 1},
        {q: "Chi compose 'Sequenza III' per voce femminile?", o: ["Pierre Boulez","Luciano Berio","Karlheinz Stockhausen","Luigi Nono"], c: 1},
        {q: "Quale opera di Stockhausen dura oltre 29 ore?", o: ["Gruppen","Licht","Kontakte","Hymnen"], c: 1},
        {q: "Chi scrisse 'Circles' su poesie di E.E. Cummings?", o: ["John Cage","Luciano Berio","Karlheinz Stockhausen","Pierre Boulez"], c: 1},
        {q: "Quale compositore scrisse 'Laborintus II'?", o: ["Luigi Nono","Luciano Berio","Karlheinz Stockhausen","Pierre Boulez"], c: 1},
        {q: "Chi compose 'De Natura Sonorum' elettroacustica?", o: ["Pierre Schaeffer","Bernard Parmegiani","Pierre Henry","Fran√ßois Bayle"], c: 1},
        {q: "Quale opera di Xenakis usa la teoria dei giochi?", o: ["Metastaseis","Pithoprakta","Duel","Terretektorh"], c: 2},
        {q: "Chi scrisse 'R√©pons' per ensemble e elettronica?", o: ["Karlheinz Stockhausen","Pierre Boulez","Luigi Nono","Luciano Berio"], c: 1},
        {q: "Quale compositore scrisse 'Anaklasis' per archi e percussioni?", o: ["Henryk G√≥recki","Krzysztof Penderecki","Witold Lutos≈Çawski","Gy√∂rgy Ligeti"], c: 1},
        {q: "Chi compose 'Tehillim' usando testi biblici?", o: ["Philip Glass","Steve Reich","John Adams","Arvo P√§rt"], c: 1},
        {q: "Quale opera di Ligeti usa 'harmonic rhythm' stratificato?", o: ["Atmosph√®res","Lontano","Lux Aeterna","Requiem"], c: 2},
        {q: "Chi scrisse 'La Monte Young's Well-Tuned Piano'?", o: ["Terry Riley","La Monte Young","Philip Glass","Steve Reich"], c: 1},
        {q: "Quale compositore scrisse 'Canti di Prigionia'?", o: ["Goffredo Petrassi","Luigi Dallapiccola","Luciano Berio","Luigi Nono"], c: 1},
        {q: "Chi compose 'Divertimento for Band'?", o: ["Vincent Persichetti","Elliott Carter","Samuel Barber","Aaron Copland"], c: 0}
    ],
    avanzato: [
        {q: "Descrivi la tecnica seriale di Webern in 'Variationen op. 27'", a: "Webern usa serie di 12 note con simmetrie rigorose e inversioni speculari.", type: "open"},
        {q: "Spiega il 'Krebsgang' nella dodecafonia", a: "Retrogradazione della serie: la serie viene suonata al contrario.", type: "open"},
        {q: "Quale compositore svilupp√≤ la teoria dei set per analisi atonale?", a: "Allen Forte svilupp√≤ la set theory per analizzare musica atonale.", type: "open"},
        // AGGIUNGI ALTRE DOMANDE APERTE QUI:
        {q: "Spiega il concetto di 'musica concreta' di Pierre Schaeffer", a: "Musica composta manipolando suoni registrati, non strumenti tradizionali.", type: "open"},
        {q: "Cosa rappresenta 'Gesang der J√ºnglinge' di Stockhausen?", a: "Opera pionieristica musica elettronica che unisce voce di ragazzo registrata con suoni elettronici.", type: "open"},
        {q: "Cos'√® la microtonalit√†?", a: "Sistema che usa intervalli pi√π piccoli del semitono tradizionale.", type: "open"},
        {q: "Descrivi la musica spettrale", a: "Corrente compositiva basata su analisi spettrale del suono e sue componenti armoniche.", type: "open"},
        {q: "Come funzionano i sistemi interattivi in musica?", a: "Sistemi che rispondono in tempo reale all'esecutore tramite sensori e algoritmi.", type: "open"},
        {q: "Qual √® il ruolo dell'AI nella composizione musicale?", a: "Generazione automatica di musica, assistenza compositiva, analisi pattern e stili musicali.", type: "open"},
        {q: "Descrivi la 'tecnica del totale cromatico' nella Scuola di Darmstadt", a: "Uso di tutte le 12 altezze cromatiche prima di ripetere una nota, per evitare centri tonali.", type: "open"},
        {q: "Cosa sono i 'modi ritmici' di Messiaen?", a: "Modelli ritmici non retrogradabili basati su palindromi e proporzioni matematiche.", type: "open"},
        {q: "Spiega il concetto di 'moment form' in Stockhausen", a: "Forma musicale composta da momenti indipendenti senza sviluppo narrativo lineare.", type: "open"},
        {q: "Qual √® la differenza tra musica concreta e musica elettronica?", a: "Musica concreta usa suoni registrati manipolati; elettronica usa suoni sintetizzati elettronicamente.", type: "open"},
        {q: "Descrivi la 'texture micropolifonica' di Ligeti", a: "Densa stratificazione di linee melodiche che creano masse sonore cangianti senza ritmo percepibile.", type: "open"},
        {q: "Cosa significa 'process music' nel minimalismo?", a: "Musica basata su processi gradualmente percepibili come sfasamento o addizione.", type: "open"},
        {q: "Spiega il concetto di 'open form' in musica", a: "Forma aperta dove l'ordine o il contenuto sono determinati dall'esecutore o dal caso.", type: "open"},
        {q: "Cosa sono gli 'harmonic series' nella musica spettrale?", a: "Serie armoniche naturali usate come base per costruire armonia e orchestrazione.", type: "open"},
        {q: "Descrivi la tecnica del 'cloud polyphony'", a: "Sovrapposizione di molte voci indipendenti che creano nuvole sonore senza linee distinguibili.", type: "open"},
        {q: "Qual √® la relazione tra serialismo e numero aureo in Webern?", a: "Webern usava proporzioni del numero aureo per strutturare sezioni e simmetrie seriali.", type: "open"},
        {q: "Descrivi il 'ring modulation' nella sintesi sonora", a: "Modulazione ad anello che moltiplica due segnali creando somme e differenze di frequenze.", type: "open"},
        {q: "Cosa caratterizza il 'New Complexity' di Ferneyhough?", a: "Estrema densit√† notazionale con poliritmia complessa e virtuosismo estremo.", type: "open"},
        {q: "Spiega la 'grafic notation' di Earle Brown", a: "Notazione grafica aperta che lascia interpretazione ritmica e di altezza all'esecutore.", type: "open"},
        {q: "Qual √® la tecnica dell''instrumental synthesis' di Grisey?", a: "Orchestrazione che imita spettri armonici complessi degli strumenti acustici.", type: "open"},
        {q: "Descrivi il 'phasing' di Steve Reich", a: "Tecnica di sfasamento graduale di pattern identici suonati a velocit√† leggermente diverse.", type: "open"},
        {q: "Cosa sono i 'sound masses' di Penderecki?", a: "Cluster di suoni microtonali e texture dense senza altezze distinguibili.", type: "open"},
        {q: "Spiega la 'indeterminacy' di John Cage", a: "Elementi musicali lasciati al caso o a scelta dell'esecutore, eliminando controllo compositivo.", type: "open"},
        {q: "Qual √® la differenza tra 'Klangfarbenmelodie' e orchestrazione tradizionale?", a: "Melodia creata da cambiamenti di timbro invece che di altezza.", type: "open"},
        {q: "Descrivi il 'spatial music' di Stockhausen", a: "Musica che usa movimento del suono nello spazio come parametro compositivo.", type: "open"},
        {q: "Cosa caratterizza la 'New Romanticism' di Del Tredici?", a: "Ritorno a tonalit√† espansiva e melodia lir ica dopo serialismo.", type: "open"},
        {q: "Spiega il 'granular synthesis'", a: "Sintesi basata su grani sonori brevissimi (1-100ms) ricombinati per creare texture.", type: "open"},
        {q: "Qual √® la tecnica della 'saturation' in musica spettrale?", a: "Riempimento completo dello spettro armonico con tutte le parziali.", type: "open"},
        {q: "Descrivi il 'moment form' vs 'linear form'", a: "Forma basata su momenti statici autonomi vs sviluppo narrativo lineare.", type: "open"},
        {q: "Cosa sono le 'Coltrane Changes' applicate alla composizione contemporanea?", a: "Progressioni per terze maggiori usate in contesti orchestrali moderni.", type: "open"},
        {q: "Spiega il 'timbre melody' di Ligeti", a: "Melodia percepita attraverso cambiamenti graduali di colore orchestrale.", type: "open"}
    ]
};

const quizJazz = {
    facile: [
        {q: "Chi √® il 'Re dello Swing'?", o: ["Duke Ellington","Benny Goodman","Count Basie","Glenn Miller"], c: 1},
        {q: "Strumento di Louis Armstrong?", o: ["Sassofono","Tromba","Pianoforte","Clarinetto"], c: 1},
        {q: "Dove nacque il jazz?", o: ["New York","New Orleans","Chicago","Kansas City"], c: 1},
        {q: "Cos'√® lo 'swing'?", o: ["Danza","Sensazione ritmica","Strumento","Compositore"], c: 1},
        {q: "Chi compose 'Take Five'?", o: ["Miles Davis","Paul Desmond","J. Coltrane","D. Brubeck"], c: 1},
        {q: "Chi suonava il sassofono soprano?", o: ["Charlie Parker","John Coltrane","Sonny Rollins","Dexter Gordon"], c: 1},
        {q: "Che tempo ha 'Take Five'?", o: ["4/4","3/4","5/4","6/8"], c: 2},
        {q: "Quale strumento √® tipico del jazz?", o: ["Saxofono","Fagotto","Oboe","Arpa"], c: 0},
        {q: "Chi ha scritto 'Kind of Blue'?", o: ["Miles Davis","John Coltrane","Duke Ellington","Thelonious Monk"], c: 0},
        {q: "Quale pianista jazz √® famoso per le sue composizioni angolari e dissonanti?", o: ["Bill Evans","Thelonious Monk","Oscar Peterson","Herbie Hancock"], c: 1},
        {q: "Chi suonava il vibrafono ed era soprannominato 'Bags'?", o: ["Lionel Hampton","Milt Jackson","Gary Burton","Bobby Hutcherson"], c: 1},
        {q: "Quale sassofonista registr√≤ 'Giant Steps' con cambi armonici rapidissimi?", o: ["Charlie Parker","Sonny Rollins","John Coltrane","Cannonball Adderley"], c: 2},
        {q: "Chi √® la 'First Lady of Song' del jazz?", o: ["Billie Holiday","Ella Fitzgerald","Sarah Vaughan","Nina Simone"], c: 1},
        {q: "Quale trombettista era noto per suonare con la campana verso l'alto?", o: ["Dizzy Gillespie","Clifford Brown","Freddie Hubbard","Lee Morgan"], c: 0},
        {q: "Chi diresse la 'Royal Roost' sessions che definirono il cool jazz?", o: ["Charlie Parker","Miles Davis","Gerry Mulligan","Chet Baker"], c: 1},
        {q: "Quale pianista cieco era famoso per 'Georgia on My Mind'?", o: ["Stevie Wonder","Ray Charles","Art Tatum","George Shearing"], c: 1},
        {q: "Chi suonava il sax contralto ed era chiamato 'Bird'?", o: ["John Coltrane","Charlie Parker","Ornette Coleman","Eric Dolphy"], c: 1},
        {q: "Quale bassista rivoluzion√≤ il jazz con il suo approccio modale?", o: ["Charles Mingus","Scott LaFaro","Paul Chambers","Ron Carter"], c: 1},
        {q: "Chi compose 'A Love Supreme', suite spirituale in quattro parti?", o: ["Miles Davis","John Coltrane","Charles Mingus","Wayne Shorter"], c: 1},
        {q: "Quale pianista registr√≤ l'album 'Kind of Blue' con Miles Davis?", o: ["Herbie Hancock","Bill Evans","McCoy Tyner","Chick Corea"], c: 1},
        {q: "Chi suonava il sax tenore in 'Giant Steps'?", o: ["Sonny Rollins","John Coltrane","Dexter Gordon","Stan Getz"], c: 1},
        {q: "Quale batterista suon√≤ con il Miles Davis Quintet negli anni '60?", o: ["Max Roach","Art Blakey","Tony Williams","Elvin Jones"], c: 2},
        {q: "Chi compose 'Maiden Voyage'?", o: ["Wayne Shorter","Herbie Hancock","Joe Henderson","Bobby Hutcherson"], c: 1},
        {q: "Quale sassofonista suon√≤ con Art Blakey's Jazz Messengers?", o: ["Wayne Shorter","Sonny Rollins","Dexter Gordon","Joe Henderson"], c: 0},
        {q: "Chi registr√≤ 'Moanin'' con i Jazz Messengers?", o: ["Horace Silver","Art Blakey","Charles Mingus","Max Roach"], c: 1},
        {q: "Quale trombettista suon√≤ in 'Birth of the Cool'?", o: ["Clifford Brown","Miles Davis","Chet Baker","Lee Morgan"], c: 1},
        {q: "Chi compose 'Blue Train'?", o: ["John Coltrane","Sonny Rollins","Dexter Gordon","Wayne Shorter"], c: 0},
        {q: "Quale pianista suon√≤ con John Coltrane Quartet?", o: ["Bill Evans","McCoy Tyner","Herbie Hancock","Chick Corea"], c: 1},
        {q: "Chi suonava il contrabbasso con Bill Evans Trio?", o: ["Charles Mingus","Scott LaFaro","Paul Chambers","Ron Carter"], c: 1},
        {q: "Quale sassofonista registr√≤ 'Saxophone Colossus'?", o: ["John Coltrane","Sonny Rollins","Dexter Gordon","Stan Getz"], c: 1},
        {q: "Chi compose 'So What' per Miles Davis?", o: ["Bill Evans","Miles Davis","John Coltrane","Gil Evans"], c: 1},
        {q: "Quale batterista suon√≤ con John Coltrane Quartet?", o: ["Tony Williams","Elvin Jones","Art Blakey","Max Roach"], c: 1},
        {q: "Chi registr√≤ 'Mingus Ah Um'?", o: ["Art Blakey","Charles Mingus","Max Roach","Horace Silver"], c: 1},
        {q: "Quale pianista compose 'Song for My Father'?", o: ["Herbie Hancock","Horace Silver","McCoy Tyner","Bill Evans"], c: 1},
        {q: "Chi suon√≤ il sax alto in 'Somethin' Else' con Cannonball Adderley?", o: ["Charlie Parker","Cannonball Adderley","Art Pepper","Ornette Coleman"], c: 1},
        {q: "Quale pianista registr√≤ 'Waltz for Debby' dal vivo al Village Vanguard?", o: ["Oscar Peterson","Bill Evans","Ahmad Jamal","Wynton Kelly"], c: 1},
        {q: "Chi compose 'Stolen Moments' per Oliver Nelson?", o: ["Wayne Shorter","Oliver Nelson","Freddie Hubbard","Eric Dolphy"], c: 1},
        {q: "Quale trombettista fu chiamato 'The Sidewinder'?", o: ["Freddie Hubbard","Lee Morgan","Donald Byrd","Woody Shaw"], c: 1},
        {q: "Chi suon√≤ l'organo Hammond B3 in 'The Cat'?", o: ["Larry Young","Jimmy Smith","Jack McDuff","Jimmy McGriff"], c: 1},
        {q: "Quale sassofonista registr√≤ 'Speak No Evil'?", o: ["Joe Henderson","Wayne Shorter","Hank Mobley","Dexter Gordon"], c: 1}
    ],
    medio: [
        {q: "Progressione tipica jazz?", o: ["I-IV-V","II-V-I","I-VI-II-V","III-VI-II-V"], c: 1},
        {q: "Cos'√® un 'turnaround'?", o: ["Solo","Progressione ritorno","Cambio tonalit√†","Tecnica ritmica"], c: 1},
        {q: "Qual √® la forma del blues?", o: ["8 battute","12 battute","16 battute","32 battute"], c: 1},
        {q: "Cos'√® un 'tritone substitution'?", o: ["Sostituzione 3 semitoni","Sostituzione 6 semitoni","Sostituzione 4 semitoni","Sostituzione 2 semitoni"], c: 1},
        {q: "Quale scala √® tipicamente usata su un accordo minore 7?", o: ["Lidia","Dorica","Frigia","Misolidia"], c: 1},
        {q: "Cos'√® un accordo 'alt' o 'altered'?", o: ["Dominante con 5a e 9a alterate","Accordo aumentato","Accordo diminuito","Accordo sospeso"], c: 0},
        {q: "Quale armonica usa McCoy Tyner nei suoi voicings?", o: ["Voicings per quarte","Voicings per terze","Voicings chiusi","Voicings stretti"], c: 0},
        {q: "Cos'√® la 'interpolazione' in 'Rhythm changes'?", o: ["Aggiunta di II-V","Cambio metro","Modulazione","Cadenza plagale"], c: 0},
        {q: "Quale modo si usa tipicamente su un accordo V7 alterato?", o: ["Lidio b7","Alterato (superlocrio)","Misolidio","Dorico"], c: 1},
        {q: "Cosa significa 'comping' nel jazz?", o: ["Accompagnamento armonico ritmico","Composizione","Improvvisazione melodica","Trading fours"], c: 0},
        {q: "Quale tecnica armonica caratterizza 'Giant Steps' di Coltrane?", o: ["Ciclo di quinte","Ciclo di terze maggiori","Progressione cromatica","Blues changes"], c: 1},
        {q: "Cos'√® una 'backdoor progression'?", o: ["IV-bVII-I","II-V-I","I-VI-II-V","III-VI-II-V"], c: 0},
        {q: "Quale scala usa Bill Evans su un accordo minore maj7?", o: ["Melodica minore","Dorica","Frigia","Eolia"], c: 0},
        {q: "Cos'√® il 'drop 2 voicing'?", o: ["Seconda nota dall'alto abbassata di un'ottava","Accordo con fondamentale omessa","Voicing per quarte","Accordo sus4"], c: 0},
        {q: "Quale scala si usa su un accordo maj7#11?", o: ["Ionica","Lidia","Misolidia","Dorica"], c: 1},
        {q: "Cos'√® un accordo 'half-diminished'?", o: ["m7b5","dim7","m7","7alt"], c: 0},
        {q: "Quale modo si usa su un accordo minore 7b5?", o: ["Dorico","Locrio","Frigio","Eolico"], c: 1},
        {q: "Cos'√® la 'rhythm section' tipica?", o: ["Piano, basso, batteria","Sax, tromba, trombone","Chitarra, basso, voce","Violino, viola, cello"], c: 0},
        {q: "Quale scala caratterizza il bebop dominante?", o: ["Scala maggiore con b7","Scala dominante con nota di passaggio cromatica","Scala alterata","Scala whole tone"], c: 1},
        {q: "Cos'√® un 'secondary dominant'?", o: ["V/V","V7","IIm7","bVII7"], c: 0},
        {q: "Quale tecnica usa McCoy Tyner per 'quartal voicings'?", o: ["Accordi per terze","Accordi per quarte","Accordi per quinte","Accordi per seste"], c: 1},
        {q: "Cos'√® la 'clave' in musica afro-cubana?", o: ["Pattern ritmico 3-2 o 2-3","Strumento a percussione","Scala particolare","Progressione armonica"], c: 0},
        {q: "Quale accordo si usa in 'Blue Bossa' sul II grado?", o: ["IIm7","IIm7b5","II7","IImaj7"], c: 1},
        {q: "Cos'√® un 'shell voicing'?", o: ["Accordo completo","1-3-7 o 1-7-3","Drop 2","Rootless voicing"], c: 1},
        {q: "Quale scala si usa su un accordo V7#5#9?", o: ["Whole tone","Alterata","Lidia b7","Misolidia"], c: 1},
        {q: "Cos'√® la 'interpolation' in 'Stella by Starlight'?", o: ["Aggiunta di II-V","Modulazione","Sostituzione tritonica","Cadenza plagale"], c: 0},
        {q: "Quale voicing usa Bill Evans in 'rootless voicings'?", o: ["3-5-7-9","1-3-5-7","3-6-7-9","5-7-9-11"], c: 2},
        {q: "Cos'√® un 'approach note' nel bebop?", o: ["Nota cromatica o diatonica prima del target","Appoggiatura","Mordente","Acciaccatura"], c: 0},
        {q: "Quale scala si usa su un accordo 7sus4?", o: ["Dorica","Misolidia","Frigia","Lidia"], c: 1},
        {q: "Cos'√® il 'chord tone targeting'?", o: ["Risolvere su note dell'accordo","Evitare terza e settima","Usare solo pentatoniche","Suonare outside"], c: 0},
        {q: "Quale progressione caratterizza 'Autumn Leaves'?", o: ["IIm7-V7-Imaj7","IIm7b5-V7-Im","IVmaj7-V7-IIIm7","VIm7-IIm7-V7"], c: 0},
        {q: "Quale scala si usa su un accordo diminuito?", o: ["Diminuita whole-half","Diminuita half-whole","Whole tone","Lidia b7"], c: 1},
        {q: "Cos'√® la 'blue note' nella scala blues?", o: ["b3, b5, b7","#4, b6","#9, b9","b2, #4"], c: 0},
        {q: "Quale modo si usa su un accordo IVmaj7?", o: ["Ionico","Lidio","Misolidio","Dorico"], c: 1},
        {q: "Cos'√® un accordo 'sus2'?", o: ["1-2-5","1-3-5","1-4-5","1-2-3"], c: 0},
        {q: "Quale tecnica usa Wes Montgomery per gli assoli?", o: ["Fingerstyle","Octaves (ottave)","Tapping","Sweep picking"], c: 1}
    ],
    avanzato: [
        {q: "Analizza le Coltrane Changes", a: "Progressione armonica per terze maggiori usando cicli con sostituzioni tritonali.", type: "open"},
        {q: "Cos'√® un 'line clich√©'?", a: "Linea cromatica discendente o ascendente dentro un accordo statico.", type: "open"},
        {q: "Spiega il concetto di 'modal jazz'", a: "Jazz basato su modi/scale invece che progressioni armoniche complesse.", type: "open"},
        {q: "Cos'√® l'armonia jazz?", o: ["L'arte di combinare suoni con accordi complessi e alterati","Un tipo di danza","Un effetto elettronico","Un ballo popolare"], c: 0},
        {q: "Spiega il reharmonization tramite 'constant structure'", a: "Tecnica di spostare lo stesso voicing per gradi cromatici o diatonici mantenendo la struttura.", type: "open"},
        {q: "Descrivi la tecnica del 'side-slipping'", a: "Spostamento cromatico temporaneo di una frase mezzo tono sopra o sotto per creare tensione.", type: "open"},
        {q: "Cosa sono le 'upper structure triads'?", a: "Triadi costruite sulla 9a, 11a o 13a di un accordo di dominante per creare tensioni.", type: "open"},
        {q: "Spiega il concetto di 'chord-scale relationship'", a: "Associazione di scale specifiche a ogni tipo di accordo per l'improvvisazione.", type: "open"},
        {q: "Cosa caratterizza l'approccio 'outside' di Eric Dolphy?", a: "Uso di intervalli ampi, cromatismi e note estranee all'armonia per creare tensione.", type: "open"},
        {q: "Descrivi la tecnica del 'rhythmic displacement'", a: "Spostamento di una frase ritmica in avanti o indietro rispetto al battere originale.", type: "open"},
        {q: "Qual √® la funzione della scala 'bebop' dominante?", a: "Scala con nota di passaggio cromatica che permette di iniziare accordi sul battere.", type: "open"},
        {q: "Spiega il concetto di 'interpolation' nei Rhythm Changes", a: "Aggiunta di progressioni II-V che collegano gli accordi della forma originale.", type: "open"},
        {q: "Cosa sono i 'polychords' nell'armonia moderna?", a: "Sovrapposizione di due accordi diversi suonati simultaneamente per creare cluster armonici.", type: "open"},
        {q: "Descrivi la tecnica del 'motivic development' di Sonny Rollins", a: "Sviluppo tematico dove un breve motivo viene variato ritmicamente e armonicamente nel solo.", type: "open"},
        {q: "Spiega il 'diminished scale' su accordi dominanti", a: "Scala simmetrica semitono-tono o tono-semitono usata su V7b9 per tensioni.", type: "open"},
        {q: "Cos'√® il 'linear chromaticism' di Charlie Parker?", a: "Approccio cromatico lineare dove note cromatiche connettono chord tones.", type: "open"},
        {q: "Descrivi il 'substitute chord' per V7", a: "bII7 (tritone substitution) condivide tritono con V7 permettendo risoluzione cromatica.", type: "open"},
        {q: "Qual √® la funzione della 'Coltrane Matrix'?", a: "Sistema di sostituzioni armoniche basato su divisioni simmetriche dell'ottava.", type: "open"},
        {q: "Spiega il 'pentatonic pairs' di Michael Brecker", a: "Sovrapposizione di due scale pentatoniche per creare tensioni su accordi dominanti.", type: "open"},
        {q: "Cosa caratterizza il 'displacement' ritmico di Herbie Hancock?", a: "Spostamento di frasi su battiti deboli creando tensione metrica.", type: "open"},
        {q: "Descrivi la tecnica del 'hexatonic' system", a: "Scala di sei note usata per collegare accordi maggiori e minori distanti terza minore.", type: "open"},
        {q: "Qual √® il 'tritone substitution' esteso?", a: "Sostituzione di intera progressione II-V con bII-bV.", type: "open"},
        {q: "Spiega il 'Barry Harris' sixth diminished scale", a: "Sistema che aggiunge sesta maggiore alla scala diminuita per movimento cromatico.", type: "open"},
        {q: "Cosa sono i 'Guide Tones' nell'improvvisazione?", a: "Terza e settima degli accordi che guidano il movimento armonico.", type: "open"},
        {q: "Descrivi il 'superimposition' armonico", a: "Suonare progressione diversa sopra quella esistente creando polychords.", type: "open"},
        {q: "Qual √® la tecnica del 'tri-tone relationship'?", a: "Sfruttare relazione tritonica tra V7 e bII7 per sostituzioni.", type: "open"},
        {q: "Spiega il 'modal interchange' nel jazz", a: "Prendere in prestito accordi da scale parallele (maggiore/minore).", type: "open"},
        {q: "Cosa caratterizza il 'quartal harmony' di McCoy Tyner?", a: "Voicings costruiti per intervalli di quarta invece che per terze.", type: "open"},
        {q: "Descrivi la 'negative harmony' applicata al jazz", a: "Inversione speculare di progressioni attorno all'asse tonica-dominante.", type: "open"}
    ]
};

const quizClassica = {
    facile: [
        {q: "Note della triade maggiore?", o: ["Due","Tre","Quattro","Cinque"], c: 1},
        {q: "Nome del primo grado?", o: ["Dominante","Tonica","Mediante","Sottodominante"], c: 1},
        {q: "Qual √® il quinto grado?", o: ["Tonica","Dominante","Mediante","Sopradominante"], c: 1},
        {q: "Quante note ha la scala maggiore?", o: ["5","6","7","8"], c: 2},
        {q: "Cos'√® un accordo diminuito?", o: ["1-3b-5b","1-3-5","1-3-5#","1-3b-5"], c: 0},
        {q: "Chi ha composto la 'Nona Sinfonia'?", o: ["Wolfgang Amadeus Mozart","Ludwig van Beethoven","Antonio Vivaldi","Franz Schubert"], c: 1},
        {q: "Quale strumento suonava Niccol√≤ Paganini?", o: ["Violino","Tromba","Organo","Fagotto"], c: 0},
        {q: "Chi ha composto 'Le Quattro Stagioni'?", o: ["Antonio Vivaldi","Gioachino Rossini","Giuseppe Verdi","B√©la Bart√≥k"], c: 0},
        {q: "Quale strumento ha i tasti bianchi e neri?", o: ["Violino","Pianoforte","Trombone","Oboe"], c: 1},
        {q: "Cos'√® un'orchestra?", o: ["Un gruppo di quattro musicisti","Un grande gruppo di musicisti con vari strumenti","Un solo musicista","Un duo di chitarre"], c: 1},
        {q: "Chi √® il compositore della 'Turandot'?", o: ["Giacomo Puccini","Giuseppe Verdi","Richard Wagner","Georges Bizet"], c: 0},
        {q: "Quale strumento si suona soffiando e ha un'ancia?", o: ["Clarinetto","Violoncello","Timpano","Chitarra"], c: 0},
        {q: "Chi ha composto 'Il flauto magico'?", o: ["Ludwig van Beethoven","Wolfgang Amadeus Mozart","Franz Liszt","Gustav Mahler"], c: 1},
        {q: "Quale strumento si accorda con le chiavi di accordatura?", o: ["Pianoforte","Tromba","Flauto traverso","Maracas"], c: 0},
        {q: "Cos'√® l'armonia?", o: ["L'arte di combinare pi√π suoni simultaneamente","Un tipo di danza","Un effetto per chitarra","Un genere musicale"], c: 0},
        {q: "Quale strumento ha corde e si suona pizzicandole?", o: ["Arpa","Trombone","Oboe","Timpano"], c: 0},
        {q: "Chi ha scritto 'La Traviata'?", o: ["Giuseppe Verdi","Giacomo Puccini","Richard Wagner","Antonio Salieri"], c: 0},
        {q: "Cos'√® un pentagramma?", o: ["Un insieme di cinque linee per scrivere la musica","Un tipo di chitarra","Un ballo popolare","Un effetto elettronico"], c: 0},
        {q: "Quale strumento si suona con un archetto?", o: ["Violino","Tromba","Pianoforte","Clarinetto"], c: 0},
        {q: "Chi ha scritto 'Carmen'?", o: ["Georges Bizet","Giuseppe Verdi","Richard Wagner","Giacomo Puccini"], c: 0},
        {q: "Cos'√® un metronomo?", o: ["Uno strumento per tenere il tempo","Un tipo di tromba","Un microfono","Un effetto per chitarra"], c: 0},
        {q: "Chi ha composto 'Il lago dei cigni'?", o: ["P√´tr Il'iƒç ƒåajkovskij","Sergej Prokof'ev","Igor Stravinsky","Modest Musorgskij"], c: 0},
        {q: "Quale strumento √® a fiato?", o: ["Oboe","Violoncello","Arpa","Timpano"], c: 0},
        {q: "Chi ha scritto 'La Boh√®me'?", o: ["Giacomo Puccini","Giuseppe Verdi","Richard Wagner","Georges Bizet"], c: 0},
        {q: "Cos'√® un accordo?", o: ["Tre o pi√π suoni suonati insieme","Un tipo di danza","Un effetto per chitarra","Un microfono"], c: 0},
        {q: "Chi ha composto 'Il carnevale degli animali'?", o: ["Camille Saint-Sa√´ns","Claude Debussy","Maurice Ravel","Paul Dukas"], c: 0},
        {q: "Quale strumento ha le corde pi√π gravi in orchestra?", o: ["Contrabbasso","Violino","Viola","Chitarra"], c: 0},
        {q: "Chi ha scritto 'Il Requiem' (K.626)?", o: ["Wolfgang Amadeus Mozart","Ludwig van Beethoven","Franz Schubert","Joseph Haydn"], c: 0},
        {q: "Cos'√® un tema musicale?", o: ["Una melodia principale","Un tipo di strumento","Un effetto elettronico","Un ballo popolare"], c: 0},
        {q: "Quale strumento si suona con le bacchette?", o: ["Timpano","Violino","Tromba","Clarinetto"], c: 0},
        {q: "Cos'√® una sinfonia?", o: ["Una composizione orchestrale in pi√π movimenti","Un tipo di chitarra","Un effetto elettronico","Un ballo popolare"], c: 0},
        {q: "Quale compositore romantico mor√¨ a soli 31 anni di tubercolosi?", o: ["Franz Schubert","Fr√©d√©ric Chopin","Felix Mendelssohn","Robert Schumann"], c: 1},
        {q: "Chi compose 'L'Apprenti sorcier' (L'apprendista stregone)?", o: ["Claude Debussy","Maurice Ravel","Paul Dukas","Erik Satie"], c: 2},
        {q: "Quale compositore scrisse 'Gymnop√©dies', pezzi minimalisti per pianoforte?", o: ["Claude Debussy","Erik Satie","Maurice Ravel","Gabriel Faur√©"], c: 1},
        {q: "Chi compose l'opera 'Orfeo ed Euridice' nel periodo classico?", o: ["Christoph Willibald Gluck","Wolfgang Amadeus Mozart","Joseph Haydn","Antonio Salieri"], c: 0},
        {q: "Quale strumento √® protagonista nel 'Concerto Brandeburghese n. 5' di Bach?", o: ["Violino","Clavicembalo","Tromba","Flauto"], c: 1},
        {q: "Chi scrisse 'Pictures at an Exhibition', poi orchestrato da Ravel?", o: ["Alexander Borodin","Modest Musorgskij","Nikolaj Rimskij-Korsakov","P√´tr Il'iƒç ƒåajkovskij"], c: 1},
        {q: "Quale compositore barocco era noto come 'Il Prete Rosso'?", o: ["Johann Sebastian Bach","Antonio Vivaldi","Georg Friedrich H√§ndel","Arcangelo Corelli"], c: 1},
        {q: "Chi compose 'Danse macabre', poema sinfonico sulla morte?", o: ["Hector Berlioz","Camille Saint-Sa√´ns","Franz Liszt","Richard Strauss"], c: 1},
        {q: "Quale compositore scrisse 'The Firebird' (L'uccello di fuoco)?", o: ["Sergej Prokof'ev","Igor Stravinsky","Dmitrij ≈†ostakoviƒç","Aram Khachaturian"], c: 1},
        {q: "Chi compose la famosa 'Toccata e Fuga in re minore' per organo?", o: ["Johann Sebastian Bach","Dietrich Buxtehude","Johann Pachelbel","Georg Friedrich H√§ndel"], c: 0},
        {q: "Quale compositore scrisse 'Peer Gynt'?", o: ["Jean Sibelius","Edvard Grieg","Carl Nielsen","Johan Svendsen"], c: 1},
        {q: "Chi compose 'Nessun dorma' dall'opera Turandot?", o: ["Giuseppe Verdi","Giacomo Puccini","Ruggero Leoncavallo","Pietro Mascagni"], c: 1},
        {q: "Quale compositore scrisse 'Finlandia'?", o: ["Edvard Grieg","Jean Sibelius","Carl Nielsen","Johan Halvorsen"], c: 1},
        {q: "Chi compose 'Nabucco' con il coro 'Va, pensiero'?", o: ["Gaetano Donizetti","Giuseppe Verdi","Vincenzo Bellini","Gioachino Rossini"], c: 1},
        {q: "Quale compositore scrisse 'Pavane pour une infante d√©funte'?", o: ["Claude Debussy","Maurice Ravel","Erik Satie","Gabriel Faur√©"], c: 1},
        {q: "Chi compose 'Scheherazade'?", o: ["Modest Musorgskij","Nikolaj Rimskij-Korsakov","P√´tr Il'iƒç ƒåajkovskij","Alexander Borodin"], c: 1},
        {q: "Quale compositore scrisse 'La Mer' (Il mare)?", o: ["Maurice Ravel","Claude Debussy","Erik Satie","Paul Dukas"], c: 1},
        {q: "Chi compose 'Il Messia' con l'Hallelujah?", o: ["Johann Sebastian Bach","Georg Friedrich H√§ndel","Henry Purcell","Antonio Vivaldi"], c: 1},
        {q: "Quale compositore scrisse 'Adagio for Strings'?", o: ["Aaron Copland","Samuel Barber","Leonard Bernstein","George Gershwin"], c: 1},
        {q: "Chi compose 'Rhapsody in Blue'?", o: ["Aaron Copland","George Gershwin","Leonard Bernstein","Charles Ives"], c: 1},
        {q: "Quale compositore scrisse 'Carmina Burana'?", o: ["Gustav Holst","Carl Orff","Paul Hindemith","Kurt Weill"], c: 1},
        {q: "Chi compose 'The Planets'?", o: ["Ralph Vaughan Williams","Gustav Holst","Edward Elgar","Benjamin Britten"], c: 1},
        {q: "Quale compositore scrisse 'Enigma Variations'?", o: ["Ralph Vaughan Williams","Edward Elgar","Gustav Holst","Frederick Delius"], c: 1},
        {q: "Chi compose 'Fantasia on a Theme by Thomas Tallis'?", o: ["Edward Elgar","Ralph Vaughan Williams","Gustav Holst","Benjamin Britten"], c: 1},
        {q: "Quale compositore scrisse 'Appalachian Spring'?", o: ["George Gershwin","Aaron Copland","Leonard Bernstein","Samuel Barber"], c: 1},
        {q: "Chi compose 'Peter and the Wolf'?", o: ["Dmitrij ≈†ostakoviƒç","Sergej Prokof'ev","Igor Stravinsky","Aram Khachaturian"], c: 1},
        {q: "Quale compositore scrisse 'M√° vlast' (La mia patria)?", o: ["Anton√≠n Dvo≈ô√°k","Bed≈ôich Smetana","Leo≈° Jan√°ƒçek","Bohuslav Martin≈Ø"], c: 1}
    ],
    medio: [
        {q: "Cos'√® la sesta napoletana?", o: ["Sesta aumentata","bII in rivolto","Accordo diminuito","Dominante"], c: 1},
        {q: "Cos'√® la sesta aumentata?", o: ["9 semitoni","Accordo cromatico predominante","Accordo maggiore","Modulazione"], c: 1},
        {q: "Funzione della dominante secondaria?", o: ["Tonicizza V","Tonicizza altri gradi","Solo decorazione","Modulazione"], c: 1},
        {q: "Cos'√® un quartetto d'archi?", o: ["Quattro pianoforti","Due violini, una viola, un violoncello","Quattro trombe","Tre clarinetti e un oboe"], c: 1},
        {q: "Chi ha composto 'La Moldava'?", o: ["Bed≈ôich Smetana","Anton√≠n Dvo≈ô√°k","Gustav Mahler","Jean Sibelius"], c: 0},
        {q: "Chi ha composto 'Sinfonia dal Nuovo Mondo'?", o: ["Anton√≠n Dvo≈ô√°k","Gustav Mahler","Jean Sibelius","Bed≈ôich Smetana"], c: 0},
        {q: "Chi ha scritto 'Il Barbiere di Siviglia'?", o: ["Gioachino Rossini","Giuseppe Verdi","Gaetano Donizetti","Vincenzo Bellini"], c: 0},
        {q: "Quale strumento √® protagonista nel 'Concerto per clarinetto' di Mozart?", o: ["Clarinetto","Violino","Tromba","Pianoforte"], c: 0},
        {q: "Chi ha scritto 'La Mer'?", o: ["Claude Debussy","Maurice Ravel","Erik Satie","Paul Dukas"], c: 0},
        {q: "Cos'√® un glissando?", o: ["Uno scivolamento continuo tra due note","Un tipo di danza","Un effetto elettronico","Un ballo popolare"], c: 0},
        {q: "Chi ha composto 'Sinfonia n. 5' con il celebre motivo 'ta-ta-ta-taaa'?", o: ["Ludwig van Beethoven","Wolfgang Amadeus Mozart","Franz Schubert","Joseph Haydn"], c: 0},
        {q: "Quale strumento √® protagonista nel 'Concerto per violino' di Mendelssohn?", o: ["Violino","Pianoforte","Tromba","Clarinetto"], c: 0},
        {q: "Chi ha composto 'Sinfonia n. 9' detta 'Dal nuovo mondo'?", o: ["Anton√≠n Dvo≈ô√°k","Gustav Mahler","Jean Sibelius","Bed≈ôich Smetana"], c: 0},
        {q: "Quale strumento √® protagonista nel 'Concerto per pianoforte n. 2' di Rachmaninov?", o: ["Pianoforte","Violino","Tromba","Clarinetto"], c: 0},
        {q: "Quale compositore scrisse 'Il castello del principe Barbabl√π'?", o: ["B√©la Bart√≥k","Zolt√°n Kod√°ly","Gy√∂rgy Ligeti","Franz Liszt"], c: 0},
        {q: "Cos'√® una 'cadenza piccarda' o 'di Piccardia'?", o: ["Cadenza con terza maggiore in modo minore","Cadenza plagale","Cadenza sospesa","Cadenza d'inganno"], c: 0},
        {q: "Chi compose le '4 Ballate' per pianoforte solo?", o: ["Franz Liszt","Fr√©d√©ric Chopin","Robert Schumann","Johannes Brahms"], c: 1},
        {q: "Quale opera di Wagner dura circa 15 ore in totale?", o: ["Parsifal","Tristan und Isolde","Der Ring des Nibelungen","Die Meistersinger"], c: 2},
        {q: "Cosa caratterizza il 'Lied' tedesco romantico?", o: ["Canzone per voce e pianoforte","Forma sinfonica","Danza barocca","Forma operistica"], c: 0},
        {q: "Chi scrisse la 'Sinfonia n. 8' detta 'Incompiuta' con solo 2 movimenti?", o: ["Franz Schubert","Anton Bruckner","Gustav Mahler","Anton√≠n Dvo≈ô√°k"], c: 0},
        {q: "Quale compositore us√≤ il leitmotiv nelle sue opere?", o: ["Giuseppe Verdi","Richard Wagner","Giacomo Puccini","Georges Bizet"], c: 1},
        {q: "Cosa sono i 'Preludi e Fughe' del 'Clavicembalo ben temperato'?", o: ["48 pezzi in tutte le tonalit√†","24 pezzi in modo maggiore","12 pezzi cromatici","36 studi tecnici"], c: 0},
        {q: "Chi compose 'Also sprach Zarathustra', reso famoso dal film 2001?", o: ["Gustav Mahler","Richard Strauss","Anton Bruckner","Johannes Brahms"], c: 1},
        {q: "Quale forma musicale ha schema ABACA?", o: ["Sonata","Rond√≤","Tema con variazioni","Fuga"], c: 1},
        {q: "Quale compositore scrisse 'Sinfonia n. 41' detta 'Jupiter'?", o: ["Joseph Haydn","Wolfgang Amadeus Mozart","Ludwig van Beethoven","Franz Schubert"], c: 1},
        {q: "Chi compose 'Konzert f√ºr Orchester' (Concerto per orchestra)?", o: ["Gy√∂rgy Ligeti","B√©la Bart√≥k","Zolt√°n Kod√°ly","Witold Lutos≈Çawski"], c: 1},
        {q: "Quale opera di Mahler include 'Urlicht' (Luce primordiale)?", o: ["Sinfonia n. 1","Sinfonia n. 2","Sinfonia n. 3","Sinfonia n. 5"], c: 1},
        {q: "Chi scrisse 'Kindertotenlieder' (Canti per bambini morti)?", o: ["Richard Strauss","Gustav Mahler","Hugo Wolf","Anton Bruckner"], c: 1},
        {q: "Quale compositore scrisse 'Ein deutsches Requiem'?", o: ["Franz Schubert","Johannes Brahms","Robert Schumann","Felix Mendelssohn"], c: 1},
        {q: "Chi compose 'Variations on a Theme by Haydn'?", o: ["Robert Schumann","Johannes Brahms","Felix Mendelssohn","Franz Liszt"], c: 1},
        {q: "Quale opera di Strauss si basa su 'Don Quixote'?", o: ["Don Juan","Don Quixote","Till Eulenspiegel","Ein Heldenleben"], c: 1},
        {q: "Chi scrisse 'Les Pr√©ludes', poema sinfonico?", o: ["Hector Berlioz","Franz Liszt","Richard Wagner","C√©sar Franck"], c: 1},
        {q: "Quale compositore scrisse 'Symphonie fantastique'?", o: ["Franz Liszt","Hector Berlioz","Richard Strauss","C√©sar Franck"], c: 1},
        {q: "Chi compose 'Harold en Italie' per viola e orchestra?", o: ["Franz Liszt","Hector Berlioz","Niccol√≤ Paganini","Carl Maria von Weber"], c: 1},
        {q: "Quale opera di Bruckner √® detta 'Romantic'?", o: ["Sinfonia n. 3","Sinfonia n. 4","Sinfonia n. 7","Sinfonia n. 9"], c: 1},
        {q: "Chi scrisse 'Verkl√§rte Nacht' (Notte trasfigurata)?", o: ["Gustav Mahler","Arnold Schoenberg","Alban Berg","Anton Webern"], c: 1},
        {q: "Quale compositore scrisse 'Gurre-Lieder'?", o: ["Gustav Mahler","Arnold Schoenberg","Richard Strauss","Alexander Zemlinsky"], c: 1},
        {q: "Chi compose 'Turangal√Æla-Symphonie'?", o: ["Pierre Boulez","Olivier Messiaen","Maurice Ravel","Darius Milhaud"], c: 1},
        {q: "Quale opera di Debussy si basa su un poema di Mallarm√©?", o: ["La Mer","Pr√©lude √† l'apr√®s-midi d'un faune","Nocturnes","Pell√©as et M√©lisande"], c: 1},
        {q: "Chi scrisse 'Daphnis et Chlo√©'?", o: ["Claude Debussy","Maurice Ravel","Erik Satie","Paul Dukas"], c: 1},
        {q: "Quale compositore scrisse 'Ma m√®re l'Oye'?", o: ["Claude Debussy","Maurice Ravel","Gabriel Faur√©","Camille Saint-Sa√´ns"], c: 1}
    ],
    avanzato: [
        {q: "Spiega la modulazione per note comuni", a: "Modulazione tramite accordi pivot che condividono note tra due tonalit√†.", type: "open"},
        {q: "Funzione della sesta napoletana", a: "Accordo di bII in rivolto con funzione predominante verso V.", type: "open"},
        {q: "Descrivi una cadenza d'inganno", a: "Risoluzione V-VI invece della prevista V-I, creando sorpresa armonica.", type: "open"},
        {q: "Chi ha scritto 'Sinfonia n. 3' detta 'Eroica'?", o: ["Ludwig van Beethoven","Wolfgang Amadeus Mozart","Franz Schubert","Joseph Haydn"], c: 0},
        {q: "Chi ha scritto 'Sinfonia n. 6' detta 'Pastorale'?", o: ["Ludwig van Beethoven","Wolfgang Amadeus Mozart","Franz Schubert","Joseph Haydn"], c: 0},
        {q: "Chi ha scritto 'Sinfonia n. 8' detta 'Incompiuta'?", o: ["Franz Schubert","Ludwig van Beethoven","Wolfgang Amadeus Mozart","Joseph Haydn"], c: 0},
        {q: "Chi ha composto 'Sinfonia n. 9' detta 'Corale'?", o: ["Ludwig van Beethoven","Wolfgang Amadeus Mozart","Franz Schubert","Joseph Haydn"], c: 0},
        {q: "Quale strumento √® protagonista nel 'Concerto per violoncello' di Dvo≈ô√°k?", o: ["Violoncello","Pianoforte","Tromba","Clarinetto"], c: 0},
        {q: "Chi ha scritto 'Sinfonia n. 5' di Mahler?", o: ["Gustav Mahler","Anton Bruckner","Richard Strauss","Jean Sibelius"], c: 0},
        {q: "Chi ha composto 'Sinfonia n. 1' detta 'Titan'?", o: ["Gustav Mahler","Anton Bruckner","Richard Strauss","Jean Sibelius"], c: 0},
        {q: "Chi ha composto 'Sinfonia n. 2' di Brahms?", o: ["Johannes Brahms","Robert Schumann","Felix Mendelssohn","Franz Schubert"], c: 0},
        {q: "Quale strumento √® protagonista nel 'Concerto per tromba' di Haydn?", o: ["Tromba","Violino","Pianoforte","Clarinetto"], c: 0},
        {q: "Chi ha scritto 'Sinfonia n. 4' di Tchaikovsky?", o: ["P√´tr Il'iƒç ƒåajkovskij","Sergej Prokof'ev","Dmitrij ≈†ostakoviƒç","B√©la Bart√≥k"], c: 0},
        {q: "Chi ha composto 'Sinfonia n. 6' di ƒåajkovskij?", o: ["P√´tr Il'iƒç ƒåajkovskij","Sergej Prokof'ev","Dmitrij ≈†ostakoviƒç","B√©la Bart√≥k"], c: 0},
        {q: "Spiega la differenza tra sesta italiana, francese e tedesca", a: "Tre tipi di seste aumentate: italiana (1-3-#6), francese (+4), tedesca (+5b).", type: "open"},
        {q: "Cosa caratterizza una fuga a 4 voci rispetto a una a 3?", a: "Maggiore densit√† contrappuntistica e possibilit√† di stretto pi√π complesso.", type: "open"},
        {q: "Descrivi la forma sonata-rond√≤", a: "Forma ibrida che combina elementi del rond√≤ (ritornelli) con sviluppo sonatistico.", type: "open"},
        {q: "Qual √® la funzione dell'accordo di sesta napoletana?", a: "Accordo cromatico predominante (bII6) che prepara la dominante con forte tensione.", type: "open"},
        {q: "Spiega il 'contrappunto invertibile' alla decima", a: "Contrappunto che funziona quando le voci vengono invertite a distanza di decima.", type: "open"},
        {q: "Cosa sono i 'toni di chiesa' o modi ecclesiastici?", a: "Sistema modale medievale con otto modi (dorico, frigio, lidio, misolidio e plagali).", type: "open"},
        {q: "Descrivi la tecnica del 'pedale armonico'", a: "Nota tenuta mentre l'armonia cambia sopra, creando dissonanze e risoluzioni.", type: "open"},
        {q: "Qual √® la struttura della 'passacaglia'?", a: "Forma con basso ostinato ripetuto su cui si costruiscono variazioni continue.", type: "open"},
        {q: "Spiega il 'contrappunto doppio' o 'invertibile'", a: "Contrappunto dove le voci possono essere scambiate mantenendo correttezza armonica.", type: "open"},
        {q: "Cosa caratterizza la 'forma ciclica' nelle opere romantiche?", a: "Uso di temi ricorrenti trasformati attraverso i movimenti dell'opera.", type: "open"},
        {q: "Descrivi la 'tecnica dello sviluppo motivico' in Beethoven", a: "Elaborazione di brevi motivi attraverso variazione, frammentazione e ricombinazione.", type: "open"},
        {q: "Qual √® la funzione della 'cadenza plagale'?", a: "Cadenza IV-I con carattere modale e contemplativo, usata spesso nelle chiusure.", type: "open"},
        {q: "Spiega il 'contrappunto fiorito'", a: "Contrappunto con valori ritmici variati e ornamentazioni tra le voci.", type: "open"},
        {q: "Cosa caratterizza la 'fugato' vs 'fuga' vera?", a: "Fugato √® episodio fugato dentro forma pi√π ampia, non indipendente come fuga.", type: "open"},
        {q: "Descrivi l''accordo di settima diminuita'", a: "Accordo simmetrico con tre terze minori, funzione di dominante alterata.", type: "open"},
        {q: "Qual √® la tecnica dell''enarmonia' in modulazione?", a: "Reinterpretazione enarmonica di un accordo per modulare a tonalit√† lontane.", type: "open"},
        {q: "Spiega il 'canone cancrizante'", a: "Canone dove seconda voce suona tema al contrario (retrogrado).", type: "open"},
        {q: "Cosa caratterizza la 'variazione ornamentale'?", a: "Variazione che mantiene armonia base aggiungendo ornamenti melodici.", type: "open"},
        {q: "Descrivi la 'texture omofo nica' vs 'polifonica'", a: "Omofonica: melodia con accompagnamento; polifonica: voci indipendenti di uguale importanza.", type: "open"},
        {q: "Qual √® la funzione della 'dominante preparata'?", a: "Uso di IV o II prima della dominante per rafforzare approccio alla tonica.", type: "open"},
        {q: "Spiega il 'tema con variazioni' barocco", a: "Forma con tema iniziale seguito da variazioni che mantengono basso o armonia.", type: "open"},
        {q: "Cosa caratterizza la 'sinfonia concertante'?", a: "Forma orchestrale con pi√π solisti in dialogo, tra concerto e sinfonia.", type: "open"},
        {q: "Descrivi il 'recitativo accompagnato' vs 'secco'", a: "Accompagnato ha orchestra; secco solo continuo, pi√π declamatorio.", type: "open"},
        {q: "Qual √® la tecnica della 'stretto' nella fuga?", a: "Entrate ravvicinate del soggetto sovrapposte prima della conclusione normale.", type: "open"},
        {q: "Spiega la 'risoluzione eccezionale' della dominante", a: "Dominante che risolve su accordo diverso dalla tonica (es. VI, IV).", type: "open"}
    ]
};

const curiositaGAS = [
    {title: "Mozart e il Canone Scurrile", text: "Mozart compose un canone intitolato 'Leck mich im Arsch' ('Leccami il...') per divertire i suoi amici aristocratici.", readingTime: 25},
    {title: "Berlioz sotto Oppio", text: "Hector Berlioz scrisse la 'Symphonie Fantastique' sotto l'effetto dell'oppio.", readingTime: 20},
    {title: "La Testa Rubata di Haydn", text: "Joseph Haydn fu sepolto senza la testa: fu trafugata da collezionisti di teschi e restituita solo nel 1954.", readingTime: 25},
    {title: "Il Theremin Magico", text: "Il theremin √® uno strumento che si suona senza toccarlo, usando solo il movimento delle mani nell'aria.", readingTime: 23},
    {title: "Strauss e il Copyright", text: "Richard Strauss fu citato in tribunale per aver usato 'Funicul√¨ Funicul√†' credendola una canzone popolare, mentre era protetta da copyright.", readingTime: 28},
    {title: "Mozart Poliglotta", text: "Mozart era poliglotta: parlava fluentemente almeno 12 lingue.", readingTime: 18},
    {title: "Rossini il Pigro", text: "Gioachino Rossini era cos√¨ pigro che compose l''Ouverture' del 'Barbiere di Siviglia' riciclando materiale da altre sue opere.", readingTime: 26},
    {title: "Beethoven Sordo Dirige", text: "Beethoven, ormai sordo, dirigeva la 'Nona Sinfonia' senza sentire una nota, affidandosi solo alla memoria e alla vista dei musicisti.", readingTime: 28},
    {title: "Il Primo Pianoforte", text: "Il primo pianoforte fu inventato da Bartolomeo Cristofori a Padova nel 1700.", readingTime: 20},
    {title: "Edith Piaf 'Passerotto'", text: "Edith Piaf deve il suo nome d'arte al termine francese 'piaf', che significa 'passerotto', per la sua statura minuta e la voce potente.", readingTime: 26},
    {title: "Keith Richards e Satisfaction", text: "Keith Richards dei Rolling Stones ha scritto il riff di '(I Can't Get No) Satisfaction' nel sonno e lo ha registrato appena sveglio.", readingTime: 27},
    {title: "Black Sabbath e Mario Bava", text: "Il nome 'Black Sabbath' deriva da un film horror italiano di Mario Bava.", readingTime: 20},
    {title: "Mozart Bambino Prodigio", text: "Mozart compose la sua prima sinfonia a 8 anni.", readingTime: 15},
    {title: "4'33'' - Il Silenzio di Cage", text: "Il brano '4'33''' di John Cage √® composto solo da silenzio: l'esecutore non suona nulla per 4 minuti e 33 secondi.", readingTime: 25},
    {title: "Mozart e il Clarinetto", text: "Il clarinetto fu uno degli strumenti preferiti da Mozart, che gli dedic√≤ un concerto e un quintetto.", readingTime: 23},
    {title: "L'Elvis del Banjo", text: "Il banjo a 5 corde fu reso popolare da Joel Walker Sweeney, considerato l'Elvis Presley dell'Ottocento.", readingTime: 24},
    {title: "Stratocaster da Record", text: "La chitarra pi√π costosa mai venduta √® una Fender Stratocaster appartenuta a David Gilmour dei Pink Floyd, battuta all'asta per oltre 3 milioni di dollari.", readingTime: 30},
    {title: "Theremin Spaziale", text: "Il theremin fu usato per la colonna sonora di molti film di fantascienza degli anni '50.", readingTime: 22},
    {title: "Bach Arrestato", text: "Bach fu arrestato per 'testardaggine' e insubordinazione verso il suo datore di lavoro.", readingTime: 21},
    {title: "Chopin in Penombra", text: "Chopin suonava il pianoforte solo in penombra e con pochi intimi presenti.", readingTime: 20},
    {title: "Dies Irae Immortale", text: "Il 'Dies Irae' gregoriano √® stato citato in centinaia di colonne sonore e opere classiche.", readingTime: 22},
    {title: "Hindemith e le Cene Musicali", text: "Il compositore Paul Hindemith organizzava cene in cui gli ospiti dovevano portare strumenti a caso, anche se non li sapevano suonare, e componeva per loro un pezzo improvvisato.", readingTime: 32},
    {title: "Il Primo Pick-up", text: "Il primo pick-up per chitarra fu inventato da George Beauchamp negli anni '20.", readingTime: 20},
    {title: "La Canzone Infinita", text: "La canzone pi√π lunga mai registrata dura oltre 13 ore.", readingTime: 18},
    {title: "Requiem Incompiuto", text: "Il 'Requiem' di Mozart fu completato dopo la sua morte da Franz Xaver S√ºssmayr.", readingTime: 22},
    {title: "Funicul√¨ per la Funicolare", text: "Il brano 'Funicul√¨ Funicul√†' fu scritto per celebrare la funicolare del Vesuvio.", readingTime: 22},
    {title: "Satie e le 840 Ripetizioni", text: "Il compositore Erik Satie era ossessionato dai numeri e dalle ripetizioni: in 'Vexations' chiede di ripetere il brano 840 volte.", readingTime: 28},
    {title: "Chitarre d'Autore", text: "Il liutaio Tony Zemaitis costruiva chitarre personalizzate per rockstar come George Harrison e Ronnie Wood.", readingTime: 24},
    {title: "Il Tacchino di Rossini", text: "Il compositore era cos√¨ goloso che invent√≤ una ricetta a base di tacchino e tartufo.", readingTime: 21},
    {title: "Flauto Magico Massonico", text: "Il 'Flauto Magico' di Mozart contiene messaggi massonici nascosti.", readingTime: 20},
    {title: "Yesterday Scrambled", text: "Il brano 'Yesterday' dei Beatles fu inizialmente intitolato 'Scrambled Eggs'.", readingTime: 20},
    {title: "Salieri Sabotatore", text: "Il compositore Salieri sabot√≤ un vecchio spinetta per costringere il teatro a comprarne una nuova.", readingTime: 23},
    {title: "Flying V Aerospaziale", text: "La Flying V di Gibson fu ispirata ai primi aerei a reazione.", readingTime: 19},
    {title: "Stokowski contro la Tosse", text: "Il direttore Leopold Stokowski si ferm√≤ durante un concerto per rimproverare il pubblico che tossiva troppo.", readingTime: 25},
    {title: "Bolero Ossessivo", text: "Il 'Bolero' di Ravel √® costruito su un unico tema ripetuto ossessivamente.", readingTime: 20},
    {title: "Bach e il Temperamento", text: "Il 'Clavicembalo ben temperato' di Bach fu scritto per dimostrare la validit√† del temperamento equabile.", readingTime: 25},
    {title: "Shostakovich e la Censura", text: "Il compositore Shostakovich inviava cartoline a se stesso per testare la censura sovietica.", readingTime: 22},
    {title: "Brian May ed Eddie Van Halen", text: "Il brano 'Starfleet Project' di Brian May (Queen) vede la partecipazione di Eddie Van Halen.", readingTime: 23},
    {title: "Requiem per Manzoni", text: "Il 'Requiem' di Verdi fu scritto in memoria di Alessandro Manzoni.", readingTime: 20},
    {title: "VOX da Jennings", text: "Il nome della band 'VOX' deriva dalla 'Jennings Organ Company'.", readingTime: 19},
    {title: "Pachelbel Riscoperto", text: "Il 'Canone di Pachelbel' fu riscoperto solo nel Novecento.", readingTime: 19},
    {title: "Beethoven contro Steibelt", text: "Beethoven sfid√≤ il pianista Steibelt in un duello musicale e lo umili√≤ improvvisando su un tema banale.", readingTime: 26},
    {title: "Il Trillo del Diavolo", text: "Il 'Trillo del diavolo' di Tartini fu ispirato da un sogno in cui il diavolo suonava il violino.", readingTime: 24},
    {title: "Clair de Lune Poetico", text: "Il 'Clair de Lune' di Debussy prende il nome da una poesia di Paul Verlaine.", readingTime: 22},
    {title: "Notturno Insonne", text: "Il 'Notturno' di Chopin fu ispirato dalle notti insonni del compositore.", readingTime: 20},
    {title: "Carillon Improvvisato", text: "Il 'Carillon de Westminster' di Louis Vierne fu improvvisato durante una messa.", readingTime: 21},
    {title: "Dies Irae nei Videogiochi", text: "Il 'Dies Irae' √® stato usato anche nei videogiochi come tema di morte.", readingTime: 20},
    {title: "Concerto per Mutilato", text: "Il 'Concerto per la mano sinistra' di Ravel fu scritto per un pianista mutilato in guerra.", readingTime: 23},
    {title: "Mendelssohn a 17 Anni", text: "Il 'Sogno di una notte di mezza estate' di Mendelssohn fu composto quando aveva solo 17 anni.", readingTime: 24},
    {title: "Ave Maria di Gounod", text: "Il 'Preludio in do maggiore' di Bach √® stato usato come base per la canzone 'Ave Maria' di Gounod.", readingTime: 25},
    {title: "Glissando Famoso", text: "Il 'Glissando' del clarinetto all'inizio di 'Rhapsody in Blue' di Gershwin fu un errore diventato celebre.", readingTime: 25},
    {title: "Dies Irae in Shining", text: "Il 'Dies Irae' √® citato anche nella colonna sonora di 'Shining' di Kubrick.", readingTime: 21},
    {title: "Poulenc Balinese", text: "Il 'Concerto per due pianoforti' di Poulenc fu ispirato dalla musica balinese.", readingTime: 22},
    {title: "Tema di Lara Vietato", text: "Il 'Tema di Lara' dal film 'Il dottor Zivago' √® stato vietato in URSS per decenni.", readingTime: 23},
    {title: "Violino Impossibile", text: "Il 'Concerto per violino' di Sibelius fu inizialmente rifiutato dai violinisti per la sua difficolt√†.", readingTime: 24},
    {title: "Valzer Botanico", text: "Il 'Valzer dei fiori' di ƒåajkovskij fu ispirato da un giardino botanico.", readingTime: 21},
    {title: "Tromba a Chiavi", text: "Il 'Concerto per tromba' di Haydn fu scritto per la prima tromba a chiavi.", readingTime: 21},
    {title: "Concerto allo Psicanalista", text: "Il 'Concerto per pianoforte n. 2' di Rachmaninov fu dedicato al suo psicanalista.", readingTime: 23},
    {title: "Insuccesso di Beethoven", text: "Il 'Concerto per violino' di Beethoven fu un insuccesso alla prima esecuzione.", readingTime: 22},
    {title: "Rifiuto di Tchaikovsky", text: "Il 'Concerto per pianoforte n. 1' di Tchaikovsky fu rifiutato dal dedicatario.", readingTime: 22},
    {title: "Mozart e Stadler", text: "Il 'Concerto per clarinetto' di Mozart fu scritto per Anton Stadler, virtuoso dello strumento.", readingTime: 23},
    {title: "Mendelssohn Innovativo", text: "Il 'Concerto per violino' di Mendelssohn fu uno dei primi a collegare i movimenti senza pause.", readingTime: 25},
    {title: "Prokofiev in Treno", text: "Il 'Concerto per pianoforte n. 3' di Prokofiev fu scritto durante un viaggio in treno.", readingTime: 23},
    {title: "Brahms Difficile", text: "Il 'Concerto per violino' di Brahms fu considerato troppo difficile da molti violinisti.", readingTime: 23},
    {title: "L'Imperatore", text: "Il 'Concerto per pianoforte n. 5' di Beethoven √® soprannominato 'Imperatore'.", readingTime: 20},
    {title: "Unico Successo di Bruch", text: "Il 'Concerto per violino' di Bruch fu il suo unico vero successo.", readingTime: 20},
    {title: "Elvira Madigan", text: "Il 'Concerto per pianoforte n. 21' di Mozart √® noto come 'Elvira Madigan' per l'uso nel film omonimo.", readingTime: 25},
    {title: "Dvo≈ô√°k e Joachim", text: "Il 'Concerto per violino' di Dvo≈ô√°k fu scritto per il violinista Joseph Joachim.", readingTime: 22},
    {title: "Shostakovich per il Figlio", text: "Il 'Concerto per pianoforte n. 2' di Shostakovich fu scritto per il figlio Maxim.", readingTime: 23},
    {title: "Sibelius Riscoperto", text: "Il 'Concerto per violino' di Sibelius fu riscoperto solo nel Novecento.", readingTime: 21},
    {title: "20 Anni di Liszt", text: "Il 'Concerto per pianoforte n. 1' di Liszt fu scritto in oltre 20 anni.", readingTime: 21},
    {title: "Paganini Diabolico", text: "Il 'Concerto per violino' di Paganini fu considerato 'diabolico' per la sua difficolt√†.", readingTime: 23},
    {title: "Saint-Sa√´ns in 17 Giorni", text: "Il 'Concerto per pianoforte n. 2' di Saint-Sa√´ns fu scritto in 17 giorni.", readingTime: 22},
    {title: "Rifiuto d'Amore", text: "Il 'Concerto per violino' di Bart√≥k fu dedicato a una donna che lo rifiut√≤.", readingTime: 22},
    {title: "Do Minore Drammatico", text: "Il 'Concerto per pianoforte n. 3' di Beethoven fu scritto in do minore, la sua tonalit√† 'drammatica'.", readingTime: 25},
    {title: "Delusione Amorosa", text: "Il 'Concerto per violino' di Tchaikovsky fu scritto dopo una delusione amorosa.", readingTime: 22},
    {title: "Rachmaninov Sfortunato", text: "Il 'Concerto per pianoforte n. 4' di Rachmaninov fu un insuccesso alla prima.", readingTime: 22},
    {title: "Korngold Hollywoodiano", text: "Il 'Concerto per violino' di Korngold fu ispirato da colonne sonore hollywoodiane.", readingTime: 23},
    {title: "Prokofiev Giovane", text: "Il 'Concerto per pianoforte n. 1' di Prokofiev fu scritto a 19 anni.", readingTime: 21},
    {title: "Elgar e Kreisler", text: "Il 'Concerto per violino' di Elgar fu dedicato a Fritz Kreisler.", readingTime: 20},
    {title: "22 Anni di Attesa", text: "Il 'Concerto per pianoforte n. 2' di Brahms fu scritto 22 anni dopo il primo.", readingTime: 23},
    {title: "Glazunov in una Notte", text: "Il 'Concerto per violino' di Glazunov fu scritto in una sola notte.", readingTime: 21},
    {title: "Chopin a 20", text: "Il 'Concerto per pianoforte n. 1' di Chopin fu scritto a 20 anni.", readingTime: 20},
    {title: "Nielsen e M√∏ller", text: "Il 'Concerto per violino' di Nielsen fu scritto per il violinista Peder M√∏ller.", readingTime: 22},
    {title: "Liszt Libero", text: "Il 'Concerto per pianoforte n. 2' di Liszt fu scritto in forma libera, senza movimenti separati.", readingTime: 25},
    {title: "Szymanowski Polacco", text: "Il 'Concerto per violino' di Szymanowski fu ispirato dalla musica popolare polacca.", readingTime: 23},
    {title: "Rifiuto di Rubinstein", text: "Il 'Concerto per pianoforte n. 1' di Tchaikovsky fu rifiutato da Nikolai Rubinstein.", readingTime: 23},
    {title: "Walton e Heifetz", text: "Il 'Concerto per violino' di Walton fu scritto per Jascha Heifetz.", readingTime: 21},
    {title: "Bart√≥k Finale", text: "Il 'Concerto per pianoforte n. 3' di Bart√≥k fu scritto poco prima della morte del compositore.", readingTime: 25},
    {title: "Shostakovich Staliniano", text: "Il 'Concerto per violino' di Shostakovich fu scritto durante la repressione staliniana.", readingTime: 24},
    {title: "Rachmaninov Riscritto", text: "Il 'Concerto per pianoforte n. 1' di Rachmaninov fu riscritto pi√π volte.", readingTime: 22},
    {title: "Britten in Guerra", text: "Il 'Concerto per violino' di Britten fu scritto durante la Seconda guerra mondiale.", readingTime: 23},
    {title: "Prokofiev Perduto", text: "Il 'Concerto per pianoforte n. 2' di Prokofiev fu ricostruito dopo essere andato perduto.", readingTime: 24},
    {title: "Khachaturian in 3 Mesi", text: "Il 'Concerto per violino' di Khachaturian fu scritto in tre mesi.", readingTime: 21},
    {title: "Shostakovich Solista", text: "Il 'Concerto per pianoforte n. 1' di Shostakovich fu scritto per s√© stesso come solista.", readingTime: 24},
    {title: "Barber Americano", text: "Il 'Concerto per violino' di Barber fu scritto per un giovane violinista americano.", readingTime: 23},
    {title: "Ravel per Wittgenstein", text: "Il 'Concerto per pianoforte n. 2' di Ravel fu scritto per Paul Wittgenstein, pianista con una sola mano.", readingTime: 27},
    {title: "Berg per Manon", text: "Il 'Concerto per violino' di Berg fu dedicato a Manon Gropius, figlia di Alma Mahler.", readingTime: 24},
    {title: "Gershwin Jazz", text: "Il 'Concerto per pianoforte n. 1' di Gershwin fu scritto in stile jazz sinfonico.", readingTime: 22},
    {title: "Stravinsky e Dushkin", text: "Il 'Concerto per violino' di Stravinsky fu scritto per Samuel Dushkin, che aiut√≤ il compositore a superare le difficolt√† tecniche dello strumento.", readingTime: 30}
];

// 100 SFIDE BASE - Spirito Osservatore (concettuali, ironiche, comode)
const photoChallengesBase = [
    "üì∏ Fotografa le tue mani che mimano la direzione di un'orchestra barocca mentre ascolti Vivaldi",
    "üì∏ Il tuo strumento in un luogo inaspettato della casa (la vasca da bagno, il frigorifero, sotto il letto)",
    "üì∏ Un oggetto quotidiano che assomiglia a una nota musicale o a una chiave di violino",
    "üì∏ Fotografa la sezione archi di un'orchestra (anche giocattolo, disegnata o improvvisata con verdure)",
    "üì∏ Crea un'ombra misteriosa del tuo strumento su un muro bianco al tramonto",
    "üì∏ Trova tre oggetti rossi e disponili come se fossero una triade musicale",
    "üì∏ Il tuo spartito preferito riflesso in uno specchio o in una pozzanghera",
    "üì∏ Una foto del tuo archetto che punta verso qualcosa di assurdo (un piccione, una pizza, una fontana)",
    "üì∏ Fotografa la tua collezione di plettri, bacchette o accessori musicali disposti come un mandala",
    "üì∏ Il tuo strumento abbracciato da una pianta o da fiori del tuo giardino",
    "üì∏ Crea una natura morta barocca con spartiti, candele e frutta (anche solo due elementi!)",
    "üì∏ Fotografa le corde del tuo strumento in primo piano come se fossero un'opera d'arte astratta",
    "üì∏ Il tuo leggio in una posa drammatica, come se recitasse in un'opera tragica",
    "üì∏ Trova un graffiti o street art che ricordi uno strumento musicale",
    "üì∏ Fotografa la tua ombra mentre fai il gesto del direttore d'orchestra",
    "üì∏ Crea un selfie con tre oggetti che rappresentano tre epoche musicali diverse",
    "üì∏ Il tuo strumento che guarda fuori dalla finestra come in un film melanconico",
    "üì∏ Fotografa qualcosa di blu mentre ascolti un brano jazz malinconico",
    "üì∏ Disponi i tuoi vecchi biglietti dei concerti come un collage e fotografali",
    "üì∏ Il tuo metronomo in azione con una lunga esposizione (effetto mosso artistico)",
    "üì∏ Fotografa le tue scarpe da concerto in un contesto surreale",
    "üì∏ Crea una composizione con cinque oggetti che iniziano con le lettere D-O-R-E-M-I",
    "üì∏ Il tuo strumento riflesso in una superficie lucida inaspettata (pentola, specchietto dell'auto, telefono)",
    "üì∏ Fotografa la tua mano che indica una nota su uno spartito come se fosse un momento drammatico",
    "üì∏ Un calzino infilato nella campana di uno strumento a fiato (o equivalente assurdo per altri strumenti)",
    "üì∏ Fotografa la tua tazza da caff√® accanto allo spartito pi√π difficile che possiedi",
    "üì∏ Il tuo strumento seduto su una sedia come se stesse aspettando qualcuno",
    "üì∏ Crea un pattern geometrico con i tuoi spartiti visti dall'alto",
    "üì∏ Fotografa qualcosa di dorato mentre ascolti musica barocca",
    "üì∏ Il tuo accordatore elettronico in un posto dove non dovrebbe stare (giardino, libreria, cucina)",
    "üì∏ Fotografa tre texture diverse che rappresentano tre generi musicali (liscio=classica, ruvido=rock, etc.)",
    "üì∏ Il tuo strumento con un cappello buffo (berretto, cappello di paglia, corona di carta)",
    "üì∏ Crea una timeline fotografica: passato-presente-futuro con oggetti musicali",
    "üì∏ Fotografa le chiavi del tuo pianoforte/strumento con una luce laterale drammatica",
    "üì∏ Un oggetto quotidiano suonato come se fosse uno strumento (cucchiaio-violino, bottiglia-tromba)",
    "üì∏ Il tuo diapason accanto a qualcosa che vibra (ventilatore, lavatrice, telefono)",
    "üì∏ Fotografa il tuo strumento da un'angolazione che nessuno userebbe mai",
    "üì∏ Crea una copertina di album immaginario con te e il tuo strumento",
    "üì∏ Fotografa cinque oggetti della tua casa disposti secondo l'intervallo di quinta giusta",
    "üì∏ Il tuo bocchino/ancia/archetto in primo piano come se fosse un gioiello prezioso",
    "üì∏ Fotografa la tua custodia dello strumento in un contesto poetico",
    "üì∏ Crea una foto prima e dopo il concerto con te/il tuo strumento",
    "üì∏ Fotografa qualcosa di circolare mentre ascolti un canone musicale",
    "üì∏ Il tuo strumento decorato con elementi naturali (foglie, fiori, conchiglie)",
    "üì∏ Fotografa la tua espressione mentre fai una faccia da musicista esageratamente concentrata",
    "üì∏ Disponi i tuoi libri di teoria musicale come una scala cromatica (dal piccolo al grande)",
    "üì∏ Fotografa il riflesso del tuo strumento in una bolla di sapone (o provateci!)",
    "üì∏ Il tuo strumento in vacanza su una poltrona con occhiali da sole e un cocktail finto",
    "üì∏ Crea un dittico fotografico: silenzio vs suono (oggetti che rappresentano entrambi)",
    "üì∏ Fotografa la tua ombra e quella del tuo strumento che creano una forma inaspettata",
    "üì∏ Fotografa le tue mani che dirigono un'orchestra di calzini spaiati",
    "üì∏ Il tuo strumento musicale (o le tue cuffie) che si gode un bagno rilassante (vuoto, mi raccomando!)",
    "üì∏ Un primo piano drammatico dei tasti bianchi e neri di un pianoforte, visti come un paesaggio urbano",
    "üì∏ La sezione archi di un'orchestra di utensili da cucina (fruste, mestoli, spatole)",
    "üì∏ L'ombra del tuo strumento proiettata sul muro, ingigantita e minacciosa",
    "üì∏ Fotografa un Silenzio (una pausa musicale) visivo: uno spazio vuoto su uno scaffale affollato",
    "üì∏ Il tuo gatto (o cane, o pianta) che legge uno spartito con aria molto critica",
    "üì∏ Un autoritratto riflesso sulla superficie lucida del tuo strumento musicale",
    "üì∏ Un oggetto che rappresenti visivamente il concetto di Staccato (es. gocce d'acqua che cadono)",
    "üì∏ La texture usurata di un vecchio spartito o di un tasto del pianoforte",
    "üì∏ Musica liquida: il riflesso colorato di una copertina di un CD in un bicchiere d'acqua",
    "üì∏ Un angolo della tua casa che, con la giusta luce, sembra un palcoscenico pronto per un concerto",
    "üì∏ Le tue scarpe posizionate come se stessero ballando un valzer appassionato",
    "üì∏ Un cavo delle cuffie ingarbugliato che sembra un pentagramma impazzito",
    "üì∏ Un ritratto di un compositore famoso (anche su un libro) che dialoga con un oggetto moderno (uno smartphone)",
    "üì∏ Fotografa un Crescendo usando solo oggetti della scrivania (da una graffetta a un libro pesante)",
    "üì∏ Il tuo strumento preferito messo a dormire sotto le coperte nel tuo letto",
    "üì∏ Un dettaglio macro della corda di una chitarra o del legno di un violino",
    "üì∏ Sinfonia di Colazione: come il cibo nel tuo piatto crea un ritmo visivo",
    "üì∏ Un libro di musica usato come base per un panino. L'arte nutre, no?",
    "üì∏ La tua tazza di caff√® del mattino, con il vapore che sale come una melodia leggera",
    "üì∏ Fotografa le tue dita che mimano un accordo complicato... sulla spalla di un amico",
    "üì∏ Un oggetto rosso che urla un acuto (un peperoncino, un rossetto)",
    "üì∏ Il caos ordinato dei pedali di una chitarra o di una batteria",
    "üì∏ Musica Muta: un vecchio stereo o giradischi impolverato in soffitta",
    "üì∏ Una forchetta e un coltello posizionati come se fossero le bacchette di un direttore d'orchestra",
    "üì∏ La geometria perfetta di un vinile sul piatto",
    "üì∏ Un autoritratto mentre fai finta di suonare uno strumento che non sai assolutamente suonare",
    "üì∏ Fotografa una Fuga (alla Bach): le tue scarpe vicino alla porta, pronte a scappare",
    "üì∏ La prospettiva vista dal leggio: cosa vede il musicista mentre suona?",
    "üì∏ Un fiore che sboccia dalla campana di uno strumento a fiato",
    "üì∏ L'interno di un pianoforte (se puoi!): un mondo meccanico e affascinante",
    "üì∏ Un ritratto del tuo orecchio, il destinatario finale di tutta la musica",
    "üì∏ Oggetti in cucina impilati per creare una scala musicale visiva",
    "üì∏ Il tuo strumento che guarda malinconicamente fuori dalla finestra",
    "üì∏ Un primo piano estremo della puntina di un giradischi sul solco del vinile",
    "üì∏ Blues in cucina: solo oggetti blu trovati nel tuo frigorifero",
    "üì∏ La spirale di una scala a chiocciola che ricorda il solco di un disco",
    "üì∏ Una vecchia musicassetta o un CD usato come sottobicchiere (sacrilegio!)",
    "üì∏ Armonia domestica: due oggetti completamente diversi che stanno benissimo vicini",
    "üì∏ La calligrafia di uno spartito scritto a mano",
    "üì∏ Il tuo cuscino che ascolta la musica dalle tue cuffie",
    "üì∏ Un Assolo visivo: un singolo oggetto illuminato da un fascio di luce in una stanza buia",
    "üì∏ Note musicali disegnate col ketchup sulle patatine fritte",
    "üì∏ Le venature del legno di un parquet che sembrano righe di un pentagramma",
    "üì∏ Uno strumento giocattolo trattato con la seriet√† di uno Stradivari",
    "üì∏ Il tuo riflesso distorto nella campana di una tromba o in un piatto della batteria",
    "üì∏ Il momento esatto in cui accendi l'amplificatore (la lucina rossa!)",
    "üì∏ La tua libreria musicale (CD, vinili, file) ripresa come se fosse l'archivio di un alchimista"
];

// 100 SFIDE AUDACI - Spirito Performativo (performance, coinvolgono persone, imbarazzanti)
const photoChallengesAudaci = [
    "üì∏ Svegliati all'alba e fotografa il tuo strumento baciato dalla prima luce dorata del giorno sul balcone",
    "üì∏ Crea una scultura con vecchi spartiti e fotografala in un luogo insolito: bunker, garage, bar, negozio di scarpe",
    "üì∏ Vai in una biblioteca affollata alle 15, dirigi un'orchestra invisibile per 2 minuti con gesti teatrali, fotografa almeno 3 facce stranite",
    "üì∏ Entra in un supermercato alle 18 con uno spartito gigante fatto in casa, chiedi a un commesso di tenerlo mentre leggi concentrato, fotografa la sua espressione",
    "üì∏ Con un amico, create una performance statuaria con spartiti in un parco pubblico alle 17, state fermi 5 minuti, fotografate chi si ferma perplesso",
    "üì∏ Porta il tuo strumento in un bar affollato alle 12, fingiti ispirato dal rumore e componi ad alta voce per 2 minuti, fotografa 3 reazioni dei clienti",
    "üì∏ Entra in una farmacia con spartiti sotto il braccio, chiedi al farmacista se vende 'vitamine per la creativit√† musicale', fotografa la sua reazione",
    "üì∏ Alle 7 di mattina, porta il tuo strumento in un parco pubblico, suona per 10 minuti guardando i joggers, fotografa almeno 3 reazioni perplesse",
    "üì∏ Con due amici, andate in un centro commerciale alle 16, uno dirige un'orchestra invisibile per 3 minuti mentre gli altri fingono di suonare, fotografate la gente",
    "üì∏ Entra in una tabaccheria con uno spartito enorme, chiedi al tabaccaio di tenerlo aperto mentre fingi di leggere una partitura difficilissima, fotografa la sua espressione",
    "üì∏ Vai in una cartoleria con un amico, chiedi se hanno 'fogli pentagrammati magici per comporre sinfonie immediate' facendo gesti misteriosi, fotografa il commesso",
    "üì∏ Alle 13, vai in una pizzeria affollata con il tuo strumento, suona 'O Sole Mio' per 30 secondi guardando i clienti, fotografa almeno 3 facce sorprese",
    "üì∏ Con un amico, andate al mercato alle 10, suonate insieme 'Lascia ch'io pianga' per 10 minuti fingendo di piangere, selfie con gente intorno",
    "üì∏ Entra in un negozio di scarpe col tuo strumento, chiedi di provare scarpe mentre suoni, fotografa la reazione confusa del commesso",
    "üì∏ Con un amico in un bar affollato alle 18, canta un'aria d'opera a squarciagola per 45 secondi, lui fotografa le facce imbarazzate dei clienti",
    "üì∏ Alle 19, vai in un supermercato con il tuo strumento, suona nel reparto ortofrutta per 3 minuti guardando le persone, fotografa almeno 3 reazioni",
    "üì∏ Entra in una biblioteca con un amico alle 14, inizia a suonare sottovoce aumentando il volume per 2 minuti, lui fotografa le facce scandalizzate",
    "üì∏ Vai in un ufficio postale alle 11, mentre fai la coda canticchia un'opera sempre pi√π forte, chiedi a un amico di fotografare le reazioni",
    "üì∏ Con due amici, entrate in un negozio di abbigliamento, uno suona mentre canti e il terzo fotografa il commesso e i clienti increduli",
    "üì∏ Alle 8, vai in un bar con un amico, ordinate cappuccini e improvvisamente canta la Traviata per 40 secondi, lui fotografa camerieri e clienti",
    "üì∏ Porta il tuo strumento in una stazione ferroviaria alle 17, suona per 15 minuti vicino ai binari, fotografa almeno 5 viaggiatori che si fermano ad ascoltare",
    "üì∏ Con un amico, create uno spettacolo di mimo musicale in piazza alle 16, lui fotografa i passanti che buttano monetine credendovi artisti di strada",
    "üì∏ Entra in una libreria affollata alle 15 con spartiti enormi, chiedi al libraio dove sono i 'romanzi scritti in note musicali', fotografa la sua confusione",
    "üì∏ Vai in un parco giochi alle 11, chiedi ai bambini di cantare con te una canzone inventata sul momento, fotografa i genitori perplessi e i bimbi divertiti",
    "üì∏ Con due amici, andate in un museo alle 14, create una 'installazione sonora vivente' canticchiando in armonia davanti a un quadro, fotografate le reazioni",
    "üì∏ Entra in un ristorante alle 13 con il tuo strumento, chiedi al cameriere se puoi suonare per i clienti durante il pranzo, fotografa la sua reazione",
    "üì∏ Alle 9, vai in un ufficio (pu√≤ essere il tuo o di un amico), inizia a cantare durante una riunione fingendo sia normalissimo, fotografa le facce",
    "üì∏ Con un amico, andate in una palestra alle 18, iniziate a fare esercizi cantando arie d'opera a squarciagola, lui fotografa gli sportivi sconvolti",
    "üì∏ Porta il tuo strumento in un taxi, chiedi al tassista se puoi suonare durante la corsa, fotografa la sua reazione allo specchietto retrovisore",
    "üì∏ Entra in una banca alle 10 con spartiti giganti, chiedi all'impiegato se accettano 'pagamenti in note musicali', fotografa la sua espressione",
    "üì∏ Con un amico, create una 'orchestra da colazione' alle 8 in un bar, usate cucchiaini e tazzine come strumenti, fotografate i clienti assonnati",
    "üì∏ Vai in una farmacia alle 16, chiedi al farmacista consigli per curare 'l'orecchio assoluto', spiega sintomi assurdi, fotografa la sua faccia confusa",
    "üì∏ Alle 14, vai in un supermercato, prendi un carrello e spingerlo canticchiando la Cavalcata delle Valchirie per 5 minuti, fotografa le reazioni",
    "üì∏ Con due amici, andate in una chiesa vuota alle 11, create un concerto a cappella di 3 minuti, fotografate l'eco e eventuali fedeli sorpresi",
    "üì∏ Entra in un negozio di elettronica alle 15, chiedi se hanno 'cavi per collegare l'anima alla musica', fai gesti mistici, fotografa il commesso",
    "üì∏ Porta il tuo strumento su un autobus alle 17, chiedi ai passeggeri se vogliono un concerto durante il viaggio, fotografa almeno 5 reazioni diverse",
    "üì∏ Con un amico, andate in un centro estetico alle 10, chiedi se fanno 'trattamenti per le mani dei musicisti', lui fotografa l'estetista perplessa",
    "üì∏ Alle 12, vai in una mensa universitaria, sali su un tavolo (con permesso) e recita un monologo operistico per 2 minuti, fotografa gli studenti",
    "üì∏ Entra in una gioielleria alle 16 con spartiti, chiedi se vendono 'collane con note musicali magiche che migliorano l'intonazione', fotografa la commessa",
    "üì∏ Con un amico, andate in un cinema prima dello spettacolo alle 20, lui ti intervista come se fossi una star mondiale della musica, fotografate gli altri spettatori",
    "üì∏ Vai in una lavanderia a gettoni alle 15, canta accompagnandoti col ritmo delle lavatrici in funzione per 3 minuti, fotografa chi fa il bucato",
    "üì∏ Alle 9, vai in una rosticceria, chiedi al rosticciere se pu√≤ riscaldare il tuo 'pentagramma freddo', mostragli uno spartito, fotografa la sua reazione",
    "üì∏ Con due amici, create una 'parata musicale spontanea' per strada alle 17, marcia cantando con strumenti improvvisati, fotografate i passanti stupiti",
    "üì∏ Entra in un negozio di scarpe alle 14, prova stivali mentre canti la marcia turca di Mozart, fotografa i commessi e altri clienti imbarazzati",
    "üì∏ Vai in un parrucchiere alle 11, mentre ti tagliano i capelli canticchia arie d'opera sempre pi√π forte, fotografa il parrucchiere e clienti nello specchio",
    "üì∏ Con un amico, andate in una profumeria alle 16, annusate profumi cantando note corrispondenti all'intensit√† olfattiva, fotografate le commesse perplesse",
    "üì∏ Alle 13, vai in una gastronomia affollata, ordina cantando in stile operistico ogni singolo prodotto che vuoi, fotografa il gastronomiere e clienti in fila",
    "üì∏ Porta il tuo strumento in una sala d'attesa medica alle 10, suona per intrattenere i pazienti per 10 minuti, fotografa almeno 5 reazioni diverse",
    "üì∏ Con un amico, andate in un supermercato bio alle 18, create una 'sinfonia delle verdure' cantando davanti al reparto ortofrutta, fotografate le reazioni",
    "üì∏ Entra in un negozio di animali alle 15, canta per i pappagalli cercando di farli cantare con te, fotografa i volatili e il negoziante sorpreso",
    "üì∏ Alle 17, vai in una cartoleria, compra quaderni pentagrammati e chiedi se li vendono 'gi√† compilati con sinfonie', fotografa l'espressione del commesso",
    "üì∏ Con due amici, andate in una piazza alle 12, uno dirige, gli altri suonano strumenti invisibili, performance di 5 minuti, fotografate i curiosi",
    "üì∏ Vai in un negozio di abbigliamento alle 14, prova vestiti canticchiando la descrizione di ogni capo in stile operistico, fotografa i commessi confusi",
    "üì∏ Alle 19, entra in una pizzeria, ordina la pizza cantando tutti gli ingredienti come se fosse un'aria barocca, fotografa il pizzaiolo e clienti",
    "üì∏ Con un amico, andate in una ferramenta alle 10, chiedi martelli che 'suonano in DO' e cacciaviti 'intonati in LA', lui fotografa il ferramenta perplesso",
    "üì∏ Vai in una tabaccheria alle 16, compra un biglietto della lotteria cantando i numeri che vuoi come fossero note, fotografa il tabaccaio",
    "üì∏ Alle 11, con un amico andate in un bar, ordinate bevande e improvvisate un brindisi operistico a squarciagola, fotografate camerieri e altri clienti",
    "üì∏ Porta il tuo strumento in una palestra alle 18, proponi di suonare durante le lezioni di aerobica, fotografa l'istruttore e gli sportivi sorpresi",
    "üì∏ Con due amici, andate in un negozio di giocattoli alle 15, suonate strumenti giocattolo facendo un concerto serio, fotografate bambini e genitori",
    "üì∏ Entra in una farmacia alle 10, chiedi una 'pomata per le labbra screpolate dal solfeggio intenso', spiega sintomi assurdi, fotografa il farmacista",
    "üì∏ Alle 14, vai in un bar con wifi, siediti e canta mentre lavori al computer come fosse normalissimo, fotografa gli altri avventori al lavoro",
    "üì∏ Con un amico, andate in un cinema durante una pausa tra film alle 16, lui ti intervista sul palco come musicista famoso, fotografate il pubblico",
    "üì∏ Vai in un negozio di cornici alle 11, chiedi di incorniciare il tuo spartito pi√π bello 'come fosse la Gioconda', fotografa il commesso e la sua reazione",
    "üì∏ Alle 17, con un amico andate in una fioreria, cantate serenate ai fiori per 3 minuti, fotografate la fioraia e clienti che vi guardano straniti",
    "üì∏ Entra in un'edicola alle 9, compra un giornale cantando il titolo di prima pagina in stile lirico, fotografa l'edicolante sorpreso",
    "üì∏ Con due amici, andate in una piazza alle 16, create una 'flash mob musicale' con strumenti invisibili per 5 minuti, fotografate i passanti",
    "üì∏ Vai in un bar alle 8, ordina un cappuccino e cantane gli ingredienti al barista come fosse un'aria barocca, fotografa la sua reazione mattutina",
    "üì∏ Alle 13, con un amico andate in una trattoria, chiedete il menu e cantate ogni piatto valutando quale 'suona meglio', fotografate il cameriere",
    "üì∏ Porta il tuo strumento in metropolitana alle 18 (ora di punta), suona per 10 minuti durante il viaggio, fotografa almeno 7 reazioni di pendolari",
    "üì∏ Con un amico, andate in una libreria alle 14, leggete ad alta voce brani di libri musicandoli come fossero libretti d'opera, fotografate i clienti",
    "üì∏ Entra in un negozio di scarpe sportive alle 16, chiedi se hanno 'scarpe che migliorano il tempo in semiminime al chilometro', fotografa il commesso",
    "üì∏ Alle 10, vai in un ufficio postale, compila bollettini canticchiando i numeri come note musicali, fotografa gli impiegati e gente in coda",
    "üì∏ Con due amici, andate in una gelateria alle 15, ordinate gusti cantandoli in stile lirico facendo prove di intonazione, fotografate il gelatiere",
    "üì∏ Vai in un supermercato alle 19, sali (con permesso) su una cassetta e canta per 2 minuti ringraziando i lavoratori, fotografa cassieri e clienti",
    "üì∏ Alle 12, con un amico andate in una mensa, cantate la vostra ordinazione come fosse un duetto operistico, fotografate addetti e altri commensali",
    "üì∏ Entra in una profumeria alle 11, chiedi un profumo che 'sappia di note musicali' e annusa ogni fragranza cantando, fotografa la commessa confusa",
    "üì∏ Con un amico, andate in un parco alle 17, create un 'concerto per uccelli' fischiando melodie per 5 minuti, fotografate uccelli e persone",
    "üì∏ Vai in un negozio di elettronica alle 14, chiedi se vendono 'hard disk per memorizzare sinfonie mentali', fai gesti mistici, fotografa il commesso",
    "üì∏ Alle 16, con due amici andate in un bar, uno suona cucchiaini, uno canta, uno fotografa: mini concerto di 3 minuti, catturate i clienti",
    "üì∏ Porta il tuo strumento in un taxi alle 20, proponi al tassista un concerto privato durante la corsa, fotografa la sua reazione dallo specchietto",
    "üì∏ Con un amico, andate in una stazione ferroviaria alle 18, cantate annunci di treni inventati in stile operistico per 3 minuti, fotografate i viaggiatori",
    "üì∏ Entra in una panetteria alle 8, ordina pane e dolci cantando ogni singolo prodotto come fosse una romanza, fotografa il panettiere e clienti in fila",
    "üì∏ Alle 15, vai in una cartoleria, chiedi 'gomme per cancellare note stonate' e spiegane l'utilizzo con seriet√† assoluta, fotografa il commesso perplesso",
    "üì∏ Con un amico, andate in un centro commerciale alle 17, create una 'guida turistica cantata' dei negozi per 5 minuti, fotografate la gente",
    "üì∏ Vai in una farmacia alle 11, chiedi al farmacista se vende 'integratori per migliorare l'orecchio assoluto', descrivi sintomi buffi, fotografa la reazione",
    "üì∏ Alle 13, con due amici andate in una pizzeria, ordinate cantando a tre voci ogni ingrediente come un coretto, fotografate il pizzaiolo sorpreso",
    "üì∏ Porta il tuo strumento in un ascensore affollato di un centro commerciale alle 16, suona per 30 secondi durante la salita, fotografa le facce imbarazzate",
    "üì∏ Con un amico, andate in una biblioteca alle 10, sussurrate cantando una conversazione operistica per 3 minuti tra gli scaffali, fotografate i lettori",
    "üì∏ Entra in un negozio di telefonia alle 14, chiedi se hanno 'smartphone che suonano automaticamente in base all'umore', fotografa il commesso confuso",
    "üì∏ Alle 18, vai in un bar con amici, proponi un 'karaoke classico' cantando arie d'opera a squarciagola per 2 minuti, fotografa clienti e baristi",
    "üì∏ Con un amico, andate in una gioielleria alle 11, chiedete gioielli che 'risuonano in frequenze armoniche benefiche', fotografate la commessa perplessa",
    "üì∏ Vai in un supermercato biologico alle 17, canta i nomi delle verdure come fossero personaggi d'opera mentre le scegli, fotografa clienti e cassiere",
    "üì∏ Alle 9, con un amico andate in un bar di mattina, ordinate colazione cantando tutto in falsetto come controtenori barocchi, fotografate il barista",
    "üì∏ Porta il tuo strumento in un parco giochi alle 16, proponi ai bambini di cantare insieme canzoni inventate, fotografa genitori e bimbi divertiti",
    "üì∏ Con due amici, andate in una piazza turistica alle 15, fingete di essere una famosa band in tour, firmate autografi immaginari, fotografate i turisti",
    "üì∏ Entra in un'agenzia di viaggi alle 10, chiedi pacchetti turistici 'per terre dove si parla solo in note musicali', fotografa l'agente confuso",
    "üì∏ Alle 19, vai in un ristorante etnico, chiedi al cameriere di tradurre il menu in 'linguaggio musicale', canta i piatti, fotografa la sua reazione",
    "üì∏ Vai al mercato. Chiedi a un fruttivendolo di cantare il prezzo delle zucchine come se fosse un'aria d'opera. Fotografa la sua performance",
    "üì∏ In pizzeria, convinci il pizzaiolo a lanciare in aria la pasta della pizza con un grido di battaglia musicale. Cattura l'acuto",
    "üì∏ Entra in un ufficio postale. Chiedi all'impiegato quale francobollo si abbina meglio a una sonata di Beethoven. Fotografa la sua logica perplessa",
    "üì∏ Convinci un estraneo alla fermata dell'autobus a fare un duetto di beatbox con te per 10 secondi. Fotografa il vostro ritmo improbabile",
    "üì∏ In un ristorante elegante, chiedi al cameriere di presentarti il piatto di pasta come se fosse il vincitore di un Grammy. Immortala la premiazione",
    "üì∏ A scuola, durante la ricreazione, organizza un flash mob di 30 secondi in cui tutti fingono di suonare violini invisibili. Fotografa il caos",
    "üì∏ Nel tuo ufficio, fotografa la reazione dei tuoi colleghi quando annunci solennemente che la riunione sar√† interamente cantata in Re minore",
    "üì∏ In un negozio di ferramenta, chiedi a un commesso di accordare due martelli. Fotografa il suo tentativo di trovare la nota giusta",
    "üì∏ Raduna tre amici. Entrate in un ascensore e, quando entra un estraneo, iniziate a cantare in armonia. Fotografa la sua reazione",
    "üì∏ Chiedi a un vigile urbano di posare come un direttore d'orchestra che sta per iniziare il forte finale. Cattura la sua autorevolezza",
    "üì∏ In un bar, chiedi al barista di crearti un cocktail ispirato al Blues. Fotografa la sua interpretazione liquida della tristezza",
    "üì∏ Entra in una biblioteca con un amico. Iniziate a leggere uno spartito musicale gesticolando animatamente, ma in totale silenzio. Fotografa chi vi osserva",
    "üì∏ Al supermercato, usa due porri come bacchette da batteria sul carrello. Chiedi a un altro cliente di darti il tempo. Fotografa il ritmo",
    "üì∏ In un negozio di scarpe, chiedi al commesso di battere il tempo mentre provi le scarpe per testarne la musicalit√†",
    "üì∏ Sfida un amico a mimare il testo di una canzone famosa in mezzo alla piazza. Fotografa gli estranei che cercano di indovinare il titolo",
    "üì∏ Porta un leggio in un fast food. Mettici sopra l'involucro del panino e suonalo seriamente con due cannucce. Fotografa i clienti",
    "üì∏ In treno, chiedi al tuo vicino di posto di tenere il La cantando per accordare la tua armonica. Fotografa la sua disponibilit√†",
    "üì∏ Organizza una battaglia di air guitar con un tuo collega nell'atrio dell'ufficio. Fai votare alla receptionist il vincitore",
    "üì∏ Vai in un parco. Chiedi a un passante di posare come la sua rockstar preferita per un ritratto epico",
    "üì∏ In una tabaccheria, chiedi un biglietto della lotteria intonato con la fortuna. Fotografa l'espressione del tabaccaio mentre cerca di capirti",
    "üì∏ Fai un ritratto al tuo migliore amico mentre cerca seriamente di insegnare il ritornello di una canzone pop al suo animale domestico",
    "üì∏ In pizzeria, alza il calice e proponi un brindisi solenne al grande compositore che ha inventato la Margherita. Fotografa i commensali confusi",
    "üì∏ Entra in un negozio di antiquariato. Chiedi all'antiquario se ha spartiti suonati da fantasmi. Fotografa la sua reazione divertita o spaventata",
    "üì∏ Al mercato, tu e un amico iniziate a contrattare il prezzo delle melanzane cantando, come in un recitativo d'opera",
    "üì∏ A scuola, convinci il bidello a posare con la sua scopa come se fosse una chitarra elettrica in un assolo infuocato",
    "üì∏ In un taxi, chiedi all'autista quale canzone lo fa guidare pi√π allegramente. Fagli un ritratto mentre te la descrive",
    "üì∏ Raduna cinque amici in un parco. Mettetevi in cerchio e cantate intensamente una canzone usando solo la parola Boh. Fotografatevi",
    "üì∏ Chiedi a un panettiere se la sua pagnotta ha una buona acustica. Fotografa la sua reazione mentre la bussa per fartela sentire",
    "üì∏ Al ristorante, fotografa la reazione dei tuoi amici quando provi a suonare le posate sul piatto per accompagnare la musica di sottofondo",
    "üì∏ In ufficio, avvia un applauso ritmico come We Will Rock You sulla scrivania. Fotografa i primi colleghi che si uniscono a te",
    "üì∏ Incontra un amico in un luogo affollato. Correte l'uno verso l'altro al rallentatore, mimando una scena d'amore da film muto. Fatevi fotografare",
    "üì∏ In una gelateria, chiedi un cono con due gusti che facciano un bell'accordo musicale, tipo un Do maggiore. Fotografa la scelta del gelataio",
    "üì∏ Vai in spiaggia. Convinci un gruppo di sconosciuti a formare una nota musicale umana sdraiandosi sulla sabbia. Fotografa dall'alto",
    "üì∏ In un negozio di abbigliamento, chiedi al manichino la sua opinione musicale sulla tua giacca. Fotografa la reazione del commesso che ti osserva",
    "üì∏ Chiedi a un amico di dirigere il traffico di un incrocio da un punto sicuro con una bacchetta finta. Fotografa la sua foga",
    "üì∏ Al ristorante, fotografa la reazione di un tavolo vicino quando tu e i tuoi amici assaggiate il vino e dichiarate: Ah, un ottimo Sol bemolle",
    "üì∏ In un museo, posizionati davanti a un ritratto antico e imita la sua posa. Fotografa i turisti che notano la vostra somiglianza",
    "üì∏ Chiedi a un estraneo di scattarti una foto, ma insisti perch√© urli CHEESE come un cantante d'opera al massimo della potenza",
    "üì∏ In ufficio, fotografa la faccia del tuo capo mentre gli presenti un report tenendo il ritmo di una marcia militare sulla scrivania",
    "üì∏ Vai in una palestra. Chiedi a qualcuno che solleva pesi di urlare Per Elisa invece di grugnire. Fotografa la sua performance",
    "üì∏ In farmacia, chiedi al farmacista una pastiglia per il mal di rock dopo un concerto. Fotografa la sua professionalit√† nel gestire la richiesta",
    "üì∏ Con un amico, mimate un duello con le spade usando due baguette appena comprate fuori da una panetteria. Fotografate il duello",
    "üì∏ Entra in un negozio di animali. Chiedi al commesso se i pappagalli preferiscono Vivaldi o Mozart. Fotografa la seriet√† della sua risposta",
    "üì∏ Al supermercato, metti una cassa di birra sulla spalla come un vecchio stereo. Fotografa i passanti nel reparto ortofrutta",
    "üì∏ A scuola, fotografa il professore di matematica nel momento esatto in cui gli chiedi se l'algebra ha un ritmo come la musica",
    "üì∏ Chiedi a un cameriere di un caff√® di disegnare una chiave di violino sulla schiuma del tuo cappuccino. Fotografa l'opera d'arte o il tentativo",
    "üì∏ Convinci l'autista dell'autobus a fermo a farsi un selfie con te mentre entrambi fate il gesto delle corna rock",
    "üì∏ In una libreria, chiedi a un cliente se un titolo suona bene se letto ad alta voce con un ritmo trap. Fotografa la sua analisi letteraria",
    "üì∏ Fai un ritratto a un amico mentre ascolta intensamente la musica proveniente da una conchiglia in pieno centro citt√†",
    "üì∏ Raduna i tuoi colleghi. Fate una foto di gruppo in ufficio, ma tutti devono posare come se foste sulla copertina di un album heavy metal",
    "üì∏ In metropolitana, annuncia solennemente: Il vagone successivo sar√† in Si bemolle. Fotografa chi controlla il vagone successivo",
    "üì∏ In un negozio di elettronica, conduci il muro di televisori come se fosse un'orchestra. Fotografa chi si ferma ad ascoltare",
    "üì∏ In palestra, chiedi a qualcuno su un tapis roulant di correre in un tempo di 6/8. Fotografa la sua falcata confusa",
    "üì∏ Al supermercato, inizia una conga line con i carrelli. Fatti fotografare da un amico mentre cerchi di convincere altri a unirsi",
    "üì∏ Vai in banca. Chiedi al cassiere se pu√≤ cambiarti 10‚Ç¨ in una melodia di monete. Fotografa il suo tentativo di accontentarti",
    "üì∏ Sali su un autobus affollato. Annuncia a voce alta: Come avrete notato, ho cambiato profumo. Fotografa la reazione pi√π impassibile",
    "üì∏ In un negozio di abbigliamento, vai nel camerino e urla: Ci sta! Ma non ho un palco!. Fotografa il commesso che accorre",
    "üì∏ Chiedi a un artista di strada di scambiare i ruoli per un minuto. Fatti fotografare mentre suoni il suo strumento male e lui ti fotografa",
    "üì∏ Con tre amici, attraversate le strisce pedonali imitando esattamente la copertina di Abbey Road. Fatevi fotografare da un quinto amico",
    "üì∏ In un fast food, ordina il tuo pasto cantando l'intero menu come se fosse un'ordinazione d'opera. Fotografa la cassiera",
    "üì∏ Al ristorante, quando il cameriere porta il piatto, alzati in piedi e inizia un applauso lento e solenne. Fotografa gli altri tavoli che ti imitano",
    "üì∏ In un museo, posizionati di fronte a una statua e inizia a intervistarla ad alta voce sulla sua vita. Fotografa gli altri visitatori",
    "üì∏ Chiedi a un tassista di suonare il clacson a ritmo di Tanti Auguri per celebrare la tua corsa. Fotografa il suo sorriso",
    "üì∏ In un negozio di animali, chiedi a un pesce rosso un consiglio sulla tua carriera musicale. Fotografa la reazione di un altro cliente",
    "üì∏ In un ascensore con estranei, girati verso di loro e chiedi: Allora... vi starete chiedendo perch√© vi ho riuniti qui oggi. Fotografa il panico",
    "üì∏ In ufficio, organizza un funerale solenne per una pianta d'ufficio morta, con tanto di elogio funebre. Fotografa i colleghi in lutto",
    "üì∏ In una biblioteca, mima una lotta furiosa con un amico, completa di colpi lenti e urla silenziose. Fotografa il bibliotecario",
    "üì∏ Al parco, trova due cani che giocano e narra la loro battaglia come un commentatore sportivo professionista. Fotografa i padroni",
    "üì∏ Chiedi a uno sconosciuto di tenerti la mano per 10 secondi per ristabilire il tuo equilibrio karmico-musicale. Fotografa la sua gentilezza",
    "üì∏ In una palestra, assisti un amico mentre usa il distributore dell'acqua. Con la massima seriet√†. Fotografa chi vi guarda",
    "üì∏ Vai in un negozio di vernici. Tieni un casting per il Colore dell'Anno e chiedi agli altri clienti di votare tra due campioni assurdi",
    "üì∏ Al supermercato, sdraiati svenuto nel corridoio dei cereali. Chiedi a un amico di fotografare la prima persona che si ferma ad aiutarti",
    "üì∏ In treno, fingi di parlare al telefono ad alta voce: S√¨, ho il La. Lo porto. No, il La! IL LA!. Fotografa i tuoi vicini musicisti",
    "üì∏ A scuola, durante una lezione noiosa, fai cadere una singola biglia. Fotografa i volti che seguono il suo rumore mentre rotola",
    "üì∏ In un ristorante, scambia di posto con tutti i tuoi amici ogni volta che uno di loro torna dal bagno. Fotografa la confusione",
    "üì∏ In un negozio di scarpe, testa l'acustica di uno stivale parlandoci dentro come se fosse un microfono. Fotografa il commesso",
    "üì∏ Al mercato, dirigi il brusio della folla come se fosse un coro caotico. Fatti fotografare con la bacchetta alzata",
    "üì∏ Chiedi a un poliziotto se l'uniforme suona bene. Fotografa la sua risposta orgogliosa o confusa",
    "üì∏ In un bar, chiedi un caff√® decaffeinato, ma artisticamente intenso. Fotografa l'impegno del barista nel prepararlo",
    "üì∏ Con un amico, in una piazza affollata, iniziate una battaglia di complimenti a voce alta. Sei magnifico! No, tu sei sublime!",
    "üì∏ In un negozio di giocattoli, chiedi al commesso se hanno strumenti musicali per anime tormentate. Fotografa la sua proposta",
    "üì∏ In ufficio, ogni volta che la stampante finisce un lavoro, annuncia: Il Maestro ha concluso!. Fotografa le reazioni alla terza stampa",
    "üì∏ Chiedi a un cameriere di raccontarti la biografia del pollo che stai per ordinare. Fotografa la sua improvvisazione",
    "üì∏ Inizia a battere le mani lentamente in una coda affollata. Continua ad accelerare. Fotografa chi si unisce al ritmo",
    "üì∏ In una libreria, chiedi a un commesso di trovarti un libro nella tonalit√† di Mi minore. Fotografa il libro che ti consiglia",
    "üì∏ Con un amico, mimate una discussione usando solo titoli di canzoni. Fotografa gli estranei che cercano di capire il litigio",
    "üì∏ In un taxi, chiedi all'autista di seguire quell'auto a caso. Fotografa la sua reazione da film d'azione",
    "üì∏ In un parco, siediti su una panchina e intervista un piccione per il tuo podcast. Fai domande serie. Fotografa i passanti",
    "üì∏ Vai al banco del pesce. Chiedi a un'orata se ha mai sentito il blues del mare. Fotografa il pescivendolo",
    "üì∏ In un negozio di abbigliamento, chiedi a un manichino la sua opinione sul tuo outfit. Fotografa la reazione di chi ti sente",
    "üì∏ A scuola, alza la mano e chiedi al professore se la sua spiegazione sar√† nella versione estesa o nel radio edit",
    "üì∏ Con due amici, state fermi in un angolo e guardate intensamente un punto sul soffitto. Fotografa la folla che si raduna per vedere cosa c'√®",
    "üì∏ Entra in un negozio di antiquariato. Chiedi quanto costa il silenzio in quella stanza. Fotografa la riflessione dell'antiquario",
    "üì∏ Paga un parcheggio a un estraneo. Lascia un biglietto: Questa sosta √® sponsorizzata dalla Musica. Buona giornata. Fai una foto all'auto",
    "üì∏ Al ristorante, assaggia l'acqua e mandala indietro perch√© non √® abbastanza frizzante emotivamente. Fotografa il cameriere",
    "üì∏ In spiaggia, organizza una gara di corsa al rallentatore con i tuoi amici. Fotografa il vincitore che arriva lentamente al traguardo",
    "üì∏ In un negozio di ferramenta, chiedi a un commesso di accordare un trapano. Fotografa il suo tentativo di trovare la nota",
    "üì∏ In ufficio, proponi un brindisi con le spillatrici per celebrare la fine della giornata lavorativa. Fotografa il cin-cin",
    "üì∏ Chiedi a un estraneo di scattarti una foto, ma invece di un telefono, dagli una banana e mettiti in posa. Fotografa la sua confusione",
    "üì∏ In ascensore, poco prima che le porte si aprano al tuo piano, di' agli altri: Ricordate, questa conversazione non √® mai avvenuta. Fotografa l'uscita"
];

function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

// ==================== FUNZIONI PROFILO UTENTE ====================

function loadUserProfile() {
    const saved = localStorage.getItem('bontempUserProfile');
    if (saved) {
        userProfile = JSON.parse(saved);
        console.log('üìä Profilo caricato:', userProfile.name);
        // Pre-compila il campo nome se esiste
        const nameInput = document.getElementById('userName');
        if (nameInput && userProfile.name) {
            nameInput.value = userProfile.name;
        }
    } else {
        console.log('üìä Nuovo utente');
    }
}

function saveUserProfile() {
    localStorage.setItem('bontempUserProfile', JSON.stringify(userProfile));
    console.log('üíæ Profilo salvato');
}

function updateStreak() {
    const today = new Date().toDateString();
    const lastPlay = userProfile.stats.lastPlayDate;

    if (!lastPlay) {
        userProfile.stats.streak = 1;
    } else {
        const lastDate = new Date(lastPlay);
        const diffDays = Math.floor((new Date(today) - new Date(lastDate.toDateString())) / (1000 * 60 * 60 * 24));

        if (diffDays === 0) {
            // Stesso giorno, mantieni streak
        } else if (diffDays === 1) {
            // Giorno consecutivo
            userProfile.stats.streak++;
        } else {
            // Streak interrotto
            userProfile.stats.streak = 1;
        }
    }

    userProfile.stats.lastPlayDate = today;
}

function saveQuizResult(quizMode, score, correctAnswers, totalQuestions) {
    const result = {
        date: new Date().toISOString(),
        mode: quizMode,
        score: score,
        correct: correctAnswers,
        total: totalQuestions
    };

    userProfile.quizHistory.push(result);
    userProfile.stats.totalQuizzes++;

    // Aggiorna best score
    if (score > userProfile.stats.quizBestScore) {
        userProfile.stats.quizBestScore = score;
    }

    // Calcola media
    const total = userProfile.quizHistory.reduce((sum, q) => sum + q.score, 0);
    userProfile.stats.quizAverage = Math.round(total / userProfile.quizHistory.length);

    updateStreak();
    saveUserProfile();
    console.log('‚úÖ Quiz salvato:', quizMode, score);
}

function saveChallengeResult(difficulty, score, completed, skipped) {
    const result = {
        date: new Date().toISOString(),
        difficulty: difficulty,
        score: score,
        completed: completed,
        skipped: skipped
    };

    userProfile.challengeHistory.push(result);
    userProfile.stats.totalChallenges++;

    // Aggiorna best score
    if (score > userProfile.stats.challengeBestScore) {
        userProfile.stats.challengeBestScore = score;
    }

    // Calcola media
    const total = userProfile.challengeHistory.reduce((sum, c) => sum + c.score, 0);
    userProfile.stats.challengeAverage = Math.round(total / userProfile.challengeHistory.length);

    updateStreak();
    saveUserProfile();
    console.log('‚úÖ Challenge salvata:', difficulty, score);
}

function getAchievements() {
    const achievements = [];

    // Achievement Quiz
    if (userProfile.stats.totalQuizzes >= 1) achievements.push({ icon: 'üéµ', name: 'Primo Quiz', desc: 'Hai completato il tuo primo quiz!' });
    if (userProfile.stats.totalQuizzes >= 10) achievements.push({ icon: 'üé∏', name: 'Quiz Esperto', desc: '10 quiz completati!' });
    if (userProfile.stats.totalQuizzes >= 50) achievements.push({ icon: 'üèÜ', name: 'Maestro Quiz', desc: '50 quiz completati!' });
    if (userProfile.stats.quizBestScore >= 90) achievements.push({ icon: '‚≠ê', name: 'Quasi Perfetto', desc: 'Score 90+ in un quiz!' });
    if (userProfile.stats.quizBestScore === 100) achievements.push({ icon: 'üíØ', name: 'Perfezione', desc: 'Score perfetto 100/100!' });

    // Achievement Challenge
    if (userProfile.stats.totalChallenges >= 1) achievements.push({ icon: 'üì∏', name: 'Prima Sfida', desc: 'Hai completato la tua prima sfida!' });
    if (userProfile.stats.totalChallenges >= 25) achievements.push({ icon: 'üéØ', name: 'Fotografo Esperto', desc: '25 sfide completate!' });
    if (userProfile.stats.totalChallenges >= 100) achievements.push({ icon: 'üåü', name: 'Centurione', desc: '100 sfide completate!' });

    // Achievement AUDACI
    const audaciCount = userProfile.challengeHistory.filter(c => c.difficulty === 'audace').length;
    if (audaciCount >= 10) achievements.push({ icon: 'üî•', name: 'Spirito Audace', desc: '10 sfide AUDACI!' });
    if (audaciCount >= 50) achievements.push({ icon: 'üí™', name: 'Senza Paura', desc: '50 sfide AUDACI!' });

    // Achievement Streak
    if (userProfile.stats.streak >= 3) achievements.push({ icon: 'üî•', name: 'In Serie', desc: '3 giorni consecutivi!' });
    if (userProfile.stats.streak >= 7) achievements.push({ icon: 'üöÄ', name: 'Settimana Perfetta', desc: '7 giorni consecutivi!' });
    if (userProfile.stats.streak >= 30) achievements.push({ icon: 'üëë', name: 'Leggenda', desc: '30 giorni consecutivi!' });

    return achievements;
}

function clearUserProfile() {
    if (confirm('‚ö†Ô∏è Sei sicuro di voler cancellare TUTTI i tuoi dati?\n\nQuesta azione √® irreversibile!')) {
        localStorage.removeItem('bontempUserProfile');
        userProfile = {
            name: '',
            firstAccess: null,
            lastAccess: null,
            quizHistory: [],
            challengeHistory: [],
            stats: {
                totalQuizzes: 0,
                totalChallenges: 0,
                quizBestScore: 0,
                challengeBestScore: 0,
                quizAverage: 0,
                challengeAverage: 0,
                streak: 0,
                lastPlayDate: null
            }
        };
        alert('‚úÖ Dati cancellati. Ricarica la pagina.');
        location.reload();
    }
}

function showProfile() {
    // Nascondi altri schermi
    document.getElementById('welcomeScreen').classList.remove('active');
    document.getElementById('modeScreen').classList.remove('active');
    document.getElementById('gameScreen').classList.remove('active');
    document.getElementById('profileScreen').classList.add('active');

    const achievements = getAchievements();
    const baseCount = userProfile.challengeHistory.filter(c => c.difficulty === 'simple').length;
    const audaciCount = userProfile.challengeHistory.filter(c => c.difficulty === 'audace').length;

    // Formatta data primo accesso
    const firstAccessDate = userProfile.firstAccess
        ? new Date(userProfile.firstAccess).toLocaleDateString('it-IT')
        : 'Mai';

    // Ultimi 5 quiz
    const recentQuizzes = userProfile.quizHistory.slice(-5).reverse();
    const quizHistoryHTML = recentQuizzes.length > 0
        ? recentQuizzes.map(q => {
            const date = new Date(q.date).toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
            return `<div style="background: white; padding: 8px; border-radius: 5px; margin: 5px 0; font-size: 0.85em;">
                        <strong>${q.mode}</strong> - ${q.score}/100 (${q.correct}/${q.total}) - ${date}
                    </div>`;
          }).join('')
        : '<p style="color: #999; font-size: 0.85em;">Nessun quiz ancora completato</p>';

    // Ultimi 5 challenge
    const recentChallenges = userProfile.challengeHistory.slice(-5).reverse();
    const challengeHistoryHTML = recentChallenges.length > 0
        ? recentChallenges.map(c => {
            const date = new Date(c.date).toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
            const diff = c.difficulty === 'audace' ? 'üî• AUDACI' : '‚ú® BASE';
            return `<div style="background: white; padding: 8px; border-radius: 5px; margin: 5px 0; font-size: 0.85em;">
                        <strong>${diff}</strong> - ${c.score} punti (${c.completed} completate, ${c.skipped} saltate) - ${date}
                    </div>`;
          }).join('')
        : '<p style="color: #999; font-size: 0.85em;">Nessuna sfida ancora completata</p>';

    // Achievements HTML
    const achievementsHTML = achievements.length > 0
        ? achievements.map(a => `
            <div style="background: white; padding: 10px; border-radius: 8px; margin: 8px 0; border-left: 4px solid #51cf66;">
                <div style="font-size: 1.2em;">${a.icon} <strong>${a.name}</strong></div>
                <div style="font-size: 0.85em; color: #666;">${a.desc}</div>
            </div>
          `).join('')
        : '<p style="color: #999; font-size: 0.85em;">Completa quiz e sfide per sbloccare achievements!</p>';

    document.getElementById('profileArea').innerHTML = `
        <div style="padding: 20px;">
            <h2 style="text-align: center; margin-bottom: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                üìä IL MIO PROFILO
            </h2>

            <!-- Info Utente -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 15px; color: white; margin-bottom: 20px;">
                <h3 style="margin: 0 0 10px 0; font-size: 1.5em;">üë§ ${userProfile.name || 'Studente'}</h3>
                <p style="margin: 5px 0; font-size: 0.9em;">üéÆ Membro dal: ${firstAccessDate}</p>
                <p style="margin: 5px 0; font-size: 0.9em;">üî• Streak: ${userProfile.stats.streak} giorni consecutivi</p>
            </div>

            <!-- Statistiche Quiz -->
            <div style="background: #e7f5ff; padding: 15px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid #1c7ed6;">
                <h3 style="color: #1c7ed6; margin-bottom: 12px; font-size: 1.1em;">üéµ QUIZ MUSICALI</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                    <div style="background: white; padding: 10px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 0.8em; color: #666;">Partite</div>
                        <div style="font-size: 1.5em; font-weight: bold; color: #1c7ed6;">${userProfile.stats.totalQuizzes}</div>
                    </div>
                    <div style="background: white; padding: 10px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 0.8em; color: #666;">Best Score</div>
                        <div style="font-size: 1.5em; font-weight: bold; color: #1c7ed6;">${userProfile.stats.quizBestScore}/100</div>
                    </div>
                </div>
                <div style="background: white; padding: 10px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 0.8em; color: #666;">Media</div>
                    <div style="font-size: 1.5em; font-weight: bold; color: #1c7ed6;">${userProfile.stats.quizAverage}/100</div>
                </div>
            </div>

            <!-- Statistiche Challenge -->
            <div style="background: #fff3cd; padding: 15px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid #f5576c;">
                <h3 style="color: #f5576c; margin-bottom: 12px; font-size: 1.1em;">üì∏ PHOTO CHALLENGE</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                    <div style="background: white; padding: 10px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 0.8em; color: #666;">Totali</div>
                        <div style="font-size: 1.5em; font-weight: bold; color: #f5576c;">${userProfile.stats.totalChallenges}</div>
                    </div>
                    <div style="background: white; padding: 10px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 0.8em; color: #666;">BASE</div>
                        <div style="font-size: 1.5em; font-weight: bold; color: #51cf66;">${baseCount}</div>
                    </div>
                    <div style="background: white; padding: 10px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 0.8em; color: #666;">AUDACI</div>
                        <div style="font-size: 1.5em; font-weight: bold; color: #f76707;">${audaciCount}</div>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div style="background: white; padding: 10px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 0.8em; color: #666;">Best Score</div>
                        <div style="font-size: 1.5em; font-weight: bold; color: #f5576c;">${userProfile.stats.challengeBestScore}</div>
                    </div>
                    <div style="background: white; padding: 10px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 0.8em; color: #666;">Media</div>
                        <div style="font-size: 1.5em; font-weight: bold; color: #f5576c;">${userProfile.stats.challengeAverage}</div>
                    </div>
                </div>
            </div>

            <!-- Achievements -->
            <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid #ffd43b;">
                <h3 style="color: #ffd43b; margin-bottom: 12px; font-size: 1.1em; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">üèÜ ACHIEVEMENTS (${achievements.length})</h3>
                ${achievementsHTML}
            </div>

            <!-- Storico Quiz -->
            <details style="background: #e7f5ff; padding: 15px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid #1c7ed6;">
                <summary style="cursor: pointer; font-weight: bold; color: #1c7ed6; margin-bottom: 10px;">üìú Storico Quiz (ultimi 5)</summary>
                ${quizHistoryHTML}
            </details>

            <!-- Storico Challenge -->
            <details style="background: #fff3cd; padding: 15px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid #f5576c;">
                <summary style="cursor: pointer; font-weight: bold; color: #f5576c; margin-bottom: 10px;">üìú Storico Challenge (ultimi 5)</summary>
                ${challengeHistoryHTML}
            </details>

            <!-- Pulsante Cancella Dati -->
            <button onclick="clearUserProfile()" style="background: #dc3545; width: 100%; margin-top: 20px;">
                üóëÔ∏è Cancella Tutti i Dati
            </button>
        </div>
    `;
}

function backToMenu() {
    document.getElementById('profileScreen').classList.remove('active');
    document.getElementById('modeScreen').classList.add('active');
}

function updateScore() {
    document.getElementById('scoreValue').textContent = score;
    document.getElementById('roundValue').textContent = currentRound;
    document.getElementById('maxRounds').textContent = maxRounds;
}

function createOverlayData() {
    return `
        <div class="overlay-data">
            <div class="data-item finger-0">
                <div class="data-content">
                    <div class="data-label"><div class="data-dot"></div>D1</div>
                    <div class="data-values">
                        <span><span class="data-val inactive" id="freq0">---</span>Hz</span>
                        <span>A:<span class="data-val inactive" id="amp0">--</span></span>
                    </div>
                </div>
            </div>
            <div class="data-item finger-1">
                <div class="data-content">
                    <div class="data-label"><div class="data-dot"></div>D2</div>
                    <div class="data-values">
                        <span><span class="data-val inactive" id="freq1">---</span>Hz</span>
                        <span>A:<span class="data-val inactive" id="amp1">--</span></span>
                    </div>
                </div>
            </div>
            <div class="data-item finger-2">
                <div class="data-content">
                    <div class="data-label"><div class="data-dot"></div>D3</div>
                    <div class="data-values">
                        <span><span class="data-val inactive" id="freq2">---</span>Hz</span>
                        <span>A:<span class="data-val inactive" id="amp2">--</span></span>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function createAcousticPanel() {
    return `
        <div class="acoustic-panel" id="acousticPanel">
            <h4 id="presetNameDisplay"></h4>
            <div id="acousticDescription" style="margin-bottom: 5px; font-size: 0.8em; color: #ccc;"></div>
        </div>
    `;
}

function createRecordingControls() {
    return `
        <div class="recording-controls">
            <button class="record-btn" id="recordBtn" onclick="toggleRecording()">
                üî¥ Avvia Registrazione
            </button>
        </div>
    `;
}

function updateRealtimeData(f, freq, amp, active) {
    realtimeData[f] = { frequency: freq, amplitude: amp, active: active };
    let fe = document.getElementById('freq' + f);
    let ae = document.getElementById('amp' + f);
    if (fe) {
        fe.textContent = active ? Math.round(freq) : '---';
        fe.className = active ? 'data-val active' : 'data-val inactive';
    }
    if (ae) {
        ae.textContent = active ? (amp * 100).toFixed(0) : '--';
        ae.className = active ? 'data-val active' : 'data-val inactive';
    }
}

function showIndicator(text) {
    const indicator = document.createElement('div');
    indicator.className = 'demo-indicator';
    indicator.textContent = text;
    document.body.appendChild(indicator);
    setTimeout(() => indicator.remove(), 2500);
}

function showQuizFeedback(isCorrect, correctAnswer = '', timeBonus = 0) {
    const feedback = document.createElement('div');
    feedback.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: ${isCorrect ? 'linear-gradient(135deg, #51cf66, #2f9e44)' : 'linear-gradient(135deg, #ff6b6b, #e03131)'};
        color: white;
        padding: 25px 40px;
        border-radius: 15px;
        font-size: 1.2em;
        font-weight: bold;
        z-index: 100000;
        box-shadow: 0 10px 40px rgba(0,0,0,0.4);
        text-align: center;
        animation: feedbackPop 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    `;
    
    let bonusText = '';
    if (isCorrect && timeBonus > 0) {
        bonusText = `<div style="font-size: 0.8em; margin-top: 8px; color: #ffd700;">‚ö° Bonus velocit√†: +${timeBonus} punti!</div>`;
    }
    
    feedback.innerHTML = `
        <div style="font-size: 2.5em; margin-bottom: 8px;">${isCorrect ? '‚úÖ' : '‚ùå'}</div>
        <div>${isCorrect ? 'RISPOSTA CORRETTA!' : 'RISPOSTA ERRATA'}</div>
        ${correctAnswer ? `<div style="font-size: 0.75em; margin-top: 8px; opacity: 0.9;">Corretta: ${correctAnswer}</div>` : ''}
        ${isCorrect ? `<div style="font-size: 0.85em; margin-top: 6px;">+${10 + timeBonus} punti</div>` : ''}
        ${bonusText}
    `;
    
    document.body.appendChild(feedback);
    
    setTimeout(() => {
        feedback.style.animation = 'feedbackFadeOut 0.3s ease-out forwards';
        setTimeout(() => feedback.remove(), 300);
    }, 3000);
}

// ==================== CONDIVISIONE SOCIAL ====================
function condividiWhatsApp() {
    const text = encodeURIComponent('üéµ Scopri BontempApp - L\'app musicale interattiva!\n\nüé® Disegna e crea suoni in 2D e 3D\nüéØ Quiz su Jazz, Classica e Musica del \'900\nüì∏ Sfide fotografiche creative\nüß† Curiosit√† musicali\n\nGratis e installabile su qualsiasi dispositivo!\n\nüëâ https://bontempapp.soundscapestudio.org');
    const url = `https://wa.me/?text=${text}`;
    window.open(url, '_blank');
}

function condividiFacebook() {
    const url = encodeURIComponent(window.location.href);
    const fbUrl = `https://www.facebook.com/sharer/sharer.php?u=${url}`;
    window.open(fbUrl, '_blank', 'width=600,height=400');
}

// ==================== FEEDBACK ====================
function inviaFeedback() {
    const messaggio = prompt('üí¨ Lascia il tuo feedback o commento:\n(Sar√† inviato via email)');

    if (messaggio && messaggio.trim() !== '') {
        const subject = encodeURIComponent('Feedback BontempApp');
        const body = encodeURIComponent(`Feedback dall'app BontempApp:\n\n${messaggio}\n\n---\nInviato da: ${navigator.userAgent}`);
        const mailtoLink = `mailto:artistmentalhealth@gmail.com?subject=${subject}&body=${body}`;

        window.location.href = mailtoLink;

        setTimeout(() => {
            showIndicator('‚úÖ Grazie per il tuo feedback!');
        }, 500);
    } else if (messaggio !== null) {
        showIndicator('‚ö†Ô∏è Il messaggio non pu√≤ essere vuoto');
    }
}

function iniziaGioco() {
    userName = document.getElementById('userName').value.trim() || 'Studente';
    document.getElementById('playerName').textContent = userName;

    // Salva nome e aggiorna date accesso
    userProfile.name = userName;
    if (!userProfile.firstAccess) {
        userProfile.firstAccess = new Date().toISOString();
    }
    userProfile.lastAccess = new Date().toISOString();
    saveUserProfile();

    initAudio();

    document.getElementById('welcomeScreen').classList.remove('active');
    document.getElementById('modeScreen').classList.add('active');
}

function backToWelcome() {
    stopRecording();
    stopAllAudio();
    stopQuizTimer();
    document.getElementById('modeScreen').classList.remove('active');
    document.getElementById('welcomeScreen').classList.add('active');
}

function selectMode(mode) {
    debugLog('Modalit√† selezionata:', mode);
    currentMode = mode;
    score = 0;
    currentRound = 1;

    // For challenge mode, show difficulty selection first
    if (mode === 'challenge') {
        showDifficultySelection();
        return;
    }

    showInstructions();
}

function showDifficultySelection() {
    const gameArea = document.getElementById('gameArea');
    document.getElementById('modeScreen').classList.remove('active');
    document.getElementById('gameScreen').classList.add('active');

    const modeTitle = 'üì∏ Photo Challenge';

    gameArea.innerHTML = `
        <div style="text-align: center; padding: 20px;">
            <h2 style="margin-bottom: 20px;">${modeTitle}</h2>
            <p style="font-size: 0.9em; color: #666; margin-bottom: 30px;">
                Scegli il livello di difficolt√† delle sfide:
            </p>

            <div style="display: flex; flex-direction: column; gap: 15px; max-width: 400px; margin: 0 auto;">
                <div class="difficulty-card" onclick="selectDifficulty('simple')" style="background: linear-gradient(135deg, #51cf66, #37b24d); color: white; padding: 25px; border-radius: 15px; cursor: pointer; transition: transform 0.2s;">
                    <div style="font-size: 2.5em; margin-bottom: 10px;">üòä</div>
                    <h3 style="margin: 10px 0;">BASE</h3>
                    <p style="font-size: 0.85em; margin: 10px 0; opacity: 0.9;">
                        100 sfide concettuali e ironiche<br>
                        <strong>Spirito Osservatore</strong>
                    </p>
                    <p style="font-size: 0.75em; margin-top: 10px; opacity: 0.8;">
                        Comode e creative!
                    </p>
                </div>

                <div class="difficulty-card" onclick="selectDifficulty('audace')" style="background: linear-gradient(135deg, #ff6b6b, #e03131); color: white; padding: 25px; border-radius: 15px; cursor: pointer; transition: transform 0.2s;">
                    <div style="font-size: 2.5em; margin-bottom: 10px;">üî•</div>
                    <h3 style="margin: 10px 0;">AUDACI</h3>
                    <p style="font-size: 0.85em; margin: 10px 0; opacity: 0.9;">
                        100 sfide performative e imbarazzanti<br>
                        <strong>Spirito Performativo</strong>
                    </p>
                    <p style="font-size: 0.75em; margin-top: 10px; opacity: 0.8;">
                        Coinvolgi altre persone!
                    </p>
                </div>
            </div>

            <button onclick="backToModes()" style="margin-top: 30px; background: #868e96;">
                ‚óÄ Indietro
            </button>
        </div>
    `;
}

function selectDifficulty(difficulty) {
    challengeDifficulty = difficulty;

    // Inizializza/resetta il mazzo shuffled per la difficolt√† selezionata
    if (difficulty === 'audace') {
        // Se il mazzo AUDACI √® vuoto o finito, ricrea e mescola
        if (shuffledAudaciChallenges.length === 0 || audaciIndex >= shuffledAudaciChallenges.length) {
            shuffledAudaciChallenges = shuffleArray([...photoChallengesAudaci]);
            audaciIndex = 0;
            console.log('üîÄ Mazzo AUDACI mescolato:', shuffledAudaciChallenges.length, 'sfide');
        }
    } else {
        // Se il mazzo BASE √® vuoto o finito, ricrea e mescola
        if (shuffledBaseChallenges.length === 0 || baseIndex >= shuffledBaseChallenges.length) {
            shuffledBaseChallenges = shuffleArray([...photoChallengesBase]);
            baseIndex = 0;
            console.log('üîÄ Mazzo BASE mescolato:', shuffledBaseChallenges.length, 'sfide');
        }
    }

    showInstructions();
}

function showApiGuide() {
    document.getElementById('apiGuideModal').classList.add('active');
}

function closeApiGuide() {
    document.getElementById('apiGuideModal').classList.remove('active');
    requestApiKey();
}

function requestApiKey() {
    const key = prompt('üîë INCOLLA QUI LA TUA API KEY GOOGLE GEMINI\n\n(Esempio: AIzaSyD...)');
    if (key && key.trim().length > 30) {
        apiKey = key.trim();
        localStorage.setItem('geminiApiKey', apiKey);
        alert('‚úÖ API Key salvata!');
        showInstructions();
    } else {
        backToModes();
    }
}

function showInstructions() {
    const modal = document.getElementById('instructionsModal');
    const content = document.getElementById('instructionsContent');
    let instructions = '';

    if (currentMode === '2d') instructions = '<h3>üé® Disegno 2D Libero</h3><p style="font-size:0.9em">Tocca e muovi per disegnare con audio sempre attivo! Usa il pulsante Registra per salvare!</p>';
    else if (currentMode === '2d-guided') instructions = '<h3>üéØ Disegno 2D Guidato</h3><p style="font-size:0.9em">Scegli preset dal menu Demo e segui le guide animate con audio! Registra le performance!</p>';
    else if (currentMode === '3d') instructions = '<h3>üåç Disegno 3D Libero</h3><p style="font-size:0.9em">Disegna nello spazio tridimensionale con audio spaziale! Registra le creazioni!</p>';
    else if (currentMode === '3d-guided') instructions = '<h3>‚ú® Disegno 3D Guidato</h3><p style="font-size:0.9em">Esplora 10 preset 3D con demo automatiche e audio! Registra tutto!</p>';
    else if (currentMode === 'challenge') instructions = `<h3>üì∏ Photo Challenge</h3><p style="font-size:0.9em">Ricevi una sfida ${challengeDifficulty === 'simple' ? 'BASE' : 'AUDACE'} tra le 200 disponibili, scatta foto e completa la sfida!</p>`;
    else if (currentMode === 'curiosita') instructions = '<h3>üß† Curiosit√†</h3><p style="font-size:0.9em">Leggi curiosit√† musicali ...</p>';
    else if (currentMode.startsWith('quiz-')) instructions = '<h3>üéµ Quiz Musicale</h3><p style="font-size:0.9em">Scegli difficolt√† e rispondi alle domande! <strong>Pi√π veloce = pi√π punti!</strong> Timer: 30 secondi per domanda.</p>';

    content.innerHTML = instructions;
    modal.classList.add('active');

    // Chiudi automaticamente dopo 2.5 secondi
    setTimeout(() => {
        proceedToGame();
    }, 2500);
}

function proceedToGame() {
    document.getElementById('instructionsModal').classList.remove('active');
    
    if (currentMode.startsWith('quiz-')) {
        showDifficultySelector();
    } else {
        startGame();
    }
}

function showDifficultySelector() {
    const gameArea = document.getElementById('gameArea');
    gameArea.innerHTML = `
        <h2 style="text-align: center; color: #667eea; margin-bottom: 10px; font-size: 1.1em;">Scegli difficolt√†</h2>
        <div class="difficulty-selector">
            <div class="difficulty-btn" onclick="selectQuizDifficulty('facile')">
                <h3 style="font-size: 1em;">üòä Facile</h3><p style="font-size: 0.8em;">Domande base</p>
            </div>
            <div class="difficulty-btn" onclick="selectQuizDifficulty('medio')">
                <h3 style="font-size: 1em;">ü§î Medio</h3><p style="font-size: 0.8em;">Pi√π impegnative</p>
            </div>
            <div class="difficulty-btn" onclick="selectQuizDifficulty('avanzato')">
                <span class="api-required">API</span>
                <h3 style="font-size: 1em;">üß† Avanzato</h3><p style="font-size: 0.8em;">Risposte libere + AI!</p>
            </div>
        </div>
        <button onclick="backToModes()" style="margin-top: 20px; background: #868e96; width: 100%;">
            ‚óÄ Indietro
        </button>
    `;
    document.getElementById('modeScreen').classList.remove('active');
    document.getElementById('gameScreen').classList.add('active');
}

function selectQuizDifficulty(level) {
    currentDifficulty = level;
    isExpertMode = (level === 'avanzato');
    
    if (isExpertMode && !apiKey) {
        alert('‚ö†Ô∏è Livello Avanzato richiede API Key!');
        showApiGuide();
        return;
    }
    
    // MODIFICA: Prende domande RANDOM da tutto il pool invece che le prime N
    let questionPool = [];
    if (currentMode === 'quiz-novecento') questionPool = [...quizNovecento[level]];
    else if (currentMode === 'quiz-jazz') questionPool = [...quizJazz[level]];
    else if (currentMode === 'quiz-classica') questionPool = [...quizClassica[level]];
    
    // Mischia TUTTE le domande e prendi maxRounds casuali
    currentQuestions = shuffleArray(questionPool).slice(0, maxRounds);
    startGame();
}

function startGame() {
    document.getElementById('modeScreen').classList.remove('active');
    document.getElementById('gameScreen').classList.add('active');
    
    if (!['curiosita', '2d', '2d-guided', '3d', '3d-guided'].includes(currentMode)) {
        document.getElementById('scoreContainer').style.display = 'block';
        updateScore();
    }
    
    debugLog('Avvio modalit√†:', currentMode);
    
    if (currentMode === '2d') startDrawing2D(false);
    else if (currentMode === '2d-guided') startDrawing2D(true);
    else if (currentMode === '3d') startDrawing3D(false);
    else if (currentMode === '3d-guided') startDrawing3D(true);
    else if (currentMode === 'challenge') startPhotoChallenge();
    else if (currentMode === 'curiosita') startCuriosita();
    else if (currentMode.startsWith('quiz-')) startQuiz();
}

function backToModes() {
    stopRecording();
    stopAllAudio();
    stopQuizTimer();
    activeTouches.clear();
    touchIdToFingerIndex.clear();
    nextFingerIndex = 0;
    demoMode = false;
    audioGuidedMode = false;
    
    if (guideAnimationId) {
        cancelAnimationFrame(guideAnimationId);
        guideAnimationId = null;
    }
    
    if (animationLoopId) {
        cancelAnimationFrame(animationLoopId);
        animationLoopId = null;
    }
    
    if (renderer3d) {
        try { renderer3d.domElement.remove(); } catch(e) {}
        renderer3d = null;
        scene3d = null;
        camera3d = null;
        meshes3d = [];
        guideMeshes3d = [];
    }
    
    if (curiositaTimer) clearInterval(curiositaTimer);
    
    guideBalls = [];
    guidesEnabled = false;
    guideTime = 0;
    score = 0;
    currentRound = 1;
    
    document.getElementById('gameScreen').classList.remove('active');
    document.getElementById('resultsModal').classList.remove('active');
    document.getElementById('modeScreen').classList.add('active');
}

// Alias per compatibilit√†
function goHome() {
    backToModes();
}

function startDrawing2D(withGuides) {
    guidesEnabled = withGuides;
    currentPreset = 'harmonic';
    
    let g = document.getElementById('gameArea');
    g.innerHTML = `
        <div class="info-box">
            <strong>üé® 2D Audio${withGuides ? ' Guidato' : ''}</strong> - Audio sempre attivo! üîä<br>
            ${withGuides ? 'Clicca su un preset: la demo parte automaticamente con audio!' : 'Tocca e muovi: Y = Frequenza'}
        </div>
        <div class="compact-controls">
            <div class="control-group">
                <button onclick="openScaleModal()" style="background: #9775fa; padding: 4px 10px; font-size: 0.75em; margin: 0;">üéµ Scale</button>
                <button onclick="openKeyModal()" style="background: #e67700; padding: 4px 10px; font-size: 0.75em; margin: 0;">üéπ Tonalit√†</button>
                <button onclick="openTimbreModal()" style="background: #fd7e14; padding: 4px 10px; font-size: 0.75em; margin: 0;">üé∏ Strumento</button>
                <button onclick="openGalleryModal()" style="background: #0ca678; padding: 4px 10px; font-size: 0.75em; margin: 0;">üìπ Galleria</button>
                ${withGuides ? `
                <button onclick="openDemoModal()" id="demoBtn" style="background: #28a745; padding: 4px 10px; font-size: 0.75em; margin: 0;">üé≠ Menu Demo</button>
                <div class="speed-control"><label>‚ö°</label><input type="range" id="speedSlider" min="0.3" max="2" step="0.1" value="1" onchange="guideSpeed=parseFloat(this.value)"></div>
                ` : ''}
            </div>
        </div>
        <div class="canvas-container" id="canvasContainer2D">
            <canvas id="drawingCanvas"></canvas>
        </div>
        ${createOverlayData()}
        ${withGuides ? createAcousticPanel() : ''}
        ${createRecordingControls()}
    `;
    
    canvas = document.getElementById('drawingCanvas');
    ctx = canvas.getContext('2d');
    canvas.width = canvas.parentElement.clientWidth;
    canvas.height = 250;
    
    canvas.addEventListener('touchstart', handleTouch2D, { passive: false });
    canvas.addEventListener('touchmove', handleTouch2D, { passive: false });
    canvas.addEventListener('touchend', endTouch2D, { passive: false });
    
    initAudio();
    
    if (withGuides) {
        initGuides2D();
        animateGuides2D();
        updateAcousticDescription2D();
    }
}

function initGuides2D() {
    const container = document.getElementById('canvasContainer2D');
    guideBalls = [];
    for (let i = 0; i < 3; i++) {
        const ball = document.createElement('div');
        ball.className = `guide-ball guide-ball-${i}`;
        container.appendChild(ball);
        guideBalls.push(ball);
    }
}

function animateGuides2D() {
    if (!guidesEnabled || guideBalls.length === 0) return;

    // Se demoMode √® false, ferma l'animazione
    if (!demoMode) {
        guideAnimationId = null;
        return;
    }

    guideTime += 0.016 * guideSpeed;
    const w = canvas.width;
    const h = canvas.height;
    const preset = presets2DGeometric[currentPreset] || presets2DReal[currentPreset];
    if (!preset) return;

    guideBalls.forEach((ball, i) => {
        const pos = preset.calculate(guideTime, w, h, i);
        ball.style.left = pos.x + 'px';
        ball.style.top = pos.y + 'px';
        if (demoMode) simulateTouch2D(i, pos.x, pos.y);
    });
    guideAnimationId = requestAnimationFrame(animateGuides2D);
}

function updateAcousticDescription2D(presetCategory) {
    const preset = presetCategory 
        ? presetCategory[currentPreset]
        : (presets2DGeometric[currentPreset] || presets2DReal[currentPreset]);
    if (!preset) return;
    const panel = document.getElementById('presetNameDisplay');
    const desc = document.getElementById('acousticDescription');
    if (panel) panel.textContent = preset.name;
    if (desc) desc.textContent = preset.acousticInfo;
}

function handleTouch2D(e) {
    if (demoMode) return;
    e.preventDefault();
    
    if (sharedAudioContext && sharedAudioContext.state === 'suspended') {
        sharedAudioContext.resume();
    }
    
    let rect = canvas.getBoundingClientRect();
    for (let i = 0; i < e.touches.length && i < 3; i++) {
        let t = e.touches[i];
        let x = t.clientX - rect.left;
        let y = t.clientY - rect.top;
        let id = t.identifier;
        
        if (!touchIdToFingerIndex.has(id) && nextFingerIndex < 3) {
            touchIdToFingerIndex.set(id, nextFingerIndex);
            nextFingerIndex++;
        }
        
        let f = touchIdToFingerIndex.get(id);
        if (f !== undefined) {
            if (activeTouches.has(id)) {
                let old = activeTouches.get(id);
                ctx.strokeStyle = touchColors[f];
                ctx.lineWidth = 4;
                ctx.beginPath();
                ctx.moveTo(old.x, old.y);
                ctx.lineTo(x, y);
                ctx.stroke();
            }
            activeTouches.set(id, { x, y, fingerIndex: f });
            createAudio(id, y, f, canvas.height);
        }
    }
}

function endTouch2D(e) {
    if (demoMode) return;
    e.preventDefault();
    for (let i = 0; i < e.changedTouches.length; i++) {
        let id = e.changedTouches[i].identifier;
        let d = activeTouches.get(id);
        if (d) stopAudio(id, d.fingerIndex);
        activeTouches.delete(id);
        touchIdToFingerIndex.delete(id);
        if (nextFingerIndex > 0) nextFingerIndex--;
    }
}

function simulateTouch2D(fingerIndex, x, y) {
    const touchId = 'demo-' + fingerIndex;
    if (demoTouches[fingerIndex]) {
        const old = demoTouches[fingerIndex];
        ctx.strokeStyle = touchColors[fingerIndex];
        ctx.lineWidth = audioGuidedMode ? 6 : 4;
        ctx.beginPath();
        ctx.moveTo(old.x, old.y);
        ctx.lineTo(x, y);
        ctx.stroke();
    }
    demoTouches[fingerIndex] = { x, y };
    createAudio(touchId, y, fingerIndex, canvas.height);
}

function toggleDemoMode() {
    demoMode = !demoMode;
    const btn = document.getElementById('demoBtn') || document.getElementById('demoBtn3D');

    debugLog('üé≠ toggleDemoMode - demoMode:', demoMode);

    if (demoMode) {
        if (btn) {
            btn.textContent = '‚è∏Ô∏è Stop Demo';
            btn.style.background = '#dc3545';
        }

        if (!sharedAudioContext || sharedAudioContext.state === 'closed') {
            initAudio();
        }
        if (sharedAudioContext.state === 'suspended') {
            debugLog('üîä Resume AudioContext per demo');
            sharedAudioContext.resume();
        }

        // Riavvia le animazioni se erano ferme
        if (guidesEnabled && guideBalls.length > 0 && !guideAnimationId) {
            debugLog('üé¨ Riavvio animazione 2D');
            animateGuides2D();
        }
        // Riavvia animazione 3D se necessario (l'animazione 3D continua sempre ma senza audio quando demoMode √® false)
        if (scene3d && camera3d && renderer3d && guideMeshes3d.length > 0) {
            debugLog('üé¨ Audio 3D attivato per demo');
        }

    } else {
        if (btn) {
            btn.textContent = 'üé≠ Menu Demo';
            btn.style.background = '#28a745';
        }

        // Ferma tutte le animazioni in corso
        if (guideAnimationId) {
            cancelAnimationFrame(guideAnimationId);
            guideAnimationId = null;
        }
        if (animationLoopId) {
            cancelAnimationFrame(animationLoopId);
            animationLoopId = null;
        }

        // Reset demo touches
        demoTouches.forEach((touch, i) => {
            demoTouches[i] = null;
        });

        // Ferma TUTTI gli audio attivi usando stopAllAudio
        stopAllAudio();

        debugLog('üîá Demo fermata - Tutti gli audio interrotti');
    }
}

function startDrawing3D(withGuides) {
    guidesEnabled = withGuides;
    currentPreset = 'helix';
    
    let g = document.getElementById('gameArea');
    g.innerHTML = `
        <div class="info-box">
            <strong>üåç 3D Audio${withGuides ? ' Guidato' : ''}</strong> - Audio sempre attivo! üîä<br>
            ${withGuides ? '<strong>‚ú® DEMO AUTOMATICA CON AUDIO:</strong> Clicca preset per demo con suono!' : 'Disegna nello spazio 3D'}
        </div>
        <div class="compact-controls">
            <div class="control-group">
                <button onclick="openScaleModal()" style="background: #9775fa; padding: 4px 10px; font-size: 0.75em; margin: 0;">üéµ Scale</button>
                <button onclick="openKeyModal()" style="background: #e67700; padding: 4px 10px; font-size: 0.75em; margin: 0;">üéπ Tonalit√†</button>
                <button onclick="openTimbreModal()" style="background: #fd7e14; padding: 4px 10px; font-size: 0.75em; margin: 0;">üé∏ Strumento</button>
                <button onclick="openGalleryModal()" style="background: #0ca678; padding: 4px 10px; font-size: 0.75em; margin: 0;">üìπ Galleria</button>
                ${withGuides ? `
                <button onclick="openDemoModal()" id="demoBtn3D" style="background: #28a745; padding: 4px 10px; font-size: 0.75em; margin: 0;">üé≠ Menu Demo</button>
                <div class="speed-control"><label>‚ö°</label><input type="range" id="speedSlider3D" min="0.3" max="2" step="0.1" value="1" onchange="guideSpeed=parseFloat(this.value)"></div>
                ` : ''}
            </div>
        </div>
        <div class="canvas-container" id="canvas3dContainer"></div>
        ${createOverlayData()}
        ${withGuides ? createAcousticPanel() : ''}
        ${createRecordingControls()}
    `;
    
    init3DScene(withGuides);
    initAudio();
    
    if (withGuides) updateAcousticDescription3D();
}

function init3DScene(withGuides) {
    let c = document.getElementById('canvas3dContainer');
    let w = c.clientWidth;
    let h = 250;
    
    scene3d = new THREE.Scene();
    scene3d.background = new THREE.Color(0x1a1a2e);
    
    camera3d = new THREE.PerspectiveCamera(75, w / h, 0.1, 1000);
    camera3d.position.set(0, 3, 15);
    
    renderer3d = new THREE.WebGLRenderer({ antialias: true });
    renderer3d.setSize(w, h);
    renderer3d.domElement.style.borderRadius = '12px';
    renderer3d.domElement.style.border = '2px solid #667eea';
    renderer3d.domElement.style.touchAction = 'none';
    renderer3d.domElement.style.width = '100%';
    c.appendChild(renderer3d.domElement);
    
    scene3d.add(new THREE.AmbientLight(0xffffff, 0.5));
    scene3d.add(new THREE.GridHelper(20, 20, 0x667eea, 0x333333));
    
    if (withGuides) initGuides3D();
    
    let lastPos = [null, null, null];
    
    renderer3d.domElement.addEventListener('touchstart', e => {
        e.preventDefault();
        activeTouchCount = e.touches.length; // Aggiorna conteggio tocchi
        if (sharedAudioContext && sharedAudioContext.state === 'suspended') {
            debugLog('üîä Resuming AudioContext on 3D touch');
            sharedAudioContext.resume();
        }
        for (let i = 0; i < e.changedTouches.length; i++) {
            let id = e.changedTouches[i].identifier;
            if (!touchIdToFingerIndex.has(id) && nextFingerIndex < 3) {
                touchIdToFingerIndex.set(id, nextFingerIndex);
                nextFingerIndex++;
            }
            let f = touchIdToFingerIndex.get(id);
            if (f !== undefined) lastPos[f] = null;
        }
    }, { passive: false });
    
    renderer3d.domElement.addEventListener('touchmove', e => {
        if (demoMode) return;
        e.preventDefault();
        activeTouchCount = e.touches.length; // Aggiorna conteggio tocchi
        let r = renderer3d.domElement.getBoundingClientRect();

        // Calcola profondit√† Z basata sul numero di dita (1 dito = vicino, 3 dita = lontano)
        let zDepth = -5 + (activeTouchCount - 1) * 5; // 1 dito: -5, 2 dita: 0, 3 dita: +5

        for (let i = 0; i < e.touches.length; i++) {
            let t = e.touches[i];
            let id = t.identifier;
            if (!touchIdToFingerIndex.has(id)) continue;
            let f = touchIdToFingerIndex.get(id);
            let tk = 't3d-' + id;
            let x = ((t.clientX - r.left) / r.width) * 2 - 1;
            let y = -((t.clientY - r.top) / r.height) * 2 + 1;

            // VERO 3D: X, Y, Z indipendenti!
            let pos = new THREE.Vector3(x * 10, y * 5, zDepth);

            drawIn3D(f, pos, lastPos[f]);
            lastPos[f] = pos.clone();
            let yPos = t.clientY - r.top;
            let freqY = r.height * (1 - yPos / r.height);

            // Passa posizione 3D completa all'audio
            createAudio(tk, freqY, f, r.height, pos);
        }
    }, { passive: false });
    
    renderer3d.domElement.addEventListener('touchend', e => {
        e.preventDefault();
        activeTouchCount = e.touches.length; // Aggiorna conteggio tocchi rimasti
        for (let i = 0; i < e.changedTouches.length; i++) {
            let id = e.changedTouches[i].identifier;
            if (!touchIdToFingerIndex.has(id)) continue;
            let f = touchIdToFingerIndex.get(id);
            lastPos[f] = null;
            stopAudio('t3d-' + id, f);
            touchIdToFingerIndex.delete(id);
            if (nextFingerIndex > 0) nextFingerIndex--;
        }
    }, { passive: false });
    
    animate3D();
}

function initGuides3D() {
    // Rimuovi le vecchie guide mesh se esistono
    if (guideMeshes3d.length > 0) {
        guideMeshes3d.forEach(mesh => {
            if (scene3d) {
                scene3d.remove(mesh);
                if (mesh.geometry) mesh.geometry.dispose();
                if (mesh.material) mesh.material.dispose();
            }
        });
    }
    guideMeshes3d = [];

    // Crea nuove guide mesh
    for (let i = 0; i < 3; i++) {
        const geometry = new THREE.SphereGeometry(0.3, 16, 16);
        const material = new THREE.MeshBasicMaterial({
            color: new THREE.Color(touchColors[i]),
            transparent: true,
            opacity: 0.8
        });
        const sphere = new THREE.Mesh(geometry, material);
        const light = new THREE.PointLight(new THREE.Color(touchColors[i]), 1, 10);
        sphere.add(light);
        scene3d.add(sphere);
        guideMeshes3d.push(sphere);
    }
}

function drawIn3D(f, pos, lastPos) {
    let col = new THREE.Color(touchColors[f]);
    if (lastPos && lastPos.distanceTo(pos) > 0.1) {
        let g = new THREE.BufferGeometry().setFromPoints([lastPos, pos]);
        let m = new THREE.LineBasicMaterial({ color: col, opacity: 0.8, transparent: true });
        let l = new THREE.Line(g, m);
        scene3d.add(l);
        meshes3d.push(l);
    }
    let sg = new THREE.SphereGeometry(audioGuidedMode ? 0.12 : 0.08, 8, 8);
    let sm = new THREE.MeshBasicMaterial({ color: col });
    let s = new THREE.Mesh(sg, sm);
    s.position.copy(pos);
    scene3d.add(s);
    meshes3d.push(s);
}

function animate3D() {
    if (!scene3d || !camera3d || !renderer3d) return;

    let time = Date.now() * 0.0001;
    camera3d.position.x = Math.sin(time) * 15;
    camera3d.position.z = Math.cos(time) * 15;
    camera3d.lookAt(0, 0, 0);

    if (guidesEnabled && guideMeshes3d.length > 0) {
        // Se demoMode √® false, non simulare touch ma continua a renderizzare
        if (demoMode) {
            guideTime += 0.016 * guideSpeed;
            const preset = presets3DGeometric[currentPreset] || presets3DReal[currentPreset];
            if (preset) {
                guideMeshes3d.forEach((sphere, i) => {
                    const pos = preset.calculate(guideTime, i);
                    sphere.position.set(pos.x, pos.y, pos.z);
                    simulateTouch3D(i, pos);
                });
            }
            // Non stampare warning se il preset non √® trovato (potrebbe essere un preset 2D)
        }
    }
    try { renderer3d.render(scene3d, camera3d); } catch (e) {}

    animationLoopId = requestAnimationFrame(animate3D);
}

function simulateTouch3D(fingerIndex, pos3d) {
    const touchId = 'demo3d-' + fingerIndex;

    const minY = -5;
    const maxY = 5;
    const normalizedY = Math.max(0, Math.min(1, (pos3d.y - minY) / (maxY - minY)));

    const virtualCanvasHeight = 250;
    const yPos = virtualCanvasHeight * (1 - normalizedY);

    if (demoTouches[fingerIndex]) {
        drawIn3D(fingerIndex, new THREE.Vector3(pos3d.x, pos3d.y, pos3d.z), demoTouches[fingerIndex]);
    }
    demoTouches[fingerIndex] = new THREE.Vector3(pos3d.x, pos3d.y, pos3d.z);

    if (sharedAudioContext) {
        if (sharedAudioContext.state === 'running') {
            createAudio(touchId, yPos, fingerIndex, virtualCanvasHeight);
        } else if (sharedAudioContext.state === 'suspended') {
            console.log('‚ö†Ô∏è AudioContext suspended in simulateTouch3D, attempting resume...');
            sharedAudioContext.resume().then(() => {
                console.log('‚úÖ AudioContext resumed, creating audio');
                createAudio(touchId, yPos, fingerIndex, virtualCanvasHeight);
            });
        }
    } else {
        console.error('‚ùå sharedAudioContext non disponibile in simulateTouch3D!');
    }
}

function updateAcousticDescription3D(presetCategory) {
    const preset = presetCategory 
        ? presetCategory[currentPreset]
        : (presets3DGeometric[currentPreset] || presets3DReal[currentPreset]);
    if (!preset) return;
    const panel = document.getElementById('presetNameDisplay');
    const desc = document.getElementById('acousticDescription');
    if (panel) panel.textContent = preset.name;
    if (desc) desc.textContent = preset.acousticInfo;
}

function openDemoModal() {
    // Se demoMode √® attivo, fermalo invece di aprire il modale
    if (demoMode) {
        toggleDemoMode();
        return;
    }
    populateDemoModal();
    document.getElementById('demoModal').classList.add('active');
}

function closeDemoModal() {
    document.getElementById('demoModal').classList.remove('active');
}

// ==================== SCALE MODAL FUNCTIONS ====================
function openScaleModal() {
    populateScaleModal();
    document.getElementById('scaleModal').classList.add('active');
}

function closeScaleModal() {
    document.getElementById('scaleModal').classList.remove('active');
}

function selectScale(scaleName) {
    currentScale = scaleName;
    document.getElementById('currentScaleName').textContent = SCALE_NAMES[scaleName];
    showIndicator(`üéµ ${SCALE_NAMES[scaleName]}`);
    closeScaleModal();
}

function populateScaleModal() {
    const western = ['chromatic', 'major', 'minor', 'pentatonic', 'blues', 'harmonic_minor'];
    const middleEast = ['arabic', 'persian', 'hijaz'];
    const indian = ['raga_bhairav', 'raga_todi', 'raga_yaman'];
    const japanese = ['japanese_in', 'japanese_yo', 'japanese_hirajoshi'];
    const african = ['african_1', 'african_2'];
    const exotic = ['whole_tone', 'diminished', 'augmented', 'phrygian', 'lydian', 'spanish'];

    const renderScales = (scales, containerId) => {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        scales.forEach(scale => {
            const btn = document.createElement('button');
            btn.textContent = SCALE_NAMES[scale];
            btn.className = 'demo-preset-btn';
            if (scale === currentScale) {
                btn.style.background = '#51cf66';
                btn.style.border = '2px solid #2b8a3e';
            }
            btn.onclick = () => selectScale(scale);
            container.appendChild(btn);
        });
    };

    renderScales(western, 'scaleWestern');
    renderScales(middleEast, 'scaleMiddleEast');
    renderScales(indian, 'scaleIndian');
    renderScales(japanese, 'scaleJapanese');
    renderScales(african, 'scaleAfrican');
    renderScales(exotic, 'scaleExotic');
}

// ==================== KEY (TONALIT√Ä) MODAL ====================
function openKeyModal() {
    populateKeyModal();
    document.getElementById('keyModal').classList.add('active');
}

function closeKeyModal() {
    document.getElementById('keyModal').classList.remove('active');
}

function selectKey(keyName) {
    currentKey = keyName;
    document.getElementById('currentKeyName').textContent = keyName;
    showIndicator(`üéπ Tonalit√†: ${keyName}`);
    closeKeyModal();
}

function populateKeyModal() {
    const container = document.getElementById('keyGrid');
    container.innerHTML = '';
    KEY_NAMES.forEach(key => {
        const btn = document.createElement('button');
        btn.textContent = `üéπ ${key}`;
        btn.className = 'demo-preset-btn';
        if (key === currentKey) {
            btn.style.background = '#51cf66';
            btn.style.border = '2px solid #2b8a3e';
        }
        btn.onclick = () => selectKey(key);
        container.appendChild(btn);
    });
}

// ==================== TIMBRE (STRUMENTO) MODAL ====================
const TIMBRE_NAMES = {
    'piano': 'üéπ Piano',
    'strings': 'üéª Archi',
    'flute': 'üé∫ Flauto',
    'synth': 'üéõÔ∏è Synth'
};

function openTimbreModal() {
    document.getElementById('timbreModal').classList.add('active');
}

function closeTimbreModal() {
    document.getElementById('timbreModal').classList.remove('active');
}

function selectTimbre(timbreName) {
    currentTimbre = timbreName;
    // Aggiorna tutti e 3 i finger con lo stesso timbro
    fingerTimbreMap = { 0: timbreName, 1: timbreName, 2: timbreName };
    document.getElementById('currentTimbreName').textContent = TIMBRE_NAMES[timbreName];
    showIndicator(`${TIMBRE_NAMES[timbreName]}`);
    closeTimbreModal();
}

// ==================== GALLERY & INDEXEDDB ====================
function initRecordingsDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open('BontempAppRecordings', 1);

        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
            recordingsDB = request.result;
            resolve(recordingsDB);
        };

        request.onupgradeneeded = (event) => {
            const db = event.target.result;
            if (!db.objectStoreNames.contains('recordings')) {
                const store = db.createObjectStore('recordings', { keyPath: 'id', autoIncrement: true });
                store.createIndex('timestamp', 'timestamp', { unique: false });
                store.createIndex('mode', 'mode', { unique: false });
            }
        };
    });
}

async function saveRecordingToIndexedDB(blob, mode) {
    if (!recordingsDB) {
        await initRecordingsDB();
    }

    return new Promise((resolve, reject) => {
        const transaction = recordingsDB.transaction(['recordings'], 'readwrite');
        const store = transaction.objectStore('recordings');

        const recording = {
            blob: blob,
            timestamp: Date.now(),
            mode: mode,
            name: `${mode}_${new Date().toLocaleString('it-IT')}`
        };

        const request = store.add(recording);
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
    });
}

async function loadRecordingsFromIndexedDB() {
    if (!recordingsDB) {
        await initRecordingsDB();
    }

    return new Promise((resolve, reject) => {
        const transaction = recordingsDB.transaction(['recordings'], 'readonly');
        const store = transaction.objectStore('recordings');
        const request = store.getAll();

        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
    });
}

async function deleteRecordingFromIndexedDB(id) {
    if (!recordingsDB) {
        await initRecordingsDB();
    }

    return new Promise((resolve, reject) => {
        const transaction = recordingsDB.transaction(['recordings'], 'readwrite');
        const store = transaction.objectStore('recordings');
        const request = store.delete(id);

        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
    });
}

async function openGalleryModal() {
    document.getElementById('galleryModal').classList.add('active');
    await loadGallery();
}

function closeGalleryModal() {
    document.getElementById('galleryModal').classList.remove('active');
}

function showAbout() {
    document.getElementById('aboutModal').classList.add('active');
}

function closeAbout() {
    document.getElementById('aboutModal').classList.remove('active');
}

function showGuida() {
    document.getElementById('guidaModal').classList.add('active');
}

function closeGuida() {
    document.getElementById('guidaModal').classList.remove('active');
}

async function loadGallery() {
    const container = document.getElementById('galleryContent');
    container.innerHTML = '<p style="text-align: center; padding: 20px;">Caricamento...</p>';

    try {
        const recordings = await loadRecordingsFromIndexedDB();

        if (recordings.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">üìπ Nessuna registrazione salvata</p>';
            return;
        }

        // Ordina per timestamp decrescente (pi√π recenti prima)
        recordings.sort((a, b) => b.timestamp - a.timestamp);

        container.innerHTML = '';
        recordings.forEach(rec => {
            const videoDiv = document.createElement('div');
            videoDiv.style.marginBottom = '20px';
            videoDiv.style.borderBottom = '1px solid #ddd';
            videoDiv.style.paddingBottom = '15px';

            const title = document.createElement('div');
            title.style.fontWeight = '600';
            title.style.marginBottom = '8px';
            title.style.fontSize = '0.9em';
            title.textContent = `${rec.name}`;
            videoDiv.appendChild(title);

            const video = document.createElement('video');
            video.controls = true;
            video.style.width = '100%';
            video.style.borderRadius = '8px';
            video.style.marginBottom = '10px';
            video.src = URL.createObjectURL(rec.blob);
            videoDiv.appendChild(video);

            const btnContainer = document.createElement('div');
            btnContainer.style.display = 'flex';
            btnContainer.style.gap = '8px';

            const downloadBtn = document.createElement('button');
            downloadBtn.textContent = '‚¨áÔ∏è Scarica';
            downloadBtn.style.flex = '1';
            downloadBtn.style.background = '#0ca678';
            downloadBtn.onclick = () => downloadRecording(rec);
            btnContainer.appendChild(downloadBtn);

            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'üóëÔ∏è Elimina';
            deleteBtn.style.flex = '1';
            deleteBtn.style.background = '#e03131';
            deleteBtn.onclick = async () => {
                if (confirm('Eliminare questa registrazione?')) {
                    await deleteRecordingFromIndexedDB(rec.id);
                    await loadGallery();
                    showIndicator('üóëÔ∏è Registrazione eliminata');
                }
            };
            btnContainer.appendChild(deleteBtn);

            videoDiv.appendChild(btnContainer);
            container.appendChild(videoDiv);
        });

    } catch (error) {
        console.error('Errore caricamento galleria:', error);
        container.innerHTML = '<p style="text-align: center; color: #e03131; padding: 20px;">‚ùå Errore caricamento galleria</p>';
    }
}

function downloadRecording(rec) {
    const url = URL.createObjectURL(rec.blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${rec.name}.webm`;
    a.click();
    URL.revokeObjectURL(url);
    showIndicator('‚¨áÔ∏è Download avviato!');
}

function populateDemoModal() {
    // Determina se siamo in modalit√† 2D o 3D
    const is2DMode = currentMode === '2d-guided' || currentMode === '2d';
    const is3DMode = currentMode === '3d-guided' || currentMode === '3d';

    const demo2DGeom = document.getElementById('demo2DGeometric');
    demo2DGeom.innerHTML = '';
    // Mostra demo 2D solo se siamo in modalit√† 2D
    if (is2DMode) {
        Object.keys(presets2DGeometric).forEach(key => {
            const preset = presets2DGeometric[key];
            const card = document.createElement('div');
            card.className = 'demo-card';
            if (selectedDemoPreset === `2d-${key}`) card.classList.add('active');
            card.onclick = () => selectDemoCardAndStart(`2d-${key}`);
            card.innerHTML = `<div class="demo-icon">${preset.icon}</div><div class="demo-name">${preset.name}</div><div class="demo-desc">${preset.desc}</div>`;
            demo2DGeom.appendChild(card);
        });
    }

    const demo2DReal = document.getElementById('demo2DReal');
    demo2DReal.innerHTML = '';
    if (is2DMode) {
        Object.keys(presets2DReal).forEach(key => {
            const preset = presets2DReal[key];
            const card = document.createElement('div');
            card.className = 'demo-card';
            if (selectedDemoPreset === `2d-${key}`) card.classList.add('active');
            card.onclick = () => selectDemoCardAndStart(`2d-${key}`);
            card.innerHTML = `<div class="demo-icon">${preset.icon}</div><div class="demo-name">${preset.name}</div><div class="demo-desc">${preset.desc}</div>`;
            demo2DReal.appendChild(card);
        });
    }

    const demo3DGeom = document.getElementById('demo3DGeometric');
    demo3DGeom.innerHTML = '';
    // Mostra demo 3D solo se siamo in modalit√† 3D
    if (is3DMode) {
        Object.keys(presets3DGeometric).forEach(key => {
            const preset = presets3DGeometric[key];
            const card = document.createElement('div');
            card.className = 'demo-card';
            if (selectedDemoPreset === `3d-${key}`) card.classList.add('active');
            card.onclick = () => selectDemoCardAndStart(`3d-${key}`);
            card.innerHTML = `<div class="demo-icon">${preset.icon}</div><div class="demo-name">${preset.name}</div><div class="demo-desc">${preset.desc}</div>`;
            demo3DGeom.appendChild(card);
        });
    }

    const demo3DReal = document.getElementById('demo3DReal');
    demo3DReal.innerHTML = '';
    if (is3DMode) {
        Object.keys(presets3DReal).forEach(key => {
            const preset = presets3DReal[key];
            const card = document.createElement('div');
            card.className = 'demo-card';
            if (selectedDemoPreset === `3d-${key}`) card.classList.add('active');
            card.onclick = () => selectDemoCardAndStart(`3d-${key}`);
            card.innerHTML = `<div class="demo-icon">${preset.icon}</div><div class="demo-name">${preset.name}</div><div class="demo-desc">${preset.desc}</div>`;
            demo3DReal.appendChild(card);
        });
    }
}

function selectDemoCardAndStart(presetId) {
    selectedDemoPreset = presetId;
    document.querySelectorAll('.demo-card').forEach(card => card.classList.remove('active'));
    event.target.closest('.demo-card').classList.add('active');
    
    setTimeout(() => {
        startSelectedDemo();
    }, 400);
}

function selectAudioGuided() {
    audioGuidedMode = true;
    selectedDemoPreset = null;
    closeDemoModal();
    showIndicator('üéº Modalit√† Audio Guidato Attivata');
}

function startSelectedDemo() {
    if (!selectedDemoPreset && !audioGuidedMode) {
        return;
    }
    closeDemoModal();
    
    if (selectedDemoPreset) {
        const [dimension, presetKey] = selectedDemoPreset.split('-');
        
        debugLog(`üé≠ Starting demo: ${dimension}-${presetKey}`);
        
        if (canvas && ctx) ctx.clearRect(0, 0, canvas.width, canvas.height);
        if (scene3d && meshes3d) {
            // Rimuovi solo le mesh disegnate, NON le guide mesh
            meshes3d.forEach(mesh => {
                // Non rimuovere le guide mesh
                if (!guideMeshes3d.includes(mesh)) {
                    scene3d.remove(mesh);
                    if (mesh.geometry) mesh.geometry.dispose();
                    if (mesh.material) mesh.material.dispose();
                }
            });
            meshes3d = [];
        }
        
        if (dimension === '2d') {
            if (presets2DGeometric[presetKey]) {
                currentPreset = presetKey;
                updateAcousticDescription2D(presets2DGeometric);
            } else if (presets2DReal[presetKey]) {
                currentPreset = presetKey;
                updateAcousticDescription2D(presets2DReal);
            }
        } else if (dimension === '3d') {
            if (presets3DGeometric[presetKey]) {
                currentPreset = presetKey;
                updateAcousticDescription3D(presets3DGeometric);
            } else if (presets3DReal[presetKey]) {
                currentPreset = presetKey;
                updateAcousticDescription3D(presets3DReal);
            }
            // Reset guide time per demo 3D
            guideTime = 0;
            // SEMPRE ricrea le guide mesh 3D per la demo (anche se guidesEnabled √® false)
            if (scene3d) {
                debugLog('üé¨ Ricreo guide mesh 3D per demo');
                // Assicura che guidesEnabled sia true per la demo
                if (!guidesEnabled) {
                    debugLog('üé¨ Attivo guidesEnabled per demo 3D');
                    guidesEnabled = true;
                }
                initGuides3D();
                debugLog('üé¨ Guide mesh 3D create, count:', guideMeshes3d.length);
            } else {
                debugLog('‚ö†Ô∏è scene3d non disponibile!');
            }
        }

        // Reset guide time per demo 2D
        if (dimension === '2d') {
            guideTime = 0;
        }

        if (!demoMode) {
            debugLog('üé≠ Attivazione demo mode...');
            toggleDemoMode();
        }
        
        const presetName = dimension === '2d' 
            ? (presets2DGeometric[presetKey] || presets2DReal[presetKey]).name
            : (presets3DGeometric[presetKey] || presets3DReal[presetKey]).name;
        showIndicator(`üé≠ Demo: ${presetName}`);
    }
}

// ==================== QUANTIZZAZIONE SCALE MUSICALI ====================
function quantizeToScale(frequency, scale = currentScale, key = currentKey) {
    // Converte frequenza in MIDI note number
    const midiNote = 12 * Math.log2(frequency / 440) + 69;

    // Scala disponibile
    const scaleNotes = SCALES[scale];

    // Offset della tonalit√† (transpone la scala)
    const keyOffset = KEYS[key];

    // Trova la nota base (C pi√π vicina)
    const octave = Math.floor(midiNote / 12);
    const noteInOctave = midiNote % 12;

    // Trova la nota pi√π vicina nella scala (trasposta nella tonalit√†)
    let closestNote = (scaleNotes[0] + keyOffset) % 12;
    let minDistance = Math.abs(noteInOctave - closestNote);

    for (let note of scaleNotes) {
        const transposedNote = (note + keyOffset) % 12;
        const distance = Math.abs(noteInOctave - transposedNote);
        if (distance < minDistance) {
            minDistance = distance;
            closestNote = transposedNote;
        }
    }

    // Riconverti in frequenza
    const quantizedMidi = octave * 12 + closestNote;
    const quantizedFreq = 440 * Math.pow(2, (quantizedMidi - 69) / 12);

    return quantizedFreq;
}

function initAudio() {
    if (!sharedAudioContext || sharedAudioContext.state === 'closed') {
        sharedAudioContext = new (window.AudioContext || window.webkitAudioContext)();
        debugLog('üîä AudioContext creato - State:', sharedAudioContext.state);

        audioDestination = sharedAudioContext.createMediaStreamDestination();
    }
    if (sharedAudioContext.state === 'suspended') {
        debugLog('üîä AudioContext suspended in initAudio, resuming...');
        sharedAudioContext.resume().then(() => {
            debugLog('‚úÖ AudioContext resumed - State:', sharedAudioContext.state);
        });
    }
}

function createAudio(id, y, f, h, pos3d = null) {
    try {
        if (!sharedAudioContext) {
            debugLog('‚ö†Ô∏è AudioContext non inizializzato');
            initAudio();
            setTimeout(() => createAudio(id, y, f, h, pos3d), 50);
            return;
        }

        if (sharedAudioContext.state === 'suspended') {
            debugLog('üîä AudioContext suspended in createAudio, resuming...');
            sharedAudioContext.resume().then(() => {
                createAudio(id, y, f, h, pos3d);
            });
            return;
        }

        // Calcola frequenza base (220-880 Hz, 2 ottave)
        let baseFreq = 220 + (1 - y / h) * 660;

        // Quantizza alla scala musicale
        baseFreq = quantizeToScale(baseFreq);

        // Seleziona timbro per questo dito
        const timbre = fingerTimbreMap[f % 3] || 'piano';
        const preset = TIMBRE_PRESETS[timbre];

        if (activeOscillators.has(id)) {
            // Aggiorna frequenza oscillatori esistenti
            let audioData = activeOscillators.get(id);
            audioData.oscillators.forEach((oscData, idx) => {
                const harmonic = preset.harmonics[idx];
                const targetFreq = baseFreq * harmonic.mult;
                oscData.osc.frequency.linearRampToValueAtTime(
                    targetFreq,
                    sharedAudioContext.currentTime + 0.05
                );
            });

            // Aggiorna posizione 3D se presente
            if (pos3d && audioData.pannerNode) {
                if (audioData.pannerNode.positionX) {
                    audioData.pannerNode.positionX.value = pos3d.x;
                    audioData.pannerNode.positionY.value = pos3d.y;
                    audioData.pannerNode.positionZ.value = pos3d.z;
                } else {
                    audioData.pannerNode.setPosition(pos3d.x, pos3d.y, pos3d.z);
                }
                audioData.pos3d = pos3d;
            }

            updateRealtimeData(f % 3, baseFreq, audioData.masterGain.gain.value, true);
            return;
        }

        // Crea nuovo suono con armonici multipli
        const now = sharedAudioContext.currentTime;
        const masterGain = sharedAudioContext.createGain();
        const oscillators = [];

        // Crea oscillatori per ogni armonico
        preset.harmonics.forEach(harmonic => {
            const osc = sharedAudioContext.createOscillator();
            const gain = sharedAudioContext.createGain();

            // Frequenza dell'armonico
            osc.frequency.value = baseFreq * harmonic.mult;
            osc.type = harmonic.type;

            // Volume relativo dell'armonico
            gain.gain.value = harmonic.amp;

            // Connetti oscillatore -> gain armonico -> master gain
            osc.connect(gain);
            gain.connect(masterGain);

            osc.start();
            oscillators.push({ osc, gain });
        });

        // ADSR Envelope sul master gain
        const peakVolume = preset.baseVolume;
        const sustainVolume = peakVolume * preset.sustain;

        masterGain.gain.setValueAtTime(0, now);
        masterGain.gain.linearRampToValueAtTime(peakVolume, now + preset.attack);
        masterGain.gain.linearRampToValueAtTime(sustainVolume, now + preset.attack + preset.decay);

        // Audio spaziale 3D se pos3d √® presente
        let pannerNode = null;
        if (pos3d) {
            pannerNode = sharedAudioContext.createPanner();
            pannerNode.panningModel = 'HRTF'; // Modello realistico 3D
            pannerNode.distanceModel = 'inverse';
            pannerNode.refDistance = 1;
            pannerNode.maxDistance = 20;
            pannerNode.rolloffFactor = 1;
            pannerNode.coneInnerAngle = 360;
            pannerNode.coneOuterAngle = 0;
            pannerNode.coneOuterGain = 0;

            // Posiziona il suono nello spazio 3D
            if (pannerNode.positionX) {
                pannerNode.positionX.value = pos3d.x;
                pannerNode.positionY.value = pos3d.y;
                pannerNode.positionZ.value = pos3d.z;
            } else {
                pannerNode.setPosition(pos3d.x, pos3d.y, pos3d.z);
            }

            // Collega: masterGain -> pannerNode -> destination
            masterGain.connect(pannerNode);
            pannerNode.connect(sharedAudioContext.destination);
            if (audioDestination) {
                pannerNode.connect(audioDestination);
            }
        } else {
            // Audio 2D normale
            masterGain.connect(sharedAudioContext.destination);
            if (audioDestination) {
                masterGain.connect(audioDestination);
            }
        }

        // Salva riferimenti
        activeOscillators.set(id, {
            oscillators,
            masterGain,
            pannerNode,
            preset,
            baseFreq,
            pos3d
        });

        updateRealtimeData(f % 3, baseFreq, sustainVolume, true);

    } catch (e) {
        console.error('‚ùå Audio error:', e);
    }
}

function stopAudio(id, f) {
    if (activeOscillators.has(id)) {
        let audioData = activeOscillators.get(id);
        try {
            const now = sharedAudioContext.currentTime;
            const releaseTime = audioData.preset ? audioData.preset.release : 0.2;

            // Applica release envelope
            audioData.masterGain.gain.cancelScheduledValues(now);
            audioData.masterGain.gain.setValueAtTime(audioData.masterGain.gain.value, now);
            audioData.masterGain.gain.linearRampToValueAtTime(0, now + releaseTime);

            // Ferma e disconnetti tutti gli oscillatori dopo il release
            setTimeout(() => {
                try {
                    audioData.oscillators.forEach(oscData => {
                        oscData.osc.stop();
                        oscData.osc.disconnect();
                        oscData.gain.disconnect();
                    });
                    audioData.masterGain.disconnect();
                } catch (e) {}
            }, releaseTime * 1000 + 50);
        } catch (e) {}
        activeOscillators.delete(id);
        updateRealtimeData(f, 0, 0, false);
    }
}

function stopAllAudio() {
    activeOscillators.forEach((audioData, id) => {
        try {
            audioData.oscillators.forEach(oscData => {
                oscData.osc.stop();
                oscData.osc.disconnect();
                oscData.gain.disconnect();
            });
            audioData.masterGain.disconnect();
        } catch (e) {}
    });
    activeOscillators.clear();
    for (let i = 0; i < 3; i++) updateRealtimeData(i, 0, 0, false);
}

// ==================== RECORDING FUNCTIONS ====================

async function toggleRecording() {
    if (isRecording) {
        stopRecording();
    } else {
        startRecording();
    }
}

async function startRecording() {
    try {
        debugLog('üé• Avvio registrazione...');
        
        if (canvas) {
            canvasStream = canvas.captureStream(30);
        } else if (renderer3d) {
            canvasStream = renderer3d.domElement.captureStream(30);
        }
        
        if (!canvasStream) {
            alert('‚ùå Impossibile catturare lo stream del canvas!');
            return;
        }
        
        if (!sharedAudioContext || sharedAudioContext.state === 'closed') {
            initAudio();
        }
        if (sharedAudioContext.state === 'suspended') {
            await sharedAudioContext.resume();
        }
        
        if (!audioDestination) {
            audioDestination = sharedAudioContext.createMediaStreamDestination();
        }
        audioStream = audioDestination.stream;
        
        const combinedStream = new MediaStream([
            ...canvasStream.getVideoTracks(),
            ...audioStream.getAudioTracks()
        ]);
        
        const options = { mimeType: 'video/webm;codecs=vp9,opus' };
        if (!MediaRecorder.isTypeSupported(options.mimeType)) {
            options.mimeType = 'video/webm;codecs=vp8,opus';
        }
        if (!MediaRecorder.isTypeSupported(options.mimeType)) {
            options.mimeType = 'video/webm';
        }
        
        mediaRecorder = new MediaRecorder(combinedStream, options);
        recordedChunks = [];
        
        mediaRecorder.ondataavailable = (e) => {
            if (e.data.size > 0) {
                recordedChunks.push(e.data);
            }
        };
        
        mediaRecorder.onstop = async () => {
            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            try {
                await saveRecordingToIndexedDB(blob, currentMode);
                debugLog('‚úÖ Registrazione salvata nella Galleria!');
                showIndicator('‚úÖ Registrazione salvata! Vai in üìπ Galleria');
            } catch (error) {
                console.error('Errore salvataggio:', error);
                // Fallback: scarica se salvataggio fallisce
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `BontempApp_${currentMode}_${Date.now()}.webm`;
                a.click();
                URL.revokeObjectURL(url);
                showIndicator('‚ö†Ô∏è Salvato in download');
            }
        };
        
        mediaRecorder.start(100);
        isRecording = true;
        
        const recordBtn = document.getElementById('recordBtn');
        if (recordBtn) {
            recordBtn.textContent = '‚èπÔ∏è Stop Registrazione';
            recordBtn.classList.add('recording');
        }
        
        const indicator = document.createElement('div');
        indicator.id = 'recordIndicator';
        indicator.className = 'record-indicator';
        indicator.textContent = 'üî¥ REC';
        document.body.appendChild(indicator);
        
        debugLog('‚úÖ Registrazione avviata!');
        
    } catch (error) {
        console.error('‚ùå Errore avvio registrazione:', error);
        alert('‚ùå Errore: ' + error.message);
    }
}

function stopRecording() {
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        isRecording = false;
        
        const recordBtn = document.getElementById('recordBtn');
        if (recordBtn) {
            recordBtn.textContent = 'üî¥ Avvia Registrazione';
            recordBtn.classList.remove('recording');
        }
        
        const indicator = document.getElementById('recordIndicator');
        if (indicator) indicator.remove();
        
        debugLog('‚èπÔ∏è Registrazione fermata!');
    }
}

// ==================== QUIZ CON TIMER ====================

function startQuizTimer() {
    // Ferma eventuali timer precedenti
    stopQuizTimer();

    quizTimeRemaining = 30;
    questionStartTime = Date.now();

    quizTimer = setInterval(() => {
        quizTimeRemaining--;
        const timerEl = document.getElementById('quizTimerDisplay');
        if (timerEl) {
            timerEl.textContent = `‚è±Ô∏è ${quizTimeRemaining}s`;
            
            // Cambia colore in base al tempo rimasto
            if (quizTimeRemaining <= 5) {
                timerEl.style.background = 'linear-gradient(135deg, #ff6b6b, #e03131)';
            } else if (quizTimeRemaining <= 10) {
                timerEl.style.background = 'linear-gradient(135deg, #ffa500, #ff6b6b)';
            }
        }
        
        if (quizTimeRemaining <= 0) {
            stopQuizTimer();
            // Tempo scaduto: considera risposta errata
            showQuizFeedback(false, 'Tempo scaduto!');
            currentRound++;
            updateScore();
            
            setTimeout(() => {
                if (currentRound <= maxRounds) showQuizQuestion(currentRound - 1);
                else showResults();
            }, 3500);
        }
    }, 1000);
}

function stopQuizTimer() {
    if (quizTimer) {
        clearInterval(quizTimer);
        quizTimer = null;
    }
}

function calculateTimeBonus() {
    // Bonus basato sul tempo rimasto: max 5 punti per risposta veloce
    if (quizTimeRemaining >= 25) return 5;
    if (quizTimeRemaining >= 20) return 4;
    if (quizTimeRemaining >= 15) return 3;
    if (quizTimeRemaining >= 10) return 2;
    if (quizTimeRemaining >= 5) return 1;
    return 0;
}

function startQuiz() {
    if (currentRound > maxRounds) return showResults();
    showQuizQuestion(currentRound - 1);
}

function showQuizQuestion(index) {
    if (index >= currentQuestions.length) return showResults();
    const q = currentQuestions[index];
    const gameArea = document.getElementById('gameArea');

    if (isExpertMode && q.type === 'open') {
        gameArea.innerHTML = `
            <div class="question">
                <h3>Domanda ${index+1}/${maxRounds} <span class="api-required">AI</span></h3>
                <p>${q.q}</p>
                <p style="font-size: 0.85em; color: #666; margin-top: 10px;">üí° Prenditi il tempo necessario per rispondere in modo articolato (minimo 20 caratteri)</p>
            </div>
            <textarea id="openAnswer" placeholder="Scrivi risposta articolata..." style="min-height:100px"></textarea>
            <button onclick="checkOpenAnswer(${index})">Invia Risposta</button>
            <button onclick="backToModes()" style="background:#868e96; margin-top:10px;">‚óÄ Indietro</button>
        `;
        // Non avviare il timer per domande aperte
        return;
    } else {
        // Randomizza l'ordine delle opzioni
        const optionsWithIndex = q.o.map((opt, i) => ({text: opt, originalIndex: i}));
        const shuffledOptions = shuffleArray([...optionsWithIndex]);

        const opts = shuffledOptions.map((opt, displayIndex) => `
            <div class="quiz-option" onclick="selectQuizOptionAndSubmit(${index}, ${displayIndex}, ${opt.originalIndex})">
                <input type="radio" name="answer" value="${opt.originalIndex}" id="opt${displayIndex}">
                <label for="opt${displayIndex}" style="cursor:pointer; flex:1;">${opt.text}</label>
            </div>
        `).join('');
        gameArea.innerHTML = `
            <div class="quiz-timer" id="quizTimerDisplay">‚è±Ô∏è 30s</div>
            <div class="question">
                <h3>Domanda ${index+1}/${maxRounds}</h3>
                <p>${q.q}</p>
            </div>
            <div class="quiz-options">${opts}</div>
            <button onclick="backToModes()" style="background:#868e96; margin-top:15px; width:100%;">‚óÄ Esci dal Quiz</button>
        `;

        // Avvia timer solo per domande a scelta multipla
        startQuizTimer();
    }
}

function selectQuizOption(index) {
    document.getElementById(`opt${index}`).checked = true;
}

function selectQuizOptionAndSubmit(questionIndex, displayIndex, originalIndex) {
    // Previeni click multipli
    const clickedOption = document.getElementById(`opt${displayIndex}`);
    if (!clickedOption || clickedOption.disabled) return;

    // Disabilita tutte le opzioni per prevenire doppi click
    document.querySelectorAll('input[name="answer"]').forEach(input => input.disabled = true);

    // Seleziona l'opzione cliccata
    clickedOption.checked = true;

    // Invia automaticamente dopo breve pausa per feedback visivo
    setTimeout(() => {
        checkQuizAnswer(questionIndex);
    }, 300);
}

function checkQuizAnswer(index) {
    // Previeni elaborazione multipla della stessa risposta
    if (isProcessingAnswer) return;
    isProcessingAnswer = true;

    stopQuizTimer();

    const q = currentQuestions[index];
    const selected = document.querySelector('input[name="answer"]:checked');

    if (!selected) {
        showQuizFeedback(false, 'Seleziona una risposta!');
        isProcessingAnswer = false;
        return;
    }

    const isCorrect = parseInt(selected.value) === q.c;
    const timeBonus = isCorrect ? calculateTimeBonus() : 0;

    if (isCorrect) {
        score += 10 + timeBonus;
        showQuizFeedback(true, '', timeBonus);
    } else {
        showQuizFeedback(false, q.o[q.c]);
    }

    updateScore();
    currentRound++;

    setTimeout(() => {
        isProcessingAnswer = false; // Reset flag
        if (currentRound <= maxRounds) showQuizQuestion(currentRound - 1);
        else showResults();
    }, 3500);
}

async function checkOpenAnswer(index) {
    stopQuizTimer();
    
    const userAnswer = document.getElementById('openAnswer').value.trim();
    if (userAnswer.length < 20) {
        showQuizFeedback(false, 'Minimo 20 caratteri!');
        return;
    }
    if (!apiKey) {
        alert('‚ö†Ô∏è API Key mancante!');
        return;
    }
    
    const q = currentQuestions[index];
    document.getElementById('gameArea').innerHTML = '<div class="feedback-box"><h3>‚è≥ AI valuta...</h3></div>';
    
    const timeBonus = calculateTimeBonus();
    
    try {
        const prompt = `Valuta questa risposta (0-10): DOMANDA: ${q.q}. RISPOSTA: ${userAnswer}. RIFERIMENTO: ${q.a}. Formato: PUNTEGGIO: X/10`;
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                contents: [{parts: [{text: prompt}]}],
                generationConfig: {temperature: 0.4, maxOutputTokens: 1024}
            })
        });
        const data = await response.json();
        const text = data.candidates[0].content.parts[0].text;
        let points = 5;
        const scoreMatch = text.match(/PUNTEGGIO:\s*(\d+)/i);
        if (scoreMatch) points = Math.min(parseInt(scoreMatch[1]), 10);
        
        score += points + timeBonus;
        updateScore();
        
        document.getElementById('gameArea').innerHTML = `
            <div class="feedback-box ${points >= 7 ? 'success' : ''}">
                <h3>${points >= 7 ? '‚úÖ Ottimo!' : 'üìö Da rivedere'}</h3>
                <p style="font-size:1.5em">${points}/10 ${timeBonus > 0 ? `+ ${timeBonus} bonus ‚ö°` : ''}</p>
                <p style="font-size:0.85em">${text}</p>
            </div>
            <button onclick="nextQuestionRound()">Prossima ‚Üí</button>
        `;
    } catch (error) {
        score += 5 + timeBonus;
        updateScore();
        document.getElementById('gameArea').innerHTML = `
            <div class="feedback-box error">
                <h3>‚ö†Ô∏è Errore</h3>
                <p>Punteggio default: ${5 + timeBonus}/10</p>
            </div>
            <button onclick="nextQuestionRound()">Continua</button>
        `;
    }
}

function nextQuestionRound() {
    currentRound++;
    if (currentRound <= maxRounds) showQuizQuestion(currentRound - 1);
    else showResults();
}

// ==================== PHOTO CHALLENGE ====================

function startPhotoChallenge() {
    const gameArea = document.getElementById('gameArea');

    // Pesca sfida dal mazzo shuffled (senza ripetizioni)
    if (challengeDifficulty === 'audace') {
        // Se il mazzo AUDACI √® finito, rimescola automaticamente
        if (audaciIndex >= shuffledAudaciChallenges.length) {
            shuffledAudaciChallenges = shuffleArray([...photoChallengesAudaci]);
            audaciIndex = 0;
            console.log('üîÑ Mazzo AUDACI terminato e rimescolato!');
        }
        currentChallenge = shuffledAudaciChallenges[audaciIndex];
        console.log("üî• AUDACI - Indice:", audaciIndex, "- Sfida:", currentChallenge);
        audaciIndex++;
    } else {
        // Se il mazzo BASE √® finito, rimescola automaticamente
        if (baseIndex >= shuffledBaseChallenges.length) {
            shuffledBaseChallenges = shuffleArray([...photoChallengesBase]);
            baseIndex = 0;
            console.log('üîÑ Mazzo BASE terminato e rimescolato!');
        }
        currentChallenge = shuffledBaseChallenges[baseIndex];
        console.log("‚ú® BASE - Indice:", baseIndex, "- Sfida:", currentChallenge);
        baseIndex++;
    }

    gameArea.innerHTML = `
        <div class="challenge-box">${currentChallenge}</div>
        <div class="photo-upload-area" onclick="document.getElementById('photoInput').click()">
            <p style="font-size:0.9em">üì∑ Clicca per scattare/caricare foto</p>
            <p style="font-size:0.75em; color:#666; margin-top:5px">‚ö° Invio automatico dopo caricamento!</p>
            <input type="file" id="photoInput" accept="image/*" capture="environment" style="display:none" onchange="handlePhotoUpload(event)">
            <img id="preview" class="preview-image" style="display:none">
        </div>
        <div style="display: flex; gap: 8px; margin-top: 10px;">
            <button onclick="skipChallenge()" style="background: #868e96; flex: 1;">‚è≠Ô∏è Salta</button>
            <button onclick="showApiGuide()" style="background: #17a2b8; flex: 1;">‚ùì Guida API</button>
        </div>
        <button onclick="backToModes()" style="background: #dc3545; margin-top: 10px; width: 100%;">
            ‚óÄ Esci dalla Sfida
        </button>
    `;
}

function handlePhotoUpload(event) {
    const file = event.target.files[0];
    if (file) {
        uploadedImageMimeType = file.type;
        const reader = new FileReader();
        reader.onload = function(e) {
            uploadedImage = e.target.result;
            document.getElementById('preview').src = uploadedImage;
            document.getElementById('preview').style.display = 'block';
            
            // AUTO-SUBMIT: Invia automaticamente dopo 1 secondo
            showIndicator('‚ö° Invio automatico in corso...');
            setTimeout(() => {
                evaluatePhotoWithGemini();
            }, 1000);
        };
        reader.readAsDataURL(file);
    }
}

async function evaluatePhotoWithGemini() {
    if (!uploadedImage || !apiKey) {
        alert('‚ö†Ô∏è Carica foto e verifica API Key!');
        return;
    }
    
    document.getElementById('gameArea').innerHTML = '<div class="feedback-box"><h3>‚è≥ L\'AI sta analizzando...</h3></div>';
    
    try {
        const base64Data = uploadedImage.split(',')[1];
        const prompt = `Sei un musicologo, musicista, artista e compositore con un buon senso dell'ironia. Il giocatore ${userName} ha completato la sfida: "${currentChallenge}". Valuta creativit√† e originalit√† (0-100). Formato: PUNTEGGIO: XX/100`;
        
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                contents: [{parts: [{text: prompt}, {inline_data: {mime_type: uploadedImageMimeType, data: base64Data}}]}],
                generationConfig: {temperature: 0.7, maxOutputTokens: 1024}
            })
        });
        
        const data = await response.json();
        const aiResponse = data.candidates[0].content.parts[0].text;
        let points = 50;
        const scoreMatch = aiResponse.match(/PUNTEGGIO:\s*(\d+)/i) || aiResponse.match(/(\d+)\s*\/\s*100/);
        if (scoreMatch) points = Math.min(Math.max(parseInt(scoreMatch[1]), 0), 100);
        
        score += points;
        updateScore();

        // Salva i dati per potenziale pubblicazione nella Sala della Fama
        pendingPublication.imageData = uploadedImage;
        pendingPublication.challengeTitle = currentChallenge;
        pendingPublication.aiComment = aiResponse;

        document.getElementById('gameArea').innerHTML = `
            <div class="feedback-box ${points >= 70 ? 'success' : ''}">
                <h3>${points >= 70 ? 'üéâ Ottimo!' : 'üëç Discreto!'}</h3>
                <p style="font-size:2.5em; margin:15px 0; color:#667eea;">${points}/100</p>
                <div style="max-height: 200px; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 5px;">
                    <p style="font-size:0.85em; margin: 0;">${aiResponse}</p>
                </div>
            </div>
            <button onclick="nextRound()">Prossima Sfida ‚Üí</button>
        `;

        // Mostra il modale di pubblicazione dopo 2 secondi
        setTimeout(() => {
            showPublishModal(aiResponse);
        }, 2000);
    } catch (error) {
        score += 50;
        updateScore();
        document.getElementById('gameArea').innerHTML = `
            <div class="feedback-box error">
                <h3>‚ö†Ô∏è Errore AI</h3>
                <p>Punteggio di default: 50/100</p>
            </div>
            <button onclick="nextRound()">Continua ‚Üí</button>
        `;
    }
}

function skipChallenge() {
    showIndicator('‚è≠Ô∏è Challenge saltata, caricamento nuova...');
    setTimeout(() => {
        startPhotoChallenge();
    }, 800);
}

function nextRound() {
    currentRound++;
    uploadedImage = null;
    if (currentRound > maxRounds) {
        showResults();
    } else {
        updateScore();
        startPhotoChallenge();
    }
}

function startCuriosita() {
    currentCuriositaIndex = Math.floor(Math.random() * curiositaGAS.length);
    showCuriosita();
}

function showCuriosita() {
    const c = curiositaGAS[currentCuriositaIndex];
    if (curiositaTimer) clearInterval(curiositaTimer);
    curiositaTimeRemaining = c.readingTime;
    
    document.getElementById('gameArea').innerHTML = `
        <div class="curiosita-box">
            <div class="curiosita-title">${c.title}</div>
            <p>${c.text}</p>
        </div>
        <div style="background:#e7f5ff; padding:10px; border-radius:8px; margin:10px 0;">
            <div style="display:flex; justify-content:space-between; font-size:0.85em">
                <span>‚è±Ô∏è Tempo:</span>
                <span id="timerDisplay" style="font-size:1.1em; font-weight:bold; color:#667eea;">${curiositaTimeRemaining}s</span>
            </div>
            <div style="background:#ddd; height:6px; border-radius:3px; margin-top:8px;">
                <div id="progressBar" style="background:#667eea; height:100%; width:100%; transition:width 1s;"></div>
            </div>
        </div>
        <button onclick="nextCuriosita()">Prossima üëâ</button>
        <button onclick="pauseTimer()" id="pauseBtn" style="background:#ffc107">‚è∏Ô∏è Pausa</button>
        <button onclick="backToModes()" style="background:#868e96; margin-top:10px;">‚óÄ Indietro</button>
    `;
    startCuriositaTimer();
}

function startCuriositaTimer() {
    const totalTime = curiositaGAS[currentCuriositaIndex].readingTime;
    curiositaTimer = setInterval(() => {
        curiositaTimeRemaining--;
        const timerDisplay = document.getElementById('timerDisplay');
        const progressBar = document.getElementById('progressBar');
        if (timerDisplay) timerDisplay.textContent = `${curiositaTimeRemaining}s`;
        if (progressBar) progressBar.style.width = `${(curiositaTimeRemaining / totalTime) * 100}%`;
        if (curiositaTimeRemaining <= 0) {
            clearInterval(curiositaTimer);
            nextCuriosita();
        }
    }, 1000);
}

function pauseTimer() {
    const pauseBtn = document.getElementById('pauseBtn');
    if (curiositaTimer) {
        clearInterval(curiositaTimer);
        curiositaTimer = null;
        pauseBtn.textContent = '‚ñ∂Ô∏è Riprendi';
        pauseBtn.style.background = '#51cf66';
    } else {
        startCuriositaTimer();
        pauseBtn.textContent = '‚è∏Ô∏è Pausa';
        pauseBtn.style.background = '#ffc107';
    }
}

function nextCuriosita() {
    if (curiositaTimer) clearInterval(curiositaTimer);
    currentCuriositaIndex = (currentCuriositaIndex + 1) % curiositaGAS.length;
    showCuriosita();
}

function showResults() {
    stopQuizTimer();
    const maxScore = maxRounds * 10;
    const percentage = (score / maxScore) * 100;

    // Salva risultati quiz nel profilo
    if (currentMode.startsWith('quiz-')) {
        const quizMode = currentMode.replace('quiz-', '');
        const correctAnswers = Math.round(score / 10); // Ogni domanda vale 10 punti
        saveQuizResult(quizMode, score, correctAnswers, maxRounds);
    }

    // Salva risultati challenge nel profilo
    if (currentMode === 'challenge') {
        const completed = maxRounds; // Per ora considero tutte completate
        const skipped = 0;
        saveChallengeResult(challengeDifficulty, score, completed, skipped);
    }

    // Se punteggio perfetto, mostra animazione a tutto schermo
    if (percentage === 100) {
        showPerfectScoreAnimation();
        setTimeout(() => {
            showNormalResults(maxScore, percentage);
        }, 3000);
    } else {
        showNormalResults(maxScore, percentage);
    }
}

function showPerfectScoreAnimation() {
    const overlay = document.createElement('div');
    overlay.className = 'victory-overlay';
    overlay.innerHTML = `
        <div class="victory-stars">‚≠êüèÜ‚≠ê</div>
        <div class="victory-text">PUNTEGGIO PERFETTO!</div>
        <div class="victory-score">100/100</div>
    `;
    document.body.appendChild(overlay);

    setTimeout(() => {
        overlay.remove();
    }, 3000);
}

function showNormalResults(maxScore, percentage) {
    const modal = document.getElementById('resultsModal');
    const content = document.getElementById('resultsContent');

    let message = percentage >= 80 ? 'üèÜ Eccellente!' :
                  percentage >= 60 ? 'üåü Molto Bene!' :
                  percentage >= 40 ? 'üí™ Buon Lavoro!' : 'üìö Riprova!';
    let emoji = percentage >= 80 ? 'üéâ' : percentage >= 60 ? 'üéñ' : percentage >= 40 ? 'üéì' : 'üìñ';

    content.innerHTML = `
        <div style="text-align:center; padding:15px;">
            <div style="font-size:4em; margin-bottom:15px;">${emoji}</div>
            <h3 style="font-size:1.5em; margin-bottom:10px;">${message}</h3>
            <p style="font-size:1.8em; color:#667eea; font-weight:bold; margin:15px 0;">${score}/${maxScore}</p>
            <p style="font-size:1.3em; color:#666;">${Math.round(percentage)}%</p>
        </div>
    `;
    modal.classList.add('active');
}

// Inizializza IndexedDB all'avvio
initRecordingsDB().then(() => {
    console.log('‚úÖ IndexedDB inizializzato per registrazioni');
}).catch(err => {
    console.error('‚ö†Ô∏è Errore inizializzazione IndexedDB:', err);
});

// Carica profilo utente all'avvio
loadUserProfile();

// ==================== SALA DELLA FAMA - Funzioni ====================

/**
 * Mostra il modale di conferma pubblicazione
 */
function showPublishModal(aiComment) {
    const modal = document.getElementById('publishModal');
    const modalText = document.getElementById('publishModalText');
    const tosCheckbox = document.getElementById('tosCheckbox');
    const publishButton = document.getElementById('publishButton');

    modalText.innerHTML = `
        <strong style="color: #667eea;">"${aiComment}"</strong>
        <br><br>
        Vuoi esporre questa prodezza nella <strong>'Sala della Fama'</strong> e mostrarla agli altri Audaci?
    `;

    // Reset checkbox e pulsante
    tosCheckbox.checked = false;
    publishButton.disabled = true;

    modal.classList.add('active');
}

/**
 * Chiude il modale di pubblicazione
 */
function closePublishModal() {
    const modal = document.getElementById('publishModal');
    const tosCheckbox = document.getElementById('tosCheckbox');
    const publishButton = document.getElementById('publishButton');

    // Reset stato
    tosCheckbox.checked = false;
    publishButton.disabled = true;

    modal.classList.remove('active');
}

/**
 * Gestisce lo stato del pulsante Pubblica in base alla checkbox ToS
 */
function togglePublishButton() {
    const tosCheckbox = document.getElementById('tosCheckbox');
    const publishButton = document.getElementById('publishButton');

    // Abilita pulsante solo se checkbox √® spuntata
    publishButton.disabled = !tosCheckbox.checked;
}

/**
 * Pubblica la foto nella Sala della Fama
 */
async function publishToHallOfFame() {
    // Verifica autenticazione
    if (!currentUser) {
        closePublishModal();
        showLoginModal();
        return;
    }

    // üîí SMART WALL: Verifica se utente √® anonimo
    if (currentUser.isAnonymous) {
        closePublishModal();
        showSmartWallModal();
        return;
    }

    if (!pendingPublication.imageData || !pendingPublication.challengeTitle || !pendingPublication.aiComment) {
        alert('‚ö†Ô∏è Errore: dati mancanti per la pubblicazione');
        closePublishModal();
        return;
    }

    if (!db || !storage) {
        alert('‚ö†Ô∏è Firebase non √® configurato. Contatta l\'amministratore.');
        closePublishModal();
        return;
    }

    try {
        showIndicator('üì§ Pubblicazione in corso...');

        // 1. Comprimi l'immagine prima dell'upload
        showIndicator('üì¶ Compressione immagine...');
        const compressedBlob = await compressImage(pendingPublication.imageData, 800, 0.8);

        // 2. Upload su Firebase Storage
        showIndicator('üì§ Upload in corso...');
        const timestamp = Date.now();
        const imageName = `challenge_${currentUser.uid}_${timestamp}.jpg`;
        const storageRef = storage.ref(`hall-of-fame/${imageName}`);

        const snapshot = await storageRef.put(compressedBlob);
        const imageUrl = await snapshot.ref.getDownloadURL();

        // 3. Salva i dati su Firestore
        showIndicator('üíæ Salvataggio dati...');
        await db.collection('pubblicazioni').add({
            imageUrl: imageUrl,
            sfidaTitolo: pendingPublication.challengeTitle,
            aiCommento: pendingPublication.aiComment,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            createdAt: new Date().toISOString(),
            // Dati utente
            userId: currentUser.uid,
            userDisplayName: currentUser.displayName || (currentUser.isAnonymous ? 'Ospite' : 'Utente'),
            userPhotoURL: currentUser.photoURL || null,
            userIsAnonymous: currentUser.isAnonymous || false,
            // Contatori per future features
            likes: 0,
            flags: 0,
            views: 0
        });

        showIndicator('‚úÖ Pubblicato nella Sala della Fama!');
        closePublishModal();

        // Reset pending publication
        pendingPublication = {
            imageData: null,
            challengeTitle: null,
            aiComment: null
        };

    } catch (error) {
        console.error('Errore pubblicazione:', error);
        alert('‚ö†Ô∏è Errore durante la pubblicazione. Riprova pi√π tardi.');
        closePublishModal();
    }
}

/**
 * Mostra la schermata Sala della Fama
 */
function showHallOfFame() {
    // Nascondi tutte le altre schermate
    document.getElementById('welcomeScreen').classList.remove('active');
    document.getElementById('modeScreen').classList.remove('active');
    document.getElementById('gameScreen').classList.remove('active');
    document.getElementById('profileScreen').classList.remove('active');
    // Mostra Sala della Fama
    document.getElementById('hallOfFameScreen').classList.add('active');

    loadHallOfFame();
}

/**
 * Carica e mostra tutte le pubblicazioni dalla Sala della Fama
 */
async function loadHallOfFame() {
    const area = document.getElementById('hallOfFameArea');

    if (!db) {
        area.innerHTML = `
            <div class="fame-empty">
                <div class="fame-empty-icon">‚ö†Ô∏è</div>
                <h3>Firebase non configurato</h3>
                <p>La Sala della Fama richiede la configurazione di Firebase.<br>Contatta l'amministratore.</p>
            </div>
        `;
        return;
    }

    try {
        area.innerHTML = '<div style="text-align:center; padding:40px;"><h3>üîÑ Caricamento...</h3></div>';

        // Leggi tutte le pubblicazioni ordinate per timestamp (pi√π recenti prima)
        // Filtro: flags < 3 (soglia di moderazione)
        const snapshot = await db.collection('pubblicazioni')
            .where('flags', '<', 3)
            .orderBy('flags', 'asc')
            .orderBy('timestamp', 'desc')
            .limit(50)
            .get();

        if (snapshot.empty) {
            area.innerHTML = `
                <div class="fame-empty">
                    <div class="fame-empty-icon">üèÜ</div>
                    <h3>Nessuna sfida pubblicata ancora</h3>
                    <p>Sii il primo Audace a condividere la tua prodezza!</p>
                </div>
            `;
            return;
        }

        // Costruisci la griglia di card
        let html = '<div class="hall-of-fame-grid">';

        // Per ogni pubblicazione, verifica se l'utente corrente l'ha gi√† flaggata
        for (const doc of snapshot.docs) {
            const data = doc.data();
            const postId = doc.id;
            const date = data.timestamp ? data.timestamp.toDate() : new Date(data.createdAt);
            const dateStr = date.toLocaleDateString('it-IT', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });

            // Nome utente con fallback
            const displayName = data.userDisplayName || data.userId || 'Anonimo';

            // Avatar utente (se disponibile)
            const avatarHtml = data.userPhotoURL
                ? `<img src="${data.userPhotoURL}" style="width: 20px; height: 20px; border-radius: 50%; vertical-align: middle; margin-right: 5px;" onerror="this.style.display='none'">`
                : '';

            // Controlla se l'utente corrente ha gi√† flaggato questo post
            let hasFlag = false;
            if (currentUser) {
                const flagDoc = await db.collection('pubblicazioni').doc(postId)
                    .collection('flags').doc(currentUser.uid).get();
                hasFlag = flagDoc.exists;
            }

            // Controlla se l'utente corrente ha gi√† likato questo post
            let hasLike = false;
            if (currentUser) {
                const likeDoc = await db.collection('pubblicazioni').doc(postId)
                    .collection('likes').doc(currentUser.uid).get();
                hasLike = likeDoc.exists;
            }

            // Verifica se l'utente corrente √® il proprietario
            const isOwner = currentUser && currentUser.uid === data.userId;

            // Pulsante like (SEMPRE visibile per tutti)
            const likesCount = data.likes || 0;
            const likeBtnClass = hasLike ? 'fame-card-btn fame-card-btn-like liked' : 'fame-card-btn fame-card-btn-like';
            const likeIcon = hasLike ? '‚ù§Ô∏è' : 'ü§ç';
            const likeBtnOnclick = currentUser ? `onclick="likePost('${postId}')"` : `onclick="showLoginModal()"`;

            // Pulsante segnala (solo se NON sei il proprietario)
            const flagBtnClass = hasFlag ? 'fame-card-btn-flag flagged' : 'fame-card-btn-flag';
            const flagBtnText = hasFlag ? 'üö© Segnalato' : 'üö© Segnala';
            const flagBtnDisabled = hasFlag ? 'disabled' : '';
            const flagBtnOnclick = hasFlag ? '' : `onclick="flagPost('${postId}')"`;

            // Costruisci i pulsanti actions
            let actionsHtml = '';

            // Pulsante Like (SEMPRE presente)
            const likeButtonHtml = `
                <button class="fame-card-btn ${likeBtnClass}" ${likeBtnOnclick}>
                    ${likeIcon} <span class="fame-card-likes-count">${likesCount}</span>
                </button>
            `;

            if (isOwner) {
                // Se sei il proprietario: Like + Elimina
                actionsHtml = `
                    ${likeButtonHtml}
                    <button class="fame-card-btn fame-card-btn-delete" onclick="deletePost('${postId}', '${data.imageUrl}')">
                        üóëÔ∏è Elimina
                    </button>
                `;
            } else {
                // Se NON sei il proprietario: Like + Segnala
                actionsHtml = `
                    ${likeButtonHtml}
                    <button class="fame-card-btn ${flagBtnClass}" ${flagBtnDisabled} ${flagBtnOnclick}>
                        ${flagBtnText}
                    </button>
                `;
            }

            html += `
                <div class="fame-card">
                    <img src="${data.imageUrl}" alt="Sfida" class="fame-card-image" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Ctext y=%22.9em%22 font-size=%2290%22%3Eüì∏%3C/text%3E%3C/svg%3E'">
                    <div class="fame-card-content">
                        <div class="fame-card-challenge">üì∏ ${data.sfidaTitolo}</div>
                        <div class="fame-card-comment">"${data.aiCommento}"</div>
                        <div class="fame-card-meta">
                            <span class="fame-card-user">${avatarHtml}${displayName}</span>
                            <span>üìÖ ${dateStr}</span>
                        </div>
                        <div class="fame-card-actions">
                            ${actionsHtml}
                        </div>

                        <!-- SEZIONE COMMENTI -->
                        <div class="comments-section">
                            <div class="comments-title">üí¨ Commenti</div>
                            <div class="comments-list" id="comments-${postId}">
                                <div class="comments-empty">Nessun commento ancora</div>
                            </div>

                            <!-- Bottone per aprire il form commenti -->
                            <button class="comment-open-btn" id="comment-open-${postId}" onclick="console.log('üî¥ CLICK BOTTONE COMMENTA!', '${postId}'); toggleCommentForm('${postId}')">üí¨ Commenta la sfida!</button>

                            <!-- Form commenti (nascosto di default) -->
                            <div class="comment-form" id="comment-form-${postId}" style="display: none;"><input type="text" class="comment-input" id="comment-input-${postId}" placeholder="Scrivi un commento..." maxlength="500"><button class="comment-submit" onclick="handleCommentSubmit('${postId}')">Invia</button><button class="comment-cancel" onclick="toggleCommentForm('${postId}')">Annulla</button></div>
                        </div>
                    </div>
                </div>
            `;
        }

        html += '</div>';
        area.innerHTML = html;

        // Carica i commenti per ogni post
        for (const doc of snapshot.docs) {
            loadComments(doc.id);
        }

    } catch (error) {
        console.error('Errore caricamento Sala della Fama:', error);
        area.innerHTML = `
            <div class="fame-empty">
                <div class="fame-empty-icon">‚ö†Ô∏è</div>
                <h3>Errore di caricamento</h3>
                <p>${error.message}</p>
            </div>
        `;
    }
}

// ==================== AUTENTICAZIONE - Funzioni ====================

/**
 * Aggiorna l'UI del badge utente in base allo stato di autenticazione
 */
function updateAuthUI(user) {
    const authBadge = document.getElementById('authBadge');
    const authAvatar = document.getElementById('authAvatar');
    const authName = document.getElementById('authName');

    if (user) {
        // Utente autenticato - mostra badge
        authBadge.style.display = 'flex';

        if (user.isAnonymous) {
            authAvatar.src = 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Ctext y=%22.9em%22 font-size=%2290%22%3Eüë§%3C/text%3E%3C/svg%3E';
            authName.textContent = 'Ospite';
        } else {
            authAvatar.src = user.photoURL || 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Ctext y=%22.9em%22 font-size=%2290%22%3Eüë§%3C/text%3E%3C/svg%3E';
            authName.textContent = user.displayName || user.email || 'Utente';
        }
    } else {
        // Utente non autenticato - nascondi badge
        authBadge.style.display = 'none';
    }
}

/**
 * Mostra il modale di login
 */
function showLoginModal() {
    const modal = document.getElementById('loginModal');
    modal.classList.add('active');
}

/**
 * Chiude il modale di login
 */
function closeLoginModal() {
    const modal = document.getElementById('loginModal');
    modal.classList.remove('active');
}

/**
 * Login con Google
 */
async function loginWithGoogle() {
    if (!auth) {
        alert('‚ö†Ô∏è Firebase Auth non configurato');
        return;
    }

    try {
        const provider = new firebase.auth.GoogleAuthProvider();
        provider.addScope('profile');
        provider.addScope('email');

        const result = await auth.signInWithPopup(provider);
        const user = result.user;

        console.log('‚úÖ Login Google riuscito:', user.displayName);
        showIndicator('‚úÖ Login effettuato!');
        closeLoginModal();

    } catch (error) {
        console.error('‚ùå Errore login Google:', error);

        if (error.code === 'auth/popup-closed-by-user') {
            showIndicator('‚ö†Ô∏è Login annullato');
        } else if (error.code === 'auth/popup-blocked') {
            alert('‚ö†Ô∏è Il popup di login √® stato bloccato. Abilita i popup per questo sito.');
        } else {
            alert(`‚ö†Ô∏è Errore durante il login: ${error.message}`);
        }
    }
}

/**
 * Login anonimo
 */
async function loginAnonymously() {
    if (!auth) {
        alert('‚ö†Ô∏è Firebase Auth non configurato');
        return;
    }

    try {
        const result = await auth.signInAnonymously();
        console.log('‚úÖ Login anonimo riuscito:', result.user.uid);
        showIndicator('‚úÖ Accesso come ospite!');
        closeLoginModal();

    } catch (error) {
        console.error('‚ùå Errore login anonimo:', error);
        alert(`‚ö†Ô∏è Errore durante il login: ${error.message}`);
    }
}

// ==================== SMART WALL FUNCTIONS ====================

/**
 * Mostra il modale Smart Wall (richiesta upgrade a Google)
 */
function showSmartWallModal() {
    const modal = document.getElementById('smartWallModal');
    modal.classList.add('active');
    console.log('üîí Smart Wall: Richiesto upgrade a Google Account');
}

/**
 * Chiude il modale Smart Wall
 */
function closeSmartWallModal() {
    const modal = document.getElementById('smartWallModal');
    modal.classList.remove('active');
}

/**
 * Upgrade da account anonimo a Google Account con linkWithPopup
 * Mantiene la cronologia dell'utente (quiz, punteggi, etc.)
 */
async function upgradeToGoogleAccount() {
    if (!auth || !currentUser || !currentUser.isAnonymous) {
        console.warn('upgradeToGoogleAccount chiamato in uno stato non valido.');
        closeSmartWallModal();
        return;
    }

    const provider = new firebase.auth.GoogleAuthProvider();
    provider.addScope('profile');
    provider.addScope('email');
    // Forza la selezione dell'account ogni volta (permette cambio utente)
    provider.setCustomParameters({
        prompt: 'select_account'
    });

    // Salva l'utente anonimo attuale
    const anonymousUser = auth.currentUser;

    try {
        // ========================================================
        // 1. TENTA IL COLLEGAMENTO (FLUSSO PER NUOVI UTENTI)
        // Questo √® il flusso corretto per un nuovo utente.
        // L'utente anonimo viene "trasformato" nell'utente Google.
        // ========================================================

        await anonymousUser.linkWithPopup(provider);

        // SUCCESSO (Nuovo Utente)
        console.log('‚úÖ Account collegato con successo! (Nuovo Utente)');
        showIndicator('üéâ Benvenuto tra gli Audaci!');
        closeSmartWallModal();

    } catch (error) {
        console.error('‚ùå Errore durante il linkWithPopup:', error.code, error.message);

        // ========================================================
        // 2. GESTIONE FALLIMENTO (FLUSSO PER UTENTI ESISTENTI)
        // Questo blocco scatta se l'account Google esiste gi√†.
        // ========================================================
        if (error.code === 'auth/provider-already-linked' || error.code === 'auth/credential-already-in-use') {

            console.warn('‚ö†Ô∏è Account Google gi√† in uso. Eseguo il merge (signIn)...');

            // Prendi le credenziali dall'errore
            const credential = error.credential;

            if (credential) {
                try {
                    // Accedi direttamente con l'account Google esistente.
                    // L'account anonimo (anonymousUser) verr√† abbandonato.
                    await auth.signInWithCredential(credential);

                    console.log('‚úÖ Merge riuscito. Accesso effettuato.');
                    showIndicator('‚úÖ Bentornato!'); // <-- Messaggio corretto per il merge

                } catch (mergeError) {
                    console.error('‚ùå Errore critico durante il merge/signIn:', mergeError);
                    alert(`‚ö†Ô∏è Errore critico: ${mergeError.message}`);
                }
            } else {
                alert('‚ö†Ô∏è Questo account Google √® gi√† registrato. Prova ad accedere normalmente.');
            }

        // GESTIONE ALTRI ERRORI (Popup chiuso, bloccato, ecc.)
        } else {
            if (error.code === 'auth/popup-closed-by-user' || error.code === 'auth/cancelled-popup-request') {
                showIndicator('‚ö†Ô∏è Operazione annullata');
            } else if (error.code === 'auth/popup-blocked') {
                alert('‚ö†Ô∏è Il popup √® stato bloccato. Abilita i popup per questo sito.');
            } else {
                alert(`‚ö†Ô∏è Errore durante il collegamento: ${error.message}`);
            }
        }

        // Chiudi il modale in TUTTI i casi di errore
        closeSmartWallModal();
    }
}

/**
 * Logout utente
 */
async function logoutUser() {
    if (!auth) return;

    // Determina il messaggio in base al tipo di utente
    const isGoogleUser = currentUser && !currentUser.isAnonymous;
    const message = isGoogleUser
        ? 'Vuoi uscire dal tuo account Google?\n\n(Tornerai come Visitatore Anonimo)'
        : 'Vuoi davvero uscire?';

    const confirmLogout = confirm(message);
    if (!confirmLogout) return;

    try {
        // Imposta flag PRIMA del signOut per gestire correttamente onAuthStateChanged
        isManualLogout = true;

        await auth.signOut();
        console.log('‚úÖ Logout effettuato');
        showIndicator('üëã Logout effettuato');

        // Torna al menu principale
        backToMenu();

    } catch (error) {
        console.error('‚ùå Errore logout:', error);
        alert(`‚ö†Ô∏è Errore durante il logout: ${error.message}`);
        isManualLogout = false; // Reset flag in caso di errore
    }
}

/**
 * Controlla se l'utente √® autenticato prima di un'azione
 * Se non lo √®, mostra il modale di login
 */
function requireAuth(callback) {
    if (!currentUser) {
        showLoginModal();
        return false;
    }
    if (callback) callback();
    return true;
}

// ==================== MODERAZIONE - Flag/Segnalazioni ====================

/**
 * Segnala una pubblicazione inappropriata
 * @param {string} postId - ID della pubblicazione da segnalare
 */
async function flagPost(postId) {
    // Verifica autenticazione
    if (!currentUser) {
        showLoginModal();
        return;
    }

    if (!db) {
        alert('‚ö†Ô∏è Firebase non configurato');
        return;
    }

    const confirmFlag = confirm('Vuoi davvero segnalare questa pubblicazione come inappropriata?\n\nLe segnalazioni vengono revisionate e le pubblicazioni con troppe segnalazioni vengono automaticamente nascoste.');
    if (!confirmFlag) return;

    try {
        showIndicator('üö© Segnalazione in corso...');

        const postRef = db.collection('pubblicazioni').doc(postId);

        // 1. Verifica se l'utente ha gi√† segnalato (double-check)
        const flagDoc = await postRef.collection('flags').doc(currentUser.uid).get();
        if (flagDoc.exists) {
            showIndicator('‚ö†Ô∏è Hai gi√† segnalato questo post');
            return;
        }

        // 2. Salva il flag nella subcollection
        await postRef.collection('flags').doc(currentUser.uid).set({
            userId: currentUser.uid,
            userDisplayName: currentUser.displayName || 'Anonimo',
            flaggedAt: firebase.firestore.FieldValue.serverTimestamp(),
            reason: 'user_reported'
        });

        // 3. Incrementa il contatore di flags sul documento principale
        await postRef.update({
            flags: firebase.firestore.FieldValue.increment(1)
        });

        showIndicator('‚úÖ Segnalazione inviata');

        // 4. Ricarica la Sala della Fama per aggiornare la UI
        setTimeout(() => {
            loadHallOfFame();
        }, 1000);

    } catch (error) {
        console.error('‚ùå Errore segnalazione:', error);
        alert(`‚ö†Ô∏è Errore durante la segnalazione: ${error.message}`);
    }
}

/**
 * Elimina una pubblicazione dalla Sala della Fama
 * @param {string} postId - ID del documento Firestore
 * @param {string} imageUrl - URL dell'immagine su Storage
 */
async function deletePost(postId, imageUrl) {
    // Verifica autenticazione
    if (!currentUser) {
        showLoginModal();
        return;
    }

    if (!db || !storage) {
        alert('‚ö†Ô∏è Firebase non configurato');
        return;
    }

    const confirmDelete = confirm('Vuoi davvero eliminare questa pubblicazione?\n\nQuesta azione √® irreversibile!');
    if (!confirmDelete) return;

    try {
        showIndicator('üóëÔ∏è Eliminazione in corso...');

        // 1. Elimina l'immagine da Firebase Storage
        try {
            const storageRef = storage.refFromURL(imageUrl);
            await storageRef.delete();
            console.log('‚úÖ Immagine eliminata da Storage');
        } catch (storageError) {
            console.warn('‚ö†Ô∏è Errore eliminazione Storage (forse gi√† cancellata):', storageError);
            // Continua comunque con l'eliminazione del documento
        }

        // 2. Elimina il documento da Firestore
        await db.collection('pubblicazioni').doc(postId).delete();
        console.log('‚úÖ Documento eliminato da Firestore');

        showIndicator('‚úÖ Pubblicazione eliminata!');

        // 3. Ricarica la Sala della Fama
        setTimeout(() => {
            loadHallOfFame();
        }, 1000);

    } catch (error) {
        console.error('‚ùå Errore eliminazione:', error);
        alert(`‚ö†Ô∏è Errore durante l'eliminazione: ${error.message}`);
    }
}

/**
 * Carica una sfida random dalla Sala della Fama per la home
 */
async function loadFeaturedChallenge() {
    const card = document.getElementById('featuredChallengeCard');
    const image = document.getElementById('featuredChallengeImage');
    const name = document.getElementById('featuredChallengeName');
    const comment = document.getElementById('featuredChallengeComment');

    // Nascondi la card se Firebase non √® configurato
    if (!db) {
        card.style.display = 'none';
        return;
    }

    try {
        // Carica 1 pubblicazione random tra le ultime 20
        const snapshot = await db.collection('pubblicazioni')
            .where('flags', '<', 3)
            .orderBy('flags', 'asc')
            .orderBy('timestamp', 'desc')
            .limit(20)
            .get();

        if (snapshot.empty) {
            card.style.display = 'none';
            return;
        }

        // Seleziona una pubblicazione random
        const docs = snapshot.docs;
        const randomDoc = docs[Math.floor(Math.random() * docs.length)];
        const data = randomDoc.data();

        // Popola la card
        image.src = data.imageUrl;
        image.onerror = function() {
            card.style.display = 'none';
        };
        name.textContent = `üì∏ ${data.sfidaTitolo}`;
        comment.textContent = `"${data.aiCommento}"`;

        // Mostra la card
        card.style.display = 'block';

        console.log('‚úÖ Sfida in evidenza caricata:', data.sfidaTitolo);

    } catch (error) {
        console.error('‚ùå Errore caricamento sfida in evidenza:', error);
        card.style.display = 'none';
    }
}

/**
 * Gestisce il like/unlike di una pubblicazione
 * @param {string} postId - ID del documento Firestore
 */
async function likePost(postId) {
    // Verifica autenticazione
    if (!currentUser) {
        showLoginModal();
        return;
    }

    // üîí SMART WALL: Verifica se utente √® anonimo
    if (currentUser.isAnonymous) {
        showSmartWallModal();
        return;
    }

    if (!db) {
        alert('‚ö†Ô∏è Firebase non configurato');
        return;
    }

    try {
        showIndicator('‚ù§Ô∏è Elaborazione...');

        const postRef = db.collection('pubblicazioni').doc(postId);
        const likeRef = postRef.collection('likes').doc(currentUser.uid);

        // Verifica se l'utente ha gi√† likato
        const likeDoc = await likeRef.get();

        if (likeDoc.exists) {
            // UNLIKE: Rimuovi like dalla subcollection
            // Il contatore verr√† aggiornato automaticamente dalla Cloud Function
            await likeRef.delete();

            console.log('üíî Like rimosso da post:', postId);
            showIndicator('üíî Like rimosso');

        } else {
            // LIKE: Aggiungi like alla subcollection
            // Il contatore verr√† aggiornato automaticamente dalla Cloud Function
            await likeRef.set({
                userId: currentUser.uid,
                userDisplayName: currentUser.displayName || 'Anonimo',
                likedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            console.log('‚ù§Ô∏è Like aggiunto a post:', postId);
            showIndicator('‚ù§Ô∏è Like aggiunto!');
        }

        // Ricarica la Sala della Fama per aggiornare l'UI
        // Aspetta un po' di pi√π per dare tempo alla Cloud Function di aggiornare il contatore
        setTimeout(() => {
            loadHallOfFame();
        }, 1500);

    } catch (error) {
        console.error('‚ùå Errore like/unlike:', error);
        alert(`‚ö†Ô∏è Errore durante l'operazione: ${error.message}`);
    }
}

// ==================== SISTEMA COMMENTI ====================

/**
 * Mostra/nasconde il form commenti
 * @param {string} postId - ID del post
 */
function toggleCommentForm(postId) {
    console.log('üîµ toggleCommentForm chiamata per postId:', postId);

    // Controlla autenticazione prima di aprire il form
    if (!currentUser || currentUser.isAnonymous) {
        console.log('‚ö†Ô∏è Utente non autenticato, mostro Smart Wall');
        showSmartWallModal();
        return;
    }

    const form = document.getElementById(`comment-form-${postId}`);
    const button = document.getElementById(`comment-open-${postId}`);
    const input = document.getElementById(`comment-input-${postId}`);

    console.log('üìã Elementi trovati:', {form: !!form, button: !!button, input: !!input});

    if (!form || !button) {
        console.log('‚ùå Form o button non trovati!');
        return;
    }

    // Toggle visibilit√† - usa getComputedStyle per essere sicuro
    const isHidden = form.style.display === 'none' || form.style.display === '';

    console.log('üëÅÔ∏è Form nascosto?', isHidden, 'display attuale:', form.style.display);

    if (isHidden) {
        // Apri il form
        console.log('‚úÖ Apro il form');
        form.style.display = 'flex';
        button.style.display = 'none';
        // Focus sull'input
        if (input) {
            setTimeout(() => {
                input.focus();
                console.log('üéØ Focus su input');
            }, 100);
        }
    } else {
        // Chiudi il form
        console.log('‚ùå Chiudo il form');
        form.style.display = 'none';
        button.style.display = 'block';
        // Pulisci l'input
        if (input) {
            input.value = '';
        }
    }
}

/**
 * Carica e mostra i commenti per un post
 * @param {string} postId - ID del post
 */
async function loadComments(postId) {
    const commentsContainer = document.getElementById(`comments-${postId}`);

    if (!commentsContainer || !db) {
        return;
    }

    try {
        // Carica commenti dalla subcollection, ordinati per timestamp
        const snapshot = await db.collection('pubblicazioni')
            .doc(postId)
            .collection('comments')
            .where('isHidden', '==', false)
            .orderBy('timestamp', 'asc')
            .limit(50)
            .get();

        if (snapshot.empty) {
            commentsContainer.innerHTML = '<div class="comments-empty">Nessun commento ancora</div>';
            return;
        }

        // Costruisci HTML dei commenti
        let html = '';
        snapshot.forEach(doc => {
            const comment = doc.data();

            // Formatta timestamp
            let timeStr = 'Ora';
            if (comment.timestamp) {
                const date = comment.timestamp.toDate();
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);

                if (diffMins < 1) {
                    timeStr = 'Adesso';
                } else if (diffMins < 60) {
                    timeStr = `${diffMins}m fa`;
                } else if (diffHours < 24) {
                    timeStr = `${diffHours}h fa`;
                } else if (diffDays < 7) {
                    timeStr = `${diffDays}g fa`;
                } else {
                    timeStr = date.toLocaleDateString('it-IT', { day: 'numeric', month: 'short' });
                }
            }

            // Avatar dell'utente
            const avatarHtml = comment.userImage
                ? `<img src="${comment.userImage}" class="comment-user-avatar" onerror="this.style.display='none'">`
                : '<div class="comment-user-avatar" style="background: #667eea; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.7em;">üë§</div>';

            // Verifica permessi eliminazione (autore O moderatore)
            const MODERATOR_UID = 'a3n2RtORHYc2olmdVmmPE7zDqt42'; // Stesso UID della Cloud Function
            const canDelete = currentUser && (
                currentUser.uid === comment.userId ||  // Autore
                currentUser.uid === MODERATOR_UID       // Moderatore
            );

            const deleteButtonHtml = canDelete ? `
                <button class="comment-delete-btn" onclick="handleCommentDelete('${postId}', '${doc.id}')">
                    üóëÔ∏è
                </button>
            ` : '';

            html += `
                <div class="comment-item">
                    <div class="comment-header">
                        ${avatarHtml}
                        <span class="comment-user-name">${comment.userName || 'Utente'}</span>
                        <span class="comment-timestamp">${timeStr}</span>
                        ${deleteButtonHtml}
                    </div>
                    <div class="comment-body">${comment.text}</div>
                </div>
            `;
        });

        commentsContainer.innerHTML = html;

    } catch (error) {
        console.error('‚ùå Errore caricamento commenti:', error);
        commentsContainer.innerHTML = '<div class="comments-empty">Errore caricamento commenti</div>';
    }
}

/**
 * Gestisce l'invio di un nuovo commento
 * @param {string} postId - ID del post
 */
async function handleCommentSubmit(postId) {
    // Verifica autenticazione
    if (!currentUser || currentUser.isAnonymous) {
        showSmartWallModal();
        return;
    }

    const inputElement = document.getElementById(`comment-input-${postId}`);

    if (!inputElement) {
        return;
    }

    const text = inputElement.value.trim();

    // Validazione input
    if (!text) {
        alert('‚ö†Ô∏è Scrivi un commento prima di inviare!');
        return;
    }

    if (text.length > 500) {
        alert('‚ö†Ô∏è Il commento √® troppo lungo (max 500 caratteri).');
        return;
    }

    try {
        // Disabilita input durante l'invio
        inputElement.disabled = true;
        showIndicator('üí¨ Invio commento...');

        // Chiama la Cloud Function postComment
        const postCommentFunction = firebase.functions().httpsCallable('postComment');
        const result = await postCommentFunction({
            pubId: postId,
            text: text
        });

        if (result.data.success) {
            console.log('‚úÖ Commento postato con successo');
            showIndicator('‚úÖ Commento pubblicato!');

            // Pulisci input
            inputElement.value = '';

            // Chiudi il form commenti
            const form = document.getElementById(`comment-form-${postId}`);
            const button = document.getElementById(`comment-open-${postId}`);
            if (form && button) {
                form.style.display = 'none';
                button.style.display = 'block';
            }

            // Ricarica i commenti
            setTimeout(() => {
                loadComments(postId);
            }, 500);

        } else {
            throw new Error('Risposta non valida dalla Cloud Function');
        }

    } catch (error) {
        console.error('‚ùå Errore invio commento:', error);

        // Gestisci errori specifici
        if (error.code === 'unauthenticated') {
            alert('‚ö†Ô∏è Devi essere autenticato per commentare.');
            showLoginModal();
        } else if (error.code === 'permission-denied') {
            alert('‚ö†Ô∏è Gli utenti anonimi non possono commentare. Accedi con Google!');
            showSmartWallModal();
        } else if (error.message && error.message.includes('linee guida')) {
            alert('‚ö†Ô∏è Il tuo commento viola le linee guida della community. Riprova con un contenuto pi√π appropriato.');
        } else {
            alert(`‚ö†Ô∏è Errore durante l'invio del commento: ${error.message || 'Riprova pi√π tardi.'}`);
        }

    } finally {
        // Riabilita input
        inputElement.disabled = false;
    }
}

/**
 * Gestisce l'eliminazione di un commento
 * @param {string} postId - ID del post
 * @param {string} commentId - ID del commento da eliminare
 */
async function handleCommentDelete(postId, commentId) {
    // Conferma prima di eliminare
    if (!confirm('Vuoi davvero eliminare questo commento?')) {
        return;
    }

    // Verifica autenticazione
    if (!currentUser) {
        alert('‚ö†Ô∏è Devi essere autenticato per eliminare commenti.');
        return;
    }

    try {
        showIndicator('üóëÔ∏è Eliminazione commento...');

        // Chiama la Cloud Function deleteComment
        const deleteCommentFunction = firebase.functions().httpsCallable('deleteComment');
        const result = await deleteCommentFunction({
            pubId: postId,
            commentId: commentId
        });

        if (result.data.success) {
            console.log('‚úÖ Commento eliminato con successo');
            showIndicator('‚úÖ Commento eliminato!');

            // Ricarica i commenti
            setTimeout(() => {
                loadComments(postId);
            }, 500);

        } else {
            throw new Error('Risposta non valida dalla Cloud Function');
        }

    } catch (error) {
        console.error('‚ùå Errore eliminazione commento:', error);

        // Gestisci errori specifici
        if (error.code === 'permission-denied') {
            alert('‚ö†Ô∏è Non hai i permessi per eliminare questo commento.');
        } else if (error.code === 'not-found') {
            alert('‚ö†Ô∏è Commento non trovato.');
        } else {
            alert(`‚ö†Ô∏è Errore durante l'eliminazione: ${error.message || 'Riprova pi√π tardi.'}`);
        }
    }
}

// ==================== COMPRESSIONE IMMAGINI ====================

/**
 * Comprime un'immagine mantenendo qualit√† e riducendo dimensioni
 * @param {string} base64Image - Immagine in formato base64
 * @param {number} maxWidth - Larghezza massima (default: 800px)
 * @param {number} quality - Qualit√† JPEG 0-1 (default: 0.8)
 * @returns {Promise<Blob>} - Blob dell'immagine compressa
 */
async function compressImage(base64Image, maxWidth = 800, quality = 0.8) {
    return new Promise((resolve, reject) => {
        const img = new Image();

        img.onload = function() {
            // Calcola nuove dimensioni mantenendo aspect ratio
            let width = img.width;
            let height = img.height;

            if (width > maxWidth) {
                height = (height * maxWidth) / width;
                width = maxWidth;
            }

            // Crea canvas per ridimensionamento
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;

            const ctx = canvas.getContext('2d');

            // Disegna l'immagine ridimensionata
            ctx.drawImage(img, 0, 0, width, height);

            // Converti in blob con compressione
            canvas.toBlob(
                (blob) => {
                    if (blob) {
                        console.log(`üì¶ Compressione: ${(img.width * img.height / 1000).toFixed(0)}KB ‚Üí ${(blob.size / 1024).toFixed(0)}KB (${width}x${height}px)`);
                        resolve(blob);
                    } else {
                        reject(new Error('Errore nella compressione'));
                    }
                },
                'image/jpeg',
                quality
            );
        };

        img.onerror = function() {
            reject(new Error('Errore nel caricamento immagine'));
        };

        img.src = base64Image;
    });
}

console.log('‚úÖ BontempApp v3.1 ENHANCED EDITION - Pronto! üé•üéµ‚è±Ô∏èüìπüéπ');
</script>
</body>
</html>